<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FlowPOS ¬∑ Restaurante</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Lato:ital,wght@0,300;0,400;0,700;0,900;1,400&family=Syne:wght@700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:         #E4EEF6;
      --surface:    #EEF5FB;
      --white:      #F6FAFD;
      --blue:       #4A7FA7;
      --blue-mid:   #1A3D63;
      --blue-light: #B3CFE5;
      --blue-xl:    #DCF0FA;
      --navy:       #0A1931;
      --dark:       #0A1931;
      --mid:        #1A3D63;
      --muted:      #6B9AB8;
      --border:     #B3CFE5;
      --amber:      #D97706;
      --amber-dim:  #FFF7ED;
      --amber-mid:  #F59E0B;
      --green:      #10B981;
      --green-dim:  #ECFDF5;
      --red:        #EF4444;
      --red-dim:    #FEF2F2;
      --orange:     #F59E0B;
      --orange-dim: #FFFBEB;
      --shadow-sm:  0 1px 4px rgba(10,25,49,0.07), 0 2px 10px rgba(10,25,49,0.05);
      --shadow-md:  0 4px 16px rgba(10,25,49,0.10), 0 1px 4px rgba(10,25,49,0.06);
      --shadow-lg:  0 20px 60px rgba(10,25,49,0.18), 0 4px 16px rgba(10,25,49,0.09);
      --r:          16px;
    }

    body {
      font-family: 'Lato', sans-serif;
      background: var(--bg);
      color: var(--dark);
      min-height: 100vh;
    }

    /* ‚ïê‚ïê HEADER ‚ïê‚ïê */
    .header {
      position: fixed; top: 0; left: 0; right: 0; z-index: 60;
      height: 60px;
      background: linear-gradient(135deg, #0A1931 0%, #1A3D63 100%);
      display: flex; align-items: center;
      padding: 0 20px; gap: 16px;
      box-shadow: 0 2px 20px rgba(10,25,49,0.45);
    }
    .logo { display: flex; align-items: center; gap: 9px; flex-shrink: 0; }
    .logo-mark {
      width: 34px; height: 34px;
      background: linear-gradient(135deg, var(--amber), #B45309);
      border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
      font-size: 17px;
      box-shadow: 0 3px 12px rgba(217,119,6,0.4);
    }
    .logo-name {
      font-family: 'Syne', sans-serif;
      font-size: 20px; font-weight: 800; color: white; letter-spacing: 0.2px;
    }
    .logo-name em { font-style: normal; color: var(--amber); }
    .logo-badge {
      background: rgba(217,119,6,0.2);
      border: 1px solid rgba(217,119,6,0.35);
      color: #FCD34D;
      font-size: 10px; font-weight: 700;
      padding: 2px 7px; border-radius: 20px;
      letter-spacing: 0.5px;
    }

    .nav-tabs { display: flex; gap: 4px; flex: 1; }
    .nav-tab {
      display: flex; align-items: center; gap: 7px;
      padding: 8px 16px; border-radius: 10px;
      background: transparent; border: none;
      font-family: 'Lato', sans-serif; font-size: 13px; font-weight: 600;
      color: rgba(255,255,255,0.55); cursor: pointer;
      transition: all 0.18s; white-space: nowrap;
    }
    .nav-tab:hover { background: rgba(255,255,255,0.07); color: rgba(255,255,255,0.9); }
    .nav-tab.active { background: rgba(217,119,6,0.18); color: #FCD34D; box-shadow: inset 0 0 0 1px rgba(217,119,6,0.3); }

    .header-right { display: flex; align-items: center; gap: 10px; margin-left: auto; }
    .user-pill {
      display: flex; align-items: center; gap: 7px;
      background: rgba(255,255,255,0.07);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 20px;
      padding: 5px 12px 5px 6px;
    }
    .user-avatar {
      width: 24px; height: 24px;
      background: var(--amber);
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 12px; font-weight: 700; color: white;
    }
    .user-name { font-size: 12px; font-weight: 600; color: rgba(255,255,255,0.8); }
    .btn-logout {
      background: rgba(239,68,68,0.15);
      border: 1px solid rgba(239,68,68,0.25);
      color: #FCA5A5; border-radius: 8px;
      padding: 6px 12px; font-size: 12px; font-weight: 700;
      cursor: pointer; transition: all 0.18s;
      font-family: 'Lato', sans-serif;
    }
    .btn-logout:hover { background: rgba(239,68,68,0.25); }

    /* ‚ïê‚ïê MAIN ‚ïê‚ïê */
    .main { padding-top: 60px; min-height: 100vh; }
    .view { display: none; padding: 24px; }
    .view.active { display: block; animation: viewIn 0.2s ease; }
    #view-mesas.active { display: flex; padding: 0; height: calc(100vh - 60px); }
    @keyframes viewIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }

    .view-header {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 20px;
    }
    .view-header h2 { font-size: 22px; font-weight: 900; color: var(--dark); }

    /* ‚ïê‚ïê BUTTONS ‚ïê‚ïê */
    .btn-primary {
      background: linear-gradient(135deg, var(--blue-mid), var(--blue));
      color: white; border: none; border-radius: 10px;
      padding: 10px 20px; font-family: 'Lato', sans-serif;
      font-size: 14px; font-weight: 700; cursor: pointer;
      transition: all 0.18s; box-shadow: var(--shadow-sm);
    }
    .btn-primary:hover { transform: translateY(-1px); box-shadow: var(--shadow-md); }
    .btn-secondary {
      background: var(--white); color: var(--dark);
      border: 1px solid var(--border); border-radius: 10px;
      padding: 10px 18px; font-family: 'Lato', sans-serif;
      font-size: 14px; font-weight: 700; cursor: pointer;
      transition: all 0.18s;
    }
    .btn-secondary:hover { background: var(--surface); }
    .btn-amber {
      background: linear-gradient(135deg, #B45309, var(--amber));
      color: white; border: none; border-radius: 10px;
      padding: 10px 20px; font-family: 'Lato', sans-serif;
      font-size: 14px; font-weight: 700; cursor: pointer;
      transition: all 0.18s; box-shadow: 0 4px 14px rgba(217,119,6,0.3);
    }
    .btn-amber:hover { transform: translateY(-1px); }
    .btn-green {
      background: linear-gradient(135deg, #059669, var(--green));
      color: white; border: none; border-radius: 10px;
      padding: 10px 20px; font-family: 'Lato', sans-serif;
      font-size: 14px; font-weight: 700; cursor: pointer;
      transition: all 0.18s;
    }
    .btn-green:hover { transform: translateY(-1px); }
    .btn-danger {
      background: var(--red); color: white; border: none; border-radius: 10px;
      padding: 10px 18px; font-family: 'Lato', sans-serif;
      font-size: 14px; font-weight: 700; cursor: pointer;
    }
    .btn-block { width: 100%; }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       MESAS FLOOR PLAN ‚Äî Clean & Simple
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    #view-mesas { padding: 0 !important; display: flex !important; flex-direction: column; }

    .floor-toolbar {
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 20px; height: 46px; flex-shrink: 0;
      background: #fff; border-bottom: 1px solid #E8ECF0; gap: 12px;
    }
    .floor-legend { display: flex; gap: 16px; align-items: center; }
    .legend-item  { display: flex; align-items: center; gap: 6px; font-size: 11px; font-weight: 700; color: #8A9BB0; }
    .legend-pip   { width: 10px; height: 10px; border-radius: 50%; }
    .legend-pip.libre   { background: #C4CAD6; }
    .legend-pip.ocupada { background: var(--amber); }
    .floor-toolbar-right { display: flex; align-items: center; gap: 8px; }
    .btn-edit-mode {
      background: #F4F6F9; border: 1px solid #DDE2EA;
      color: #6B7A8D; border-radius: 8px;
      padding: 6px 13px; font-family: 'Lato', sans-serif;
      font-size: 12px; font-weight: 700; cursor: pointer; transition: all 0.15s;
    }
    .btn-edit-mode:hover  { background: #E8ECF2; color: #3A4A5C; }
    .btn-edit-mode.active { background: #FFF7ED; border-color: #F59E0B; color: #B45309; }
    .btn-floor-add {
      background: var(--navy); color: white; border: none; border-radius: 8px;
      padding: 7px 15px; font-family: 'Lato', sans-serif;
      font-size: 13px; font-weight: 700; cursor: pointer; transition: all 0.15s;
    }
    .btn-floor-add:hover { background: var(--mid); }

    /* Canvas ‚Äî light, clean */
    .mesas-canvas {
      flex: 1; position: relative; overflow: hidden;
      background: #F2F4F7;
    }
    .mesas-canvas.edit-mode {
      background-image:
        linear-gradient(#E4E8EE 1px, transparent 1px),
        linear-gradient(90deg, #E4E8EE 1px, transparent 1px);
      background-size: 48px 48px;
    }
    .floor-plant {
      position: absolute; font-size: 32px; pointer-events: none;
      opacity: 0.55; user-select: none; z-index: 1;
    }
    .floor-empty {
      position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%);
      text-align: center; color: #B0BBCA; font-size: 14px; z-index: 1;
    }
    .floor-edit-hint {
      position: absolute; bottom: 14px; left: 50%; transform: translateX(-50%);
      background: #FFF7ED; border: 1px solid #F59E0B;
      color: #B45309; font-size: 11px; font-weight: 700;
      padding: 6px 18px; border-radius: 20px; pointer-events: none;
      letter-spacing: 0.3px; z-index: 5; white-space: nowrap;
    }

    /* ‚îÄ‚îÄ Individual table ‚îÄ‚îÄ */
    .floor-mesa {
      position: absolute; display: flex; flex-direction: column;
      align-items: center; cursor: pointer; user-select: none;
      z-index: 2; touch-action: none;
    }
    .floor-mesa.is-dragging { z-index: 100; cursor: grabbing !important; opacity: 0.85; }
    .mesas-canvas.edit-mode .floor-mesa { cursor: grab; }

    /* Wrapper 88√ó88 */
    .mesa-wrap { position: relative; width: 88px; height: 88px; }

    /* ‚îÄ‚îÄ Chair bumps ‚Äî mismo color que la mesa, crean el silueta integrada ‚îÄ‚îÄ */
    .mesa-chair {
      position: absolute; width: 22px; height: 22px; border-radius: 50%;
      /* color se sobreescribe por estado */
      z-index: 1;
    }
    .mesa-chair.n { top:  0;   left: 33px; }
    .mesa-chair.e { top: 33px; right: 0; }
    .mesa-chair.s { bottom: 0; left: 33px; }
    .mesa-chair.w { top: 33px; left:  0; }

    /* ‚îÄ‚îÄ Table top circle ‚îÄ‚îÄ */
    .mesa-circle {
      position: absolute; top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      width: 58px; height: 58px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      z-index: 2; transition: transform 0.18s;
    }
    .floor-mesa:hover:not(.is-dragging) .mesa-circle { transform: translate(-50%,-50%) scale(1.06); }

    /* Libre ‚Äî gris suave */
    .floor-mesa.libre .mesa-chair  { background: #BFC6D1; }
    .floor-mesa.libre .mesa-circle {
      background: #C8CFD9;
      box-shadow: 0 2px 8px rgba(0,0,0,0.12);
    }
    .floor-mesa.libre:hover .mesa-circle  { background: #B8C0CC; }

    /* Ocupada ‚Äî amber */
    .floor-mesa.ocupada .mesa-chair  { background: #F59E0B; }
    .floor-mesa.ocupada .mesa-circle {
      background: #D97706;
      box-shadow: 0 2px 10px rgba(217,119,6,0.35);
    }
    .floor-mesa.ocupada:hover .mesa-circle { background: #B45309; }

    .mesa-floor-num {
      font-family: 'Syne', sans-serif;
      font-size: 20px; font-weight: 800; line-height: 1;
    }
    .floor-mesa.libre   .mesa-floor-num { color: #4A5568; }
    .floor-mesa.ocupada .mesa-floor-num { color: #fff; }

    .mesa-floor-label {
      margin-top: 8px; font-size: 9px; font-weight: 700;
      letter-spacing: 0.4px; text-align: center;
      white-space: nowrap; color: #8A9BB0;
    }
    .floor-mesa.ocupada .mesa-floor-label { color: #D97706; }

    /* Delete btn ‚Äî edit mode only */
    .mesa-floor-del {
      position: absolute; top: -2px; right: -2px;
      width: 20px; height: 20px; border-radius: 50%;
      background: #EF4444; border: 2px solid #F2F4F7;
      color: white; font-size: 13px; line-height: 1; font-weight: 900;
      display: none; align-items: center; justify-content: center;
      cursor: pointer; z-index: 10;
    }
    .mesas-canvas.edit-mode .mesa-floor-del { display: flex; }

    /* ‚ïê‚ïê DOMICILIOS VIEW ‚ïê‚ïê */
    .domicilio-list { display: flex; flex-direction: column; gap: 12px; }
    .domicilio-card {
      background: var(--white);
      border: 1px solid var(--border);
      border-radius: var(--r);
      padding: 16px 20px;
      display: flex; align-items: center; gap: 16px;
      box-shadow: var(--shadow-sm);
    }
    .dom-icon {
      width: 42px; height: 42px;
      background: var(--amber-dim);
      border-radius: 12px;
      display: flex; align-items: center; justify-content: center;
      font-size: 20px; flex-shrink: 0;
    }
    .dom-info { flex: 1; min-width: 0; }
    .dom-nombre { font-size: 15px; font-weight: 700; color: var(--dark); }
    .dom-dir { font-size: 13px; color: var(--muted); margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .dom-total { font-size: 14px; font-weight: 700; color: var(--blue); margin-top: 3px; }
    .dom-status-sel {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 8px; padding: 6px 10px;
      font-family: 'Lato', sans-serif; font-size: 12px; font-weight: 700;
      color: var(--dark); cursor: pointer; outline: none;
    }

    /* ‚ïê‚ïê MEN√ö (INVENTARIO) ‚ïê‚ïê */
    .inv-toolbar {
      display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap;
    }
    .inv-search {
      flex: 1; min-width: 200px;
      background: var(--white); border: 1px solid var(--border);
      border-radius: 10px; padding: 10px 14px;
      font-family: 'Lato', sans-serif; font-size: 14px;
      color: var(--dark); outline: none;
    }
    .inv-search:focus { border-color: var(--blue); }
    .prod-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 12px;
    }
    .prod-card {
      background: var(--white); border: 1px solid var(--border);
      border-radius: var(--r); padding: 16px;
      box-shadow: var(--shadow-sm); cursor: pointer;
      transition: all 0.18s;
    }
    .prod-card:hover { border-color: var(--blue); box-shadow: var(--shadow-md); transform: translateY(-1px); }
    .prod-emoji { font-size: 28px; display: block; margin-bottom: 8px; }
    .prod-nombre { font-size: 14px; font-weight: 700; color: var(--dark); margin-bottom: 4px; }
    .prod-precio { font-size: 16px; font-weight: 900; color: var(--blue-mid); }
    .prod-stock  { font-size: 12px; color: var(--muted); margin-top: 4px; }
    .prod-actions { display: flex; gap: 6px; margin-top: 10px; }
    .prod-btn {
      flex: 1; padding: 6px; border-radius: 7px;
      font-family: 'Lato', sans-serif; font-size: 12px; font-weight: 700;
      cursor: pointer; border: none; transition: all 0.15s;
    }
    .prod-btn-edit { background: var(--blue-xl); color: var(--blue-mid); }
    .prod-btn-del  { background: var(--red-dim); color: var(--red); }

    /* ‚ïê‚ïê REPORTES ‚ïê‚ïê */
    .report-cards {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 14px; margin-bottom: 24px;
    }
    .report-card {
      background: var(--white); border: 1px solid var(--border);
      border-radius: var(--r); padding: 20px;
      box-shadow: var(--shadow-sm);
    }
    .report-card .rc-label { font-size: 12px; font-weight: 700; letter-spacing: 0.5px; text-transform: uppercase; color: var(--muted); margin-bottom: 8px; }
    .report-card .rc-value { font-size: 24px; font-weight: 900; color: var(--dark); }
    .report-card .rc-sub { font-size: 12px; color: var(--muted); margin-top: 3px; }

    /* ‚ïê‚ïê OVERLAYS / MODALS ‚ïê‚ïê */
    .overlay {
      position: fixed; inset: 0; z-index: 100;
      background: rgba(10,25,49,0.55);
      backdrop-filter: blur(4px);
      display: flex; align-items: center; justify-content: center;
      padding: 20px;
      opacity: 0; pointer-events: none;
      transition: opacity 0.22s;
    }
    .overlay.open { opacity: 1; pointer-events: all; }
    .modal-box {
      background: var(--white);
      border-radius: 20px;
      width: 100%; max-width: 480px;
      max-height: 90vh; overflow-y: auto;
      box-shadow: var(--shadow-lg);
      transform: translateY(16px) scale(0.97);
      transition: transform 0.25s cubic-bezier(0.22,1,0.36,1);
    }
    .overlay.open .modal-box { transform: translateY(0) scale(1); }
    .modal-box.wide { max-width: 640px; }

    .modal-head {
      display: flex; align-items: center; justify-content: space-between;
      padding: 20px 24px 16px;
      border-bottom: 1px solid var(--border);
      position: sticky; top: 0; background: var(--white); z-index: 1;
    }
    .modal-head h3 { font-size: 18px; font-weight: 900; color: var(--dark); }
    .modal-close {
      width: 32px; height: 32px;
      background: var(--surface); border: none; border-radius: 8px;
      cursor: pointer; font-size: 16px; color: var(--muted);
      display: flex; align-items: center; justify-content: center;
      transition: all 0.15s;
    }
    .modal-close:hover { background: var(--red-dim); color: var(--red); }
    .modal-body { padding: 20px 24px; }
    .modal-footer {
      padding: 16px 24px 20px;
      border-top: 1px solid var(--border);
      display: flex; gap: 10px; justify-content: flex-end;
    }

    /* ‚ïê‚ïê PEDIDO MODAL ‚ïê‚ïê */
    .pedido-items { display: flex; flex-direction: column; gap: 8px; min-height: 80px; margin-bottom: 16px; }
    .pedido-item {
      display: flex; align-items: center; gap: 12px;
      background: var(--surface); border-radius: 10px; padding: 10px 14px;
    }
    .pi-emoji { font-size: 20px; }
    .pi-info { flex: 1; }
    .pi-nombre { font-size: 14px; font-weight: 700; color: var(--dark); }
    .pi-qty { font-size: 12px; color: var(--muted); }
    .pi-precio { font-size: 14px; font-weight: 700; color: var(--blue-mid); }
    .pedido-total-row {
      display: flex; justify-content: space-between; align-items: center;
      padding: 14px; background: var(--blue-xl);
      border-radius: 12px; margin-bottom: 16px;
    }
    .pedido-total-label { font-size: 14px; font-weight: 700; color: var(--mid); }
    .pedido-total-val   { font-size: 20px; font-weight: 900; color: var(--navy); }
    .pedido-actions { display: flex; gap: 8px; flex-wrap: wrap; }
    .pedido-empty { text-align: center; padding: 30px; color: var(--muted); font-size: 14px; }

    /* ‚ïê‚ïê SELECTOR DE ITEMS ‚ïê‚ïê */
    .items-overlay {
      position: fixed; inset: 0; z-index: 110;
      background: var(--bg);
      display: none; flex-direction: column;
    }
    .items-overlay.open { display: flex; }
    .items-header {
      background: linear-gradient(135deg, #0A1931 0%, #1A3D63 100%);
      padding: 16px 20px;
      display: flex; align-items: center; gap: 16px;
      box-shadow: 0 2px 12px rgba(10,25,49,0.4);
    }
    .items-header h3 { font-size: 16px; font-weight: 700; color: white; flex: 1; }
    .items-close {
      background: rgba(255,255,255,0.1); border: none; border-radius: 8px;
      color: white; padding: 7px 14px; cursor: pointer;
      font-family: 'Lato', sans-serif; font-size: 13px; font-weight: 700;
    }
    .items-search-wrap { padding: 14px 20px 0; }
    .items-search {
      width: 100%; background: var(--white); border: 1px solid var(--border);
      border-radius: 10px; padding: 10px 14px;
      font-family: 'Lato', sans-serif; font-size: 14px; outline: none;
    }
    .items-cats { display: flex; gap: 8px; padding: 12px 20px; overflow-x: auto; }
    .items-cat {
      padding: 6px 14px; border-radius: 20px;
      background: var(--white); border: 1px solid var(--border);
      font-size: 12px; font-weight: 700; cursor: pointer;
      white-space: nowrap; transition: all 0.15s;
    }
    .items-cat.active { background: var(--navy); color: white; border-color: var(--navy); }
    .items-grid {
      flex: 1; overflow-y: auto;
      display: grid; grid-template-columns: repeat(auto-fill, 150px);
      justify-content: start;
      align-content: start;
      gap: 10px; padding: 10px 20px 20px;
    }
    .item-card {
      background: var(--white); border: 1px solid var(--border);
      border-radius: 12px; padding: 14px 10px;
      text-align: center; cursor: pointer;
      transition: all 0.18s; box-shadow: var(--shadow-sm);
    }
    .item-card:hover { border-color: var(--amber); box-shadow: var(--shadow-md); transform: translateY(-2px); }
    .item-card:active { transform: scale(0.96); }
    .item-emoji { font-size: 26px; display: block; margin-bottom: 6px; }
    .item-name  { font-size: 12px; font-weight: 700; color: var(--dark); margin-bottom: 3px; }
    .item-price { font-size: 13px; font-weight: 900; color: var(--amber); }

    /* ‚ïê‚ïê COMANDA ‚ïê‚ïê */
    .comanda-ticket {
      font-family: 'Courier New', monospace;
      background: white;
      border: 2px dashed #ccc;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 16px;
    }
    .comanda-ticket h4 {
      text-align: center; font-size: 18px; font-weight: bold;
      margin-bottom: 4px; border-bottom: 1px dashed #999; padding-bottom: 8px;
    }
    .comanda-meta { text-align: center; font-size: 12px; color: #666; margin-bottom: 12px; }
    .comanda-ul { list-style: none; padding: 0; }
    .comanda-ul li {
      display: flex; justify-content: space-between;
      padding: 5px 0; border-bottom: 1px dotted #eee;
      font-size: 14px;
    }
    .comanda-ul li:last-child { border-bottom: none; }

    /* ‚ïê‚ïê COBRO ‚ïê‚ïê */
    .cobro-total-box {
      background: var(--blue-xl); border-radius: 12px; padding: 16px;
      text-align: center; margin-bottom: 18px;
    }
    .cobro-total-label { font-size: 13px; color: var(--muted); font-weight: 700; }
    .cobro-total-val   { font-size: 28px; font-weight: 900; color: var(--navy); margin-top: 4px; }
    .cobro-opts { display: flex; gap: 10px; margin-bottom: 18px; }
    .cobro-opt {
      flex: 1; padding: 12px; border-radius: 10px;
      border: 2px solid var(--border); background: var(--white);
      cursor: pointer; text-align: center;
      font-family: 'Lato', sans-serif; font-size: 13px; font-weight: 700;
      color: var(--dark); transition: all 0.18s;
    }
    .cobro-opt.active { border-color: var(--blue); background: var(--blue-xl); color: var(--blue-mid); }
    .cobro-opt .co-icon { font-size: 22px; display: block; margin-bottom: 4px; }
    .divisiones-list { display: flex; flex-direction: column; gap: 8px; margin-bottom: 12px; }
    .division-row {
      display: flex; align-items: center; gap: 10px;
      background: var(--surface); border-radius: 10px; padding: 10px 14px;
    }
    .division-label { font-size: 13px; font-weight: 700; color: var(--mid); flex-shrink: 0; min-width: 80px; }
    .division-input {
      flex: 1; background: var(--white); border: 1px solid var(--border);
      border-radius: 8px; padding: 8px 12px;
      font-family: 'Lato', sans-serif; font-size: 14px; font-weight: 700;
      color: var(--dark); outline: none;
    }
    .division-input:focus { border-color: var(--blue); }
    .cobro-faltante {
      display: flex; justify-content: space-between; align-items: center;
      padding: 12px 14px; border-radius: 10px;
      background: var(--surface); margin-bottom: 4px;
      font-size: 14px; font-weight: 700; color: var(--mid);
    }

    /* ‚ïê‚ïê FORM FIELDS ‚ïê‚ïê */
    .form-group { margin-bottom: 16px; }
    .form-label {
      display: block; font-size: 12px; font-weight: 700;
      letter-spacing: 0.6px; text-transform: uppercase;
      color: var(--muted); margin-bottom: 7px;
    }
    .form-input {
      width: 100%; background: var(--surface);
      border: 1px solid var(--border); border-radius: 10px;
      padding: 11px 14px; font-family: 'Lato', sans-serif;
      font-size: 14px; color: var(--dark); outline: none;
      transition: border-color 0.18s;
    }
    .form-input:focus { border-color: var(--blue); }
    .form-input::placeholder { color: var(--muted); }
    select.form-input { cursor: pointer; }

    /* ‚ïê‚ïê TOAST ‚ïê‚ïê */
    .toast {
      position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(20px);
      background: var(--navy); color: white;
      padding: 12px 22px; border-radius: 12px;
      font-size: 14px; font-weight: 700;
      box-shadow: var(--shadow-md);
      opacity: 0; pointer-events: none;
      transition: all 0.25s; z-index: 999; white-space: nowrap;
    }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

    /* ‚ïê‚ïê EMPTY STATE ‚ïê‚ïê */
    .empty-state {
      text-align: center; padding: 60px 20px;
      color: var(--muted); font-size: 15px;
    }
    .empty-state .es-icon { font-size: 40px; display: block; margin-bottom: 12px; opacity: 0.5; }

    /* ‚ïê‚ïê LOADING ‚ïê‚ïê */
    .loading-spinner {
      display: inline-block;
      width: 18px; height: 18px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.65s linear infinite;
      vertical-align: middle; margin-right: 6px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ‚ïê‚ïê POS MESA VIEW (split layout) ‚ïê‚ïê */
    .pos-layout {
      display: grid;
      grid-template-columns: 1fr 340px;
      height: calc(100vh - 60px);
      overflow: hidden;
    }
    .pos-left {
      display: flex; flex-direction: column;
      overflow: hidden; background: var(--bg);
    }
    .pos-top-bar {
      display: flex; align-items: center; gap: 14px;
      padding: 12px 20px;
      background: linear-gradient(135deg, #0A1931 0%, #1A3D63 100%);
      flex-shrink: 0;
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }
    .pos-back-btn {
      background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.12);
      color: rgba(255,255,255,0.75); border-radius: 9px;
      padding: 7px 13px; font-family: 'Lato', sans-serif;
      font-size: 12px; font-weight: 700; cursor: pointer;
      transition: all 0.15s; white-space: nowrap; flex-shrink: 0;
      letter-spacing: 0.2px;
    }
    .pos-back-btn:hover { background: rgba(255,255,255,0.14); color: white; }
    .pos-mesa-id { display: flex; align-items: center; gap: 11px; flex: 1; min-width: 0; }
    .pos-mesa-icon {
      background: linear-gradient(135deg, var(--amber), #B45309);
      width: 38px; height: 38px; border-radius: 11px; flex-shrink: 0;
      display: flex; align-items: center; justify-content: center;
      font-size: 18px; box-shadow: 0 3px 10px rgba(217,119,6,0.45);
    }
    .pos-mesa-name {
      font-family: 'Syne', sans-serif;
      font-size: 21px; font-weight: 800; color: white;
      letter-spacing: 0.1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .pos-search-wrap { padding: 12px 16px 8px; flex-shrink: 0; }
    .pos-search {
      width: 100%; background: var(--white);
      border: 1px solid var(--border); border-radius: 10px;
      padding: 10px 14px; font-family: 'Lato', sans-serif;
      font-size: 14px; color: var(--dark); outline: none;
    }
    .pos-search:focus { border-color: var(--blue); }
    .pos-cats-bar {
      display: flex; gap: 8px; padding: 0 16px 10px;
      overflow-x: auto; flex-shrink: 0;
    }
    .pos-cat-btn {
      padding: 6px 14px; border-radius: 20px;
      background: var(--white); border: 1px solid var(--border);
      font-size: 12px; font-weight: 700; cursor: pointer;
      white-space: nowrap; transition: all 0.15s;
    }
    .pos-cat-btn.active { background: var(--navy); color: white; border-color: var(--navy); }
    .pos-prods-grid {
      flex: 1; overflow-y: auto;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 10px; padding: 4px 16px 16px;
      align-content: start;
    }
    .pos-prod-card {
      background: var(--white); border: 1.5px solid var(--border);
      border-radius: 14px; padding: 16px 12px;
      text-align: center; cursor: pointer;
      transition: all 0.18s; box-shadow: var(--shadow-sm);
      user-select: none;
    }
    .pos-prod-card:hover { border-color: var(--amber); box-shadow: var(--shadow-md); transform: translateY(-2px); }
    .pos-prod-card:active { transform: scale(0.95); }
    .pos-prod-emoji { font-size: 30px; display: block; margin-bottom: 8px; }
    .pos-prod-name  { font-size: 13px; font-weight: 700; color: var(--dark); margin-bottom: 4px; line-height: 1.3; }
    .pos-prod-price { font-size: 14px; font-weight: 900; color: var(--amber); }

    /* Right: order panel */
    .pos-right {
      background: var(--white);
      border-left: 1px solid var(--border);
      display: flex; flex-direction: column;
      overflow: hidden;
    }
    .pos-order-head {
      padding: 16px 20px;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      font-size: 14px; font-weight: 900; color: var(--mid);
      letter-spacing: 0.3px; flex-shrink: 0;
    }
    .pos-order-items {
      flex: 1; overflow-y: auto; padding: 10px;
      display: flex; flex-direction: column; gap: 6px;
    }
    .pos-order-item {
      display: flex; align-items: center; gap: 10px;
      background: var(--surface); border-radius: 10px;
      padding: 10px 12px;
    }
    .poi-emoji { font-size: 18px; flex-shrink: 0; }
    .poi-info  { flex: 1; min-width: 0; }
    .poi-name  { font-size: 13px; font-weight: 700; color: var(--dark);
                 white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .poi-qty   { font-size: 11px; color: var(--muted); }
    .poi-price { font-size: 13px; font-weight: 700; color: var(--blue-mid); flex-shrink: 0; }
    .poi-del {
      background: none; border: none; cursor: pointer;
      color: var(--red); font-size: 16px; padding: 2px 4px;
      flex-shrink: 0; line-height: 1; opacity: 0.6; transition: opacity 0.15s;
    }
    .poi-del:hover { opacity: 1; }
    .pos-order-empty {
      text-align: center; padding: 40px 16px;
      color: var(--muted); font-size: 13px;
    }
    .pos-order-foot {
      padding: 14px 16px;
      border-top: 1px solid var(--border);
      flex-shrink: 0;
    }
    .pos-total-row {
      display: flex; justify-content: space-between; align-items: center;
      background: var(--blue-xl); border-radius: 10px;
      padding: 12px 14px; margin-bottom: 12px;
    }
    .pos-total-label { font-size: 13px; font-weight: 700; color: var(--mid); }
    .pos-total-val   { font-size: 22px; font-weight: 900; color: var(--navy); }
    .pos-foot-btns   { display: flex; gap: 8px; }

    @media (max-width: 640px) {
      .pos-layout { grid-template-columns: 1fr; grid-template-rows: 1fr auto; }
      .pos-right  { max-height: 42vh; border-left: none; border-top: 1px solid var(--border); }
    }

    /* ‚ïê‚ïê MESA BUBBLE (Rappi style) ‚ïê‚ïê */
    .mesa-bubble {
      position: fixed; bottom: 22px; left: 50%; transform: translateX(-50%);
      width: 580px; max-width: calc(100vw - 36px); z-index: 55; display: none;
    }
    .mesa-bubble.visible { display: block; }

    .mb-panel {
      background: var(--white); border-radius: 22px 22px 0 0; overflow: hidden;
      max-height: 0; opacity: 0;
      transition: max-height 0.42s cubic-bezier(0.4,0,0.2,1), opacity 0.28s ease;
      box-shadow: 0 -8px 40px rgba(10,25,49,0.13), 0 -2px 8px rgba(10,25,49,0.07);
    }
    .mesa-bubble:hover .mb-panel,
    .mesa-bubble.pinned .mb-panel { max-height: 400px; opacity: 1; }

    .mb-panel-inner { padding: 16px 20px 0; }
    .mb-panel-header {
      display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;
    }
    .mb-panel-title { font-size: 11px; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; }
    .mb-items-list { max-height: 190px; overflow-y: auto; display: flex; flex-direction: column; }
    .mb-item {
      display: flex; align-items: center; gap: 10px;
      padding: 8px 0; border-bottom: 1px solid var(--border);
      animation: mb-item-in .18s ease;
    }
    @keyframes mb-item-in { from { opacity:0; transform:translateX(-5px); } to { opacity:1; transform:none; } }
    .mb-item-emoji {
      font-size: 18px; width: 34px; height: 34px; background: var(--bg); border-radius: 8px;
      display: flex; align-items: center; justify-content: center; flex-shrink: 0;
    }
    .mb-item-info { flex: 1; min-width: 0; }
    .mb-item-name { font-size: 12px; font-weight: 700; color: var(--dark); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .mb-item-qty  { font-size: 11px; color: var(--muted); margin-top: 1px; }
    .mb-item-price { font-size: 12px; font-weight: 900; color: var(--blue-mid); flex-shrink: 0; }
    .mb-msg { text-align: center; padding: 18px; color: var(--muted); font-size: 13px; }

    .mb-footer {
      display: flex; justify-content: space-between; align-items: center;
      padding: 12px 20px; background: var(--bg);
      border-top: 1px solid var(--border); gap: 8px;
    }
    .mb-total-wrap { display: flex; flex-direction: column; }
    .mb-total-lbl  { font-size: 10px; color: var(--muted); }
    .mb-total-val  { font-size: 22px; font-weight: 900; color: var(--navy); letter-spacing: -0.5px; }
    .mb-btns { display: flex; gap: 8px; }

    /* Bar pill */
    .mb-bar {
      background: linear-gradient(135deg, #0A1931 0%, #122B50 60%, #1A3D63 100%);
      border-radius: 20px; padding: 11px 12px 11px 16px;
      display: flex; align-items: center; justify-content: space-between;
      cursor: pointer; position: relative; z-index: 1;
      box-shadow: 0 8px 40px rgba(10,25,49,0.50), 0 2px 8px rgba(10,25,49,0.3);
      transition: border-radius 0.32s ease;
    }
    .mesa-bubble:hover .mb-bar, .mesa-bubble.pinned .mb-bar { border-radius: 0 0 20px 20px; }
    .mb-bar-left { display: flex; align-items: center; gap: 11px; }
    .mb-icon {
      background: linear-gradient(135deg, var(--amber), #B45309);
      width: 38px; height: 38px; border-radius: 11px;
      display: flex; align-items: center; justify-content: center;
      font-size: 18px; flex-shrink: 0;
      box-shadow: 0 2px 8px rgba(217,119,6,0.4);
    }
    .mb-bar-info { display: flex; flex-direction: column; }
    .mb-bar-mesa  { font-family: 'Syne', sans-serif; font-size: 16px; font-weight: 800; color: white; }
    .mb-bar-sub   { font-size: 11px; color: rgba(255,255,255,0.42); }
    .mb-bar-right { display: flex; align-items: center; gap: 10px; }
    .mb-bar-total { font-size: 20px; font-weight: 900; color: white; letter-spacing: -0.5px; }
    .mb-arrow { color: rgba(255,255,255,0.32); font-size: 15px; transition: transform 0.3s; }
    .mesa-bubble:hover .mb-arrow, .mesa-bubble.pinned .mb-arrow { transform: rotate(180deg); }

    .btn-abrir-pos {
      background: linear-gradient(135deg, var(--amber), #B45309);
      color: white; border: none; border-radius: 12px;
      padding: 9px 18px; font-family: 'Lato', sans-serif;
      font-size: 13px; font-weight: 700; cursor: pointer;
      transition: all 0.18s; white-space: nowrap;
      box-shadow: 0 3px 14px rgba(217,119,6,0.45);
    }
    .btn-abrir-pos:hover { transform: scale(1.04); box-shadow: 0 5px 20px rgba(217,119,6,0.6); }

    @media (max-width: 640px) {
      .mesa-bubble { bottom: 74px; left: 8px; right: 8px; width: auto; transform: none; }
      .mb-bar { border-radius: 14px; padding: 9px 12px; }
      .mb-bar-mesa { font-size: 14px; }
      .mb-bar-total { font-size: 17px; }
    }

    /* ‚ïê‚ïê MOBILE NAV ‚ïê‚ïê */
    .bottom-nav {
      display: none;
      position: fixed; bottom: 0; left: 0; right: 0;
      background: linear-gradient(135deg, #0A1931 0%, #1A3D63 100%);
      padding: 8px 10px 12px;
      gap: 4px; z-index: 60;
      box-shadow: 0 -2px 20px rgba(10,25,49,0.4);
    }
    @media (max-width: 640px) {
      .nav-tabs { display: none; }
      .bottom-nav { display: flex; }
      .main { padding-bottom: 72px; }
      .view { padding: 16px; }
      #view-mesas { padding: 0; }
    }
    .bnav-btn {
      flex: 1; display: flex; flex-direction: column; align-items: center; gap: 3px;
      background: transparent; border: none; cursor: pointer;
      padding: 6px 4px; border-radius: 10px; transition: all 0.18s;
    }
    .bnav-btn.active { background: rgba(217,119,6,0.2); }
    .bnav-btn span:first-child { font-size: 20px; }
    .bnav-btn span:last-child { font-size: 10px; font-weight: 700; color: rgba(255,255,255,0.55); }
    .bnav-btn.active span:last-child { color: #FCD34D; }
  </style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê -->
<header class="header">
  <div class="logo">
    <div class="logo-mark">üçΩÔ∏è</div>
    <span class="logo-name">Flow<em>POS</em></span>
    <span class="logo-badge">RESTAURANTE</span>
  </div>
  <nav class="nav-tabs">
    <button class="nav-tab active" onclick="goTo('mesas', this)">ü™ë Mesas</button>
    <button class="nav-tab" onclick="goTo('domicilios', this)">üõµ Domicilios</button>
    <button class="nav-tab" onclick="goTo('menu', this)">üç± Men√∫</button>
    <button class="nav-tab" onclick="goTo('reportes', this)">üìä Reportes</button>
  </nav>
  <div class="header-right">
    <div class="user-pill">
      <div class="user-avatar" id="userAvatar">?</div>
      <span class="user-name" id="userName">...</span>
    </div>
    <button class="btn-logout" onclick="salir()">Salir</button>
  </div>
</header>

<!-- ‚ïê‚ïê‚ïê MAIN ‚ïê‚ïê‚ïê -->
<main class="main">

  <!-- MESAS -->
  <section id="view-mesas" class="view active">
    <!-- Toolbar -->
    <div class="floor-toolbar">
      <div class="floor-legend">
        <div class="legend-item"><div class="legend-pip libre"></div>Libre</div>
        <div class="legend-item"><div class="legend-pip ocupada"></div>Ocupada</div>
      </div>
      <div class="floor-toolbar-right">
        <button class="btn-edit-mode" id="btnEditMode" onclick="toggleEditMode()">
          ‚ú¶ Mover mesas
        </button>
        <button class="btn-floor-add" onclick="crearMesa()">Ôºã Mesa</button>
      </div>
    </div>
    <!-- Floor canvas -->
    <div class="mesas-canvas" id="mesasCanvas">
      <!-- Plantas decorativas -->
      <div class="floor-plant" style="top:1.5%;left:1%">ü™¥</div>
      <div class="floor-plant" style="top:1.5%;right:1%">üåø</div>
      <div class="floor-plant" style="bottom:4%;left:1%">üå±</div>
      <div class="floor-plant" style="bottom:4%;right:1%">ü™¥</div>
      <!-- Mesas renderizadas por JS aqu√≠ -->
      <div id="mesasGrid"></div>
    </div>
  </section>

  <!-- DOMICILIOS -->
  <section id="view-domicilios" class="view">
    <div class="view-header">
      <h2>Domicilios</h2>
      <button class="btn-amber" onclick="abrirFormDomicilio()">Ôºã Nuevo domicilio</button>
    </div>
    <div class="domicilio-list" id="domiciliosList">
      <div class="empty-state"><span class="es-icon">üõµ</span>No hay domicilios hoy</div>
    </div>
  </section>

  <!-- MEN√ö -->
  <section id="view-menu" class="view">
    <div class="view-header">
      <h2>Men√∫</h2>
      <button class="btn-primary" onclick="abrirFormProducto()">Ôºã Nuevo producto</button>
    </div>
    <div class="inv-toolbar">
      <input class="inv-search" id="menuSearch" placeholder="Buscar producto..." oninput="renderMenu()">
    </div>
    <div class="prod-grid" id="menuGrid">
      <div class="empty-state"><span class="es-icon">üç±</span>No hay productos a√∫n</div>
    </div>
  </section>

  <!-- REPORTES -->
  <section id="view-reportes" class="view">
    <div class="view-header"><h2>Reportes</h2></div>
    <div class="report-cards">
      <div class="report-card">
        <div class="rc-label">Ventas hoy</div>
        <div class="rc-value" id="rVentasHoy">$ 0</div>
        <div class="rc-sub" id="rCantHoy">0 pedidos</div>
      </div>
      <div class="report-card">
        <div class="rc-label">Ventas semana</div>
        <div class="rc-value" id="rVentasSemana">$ 0</div>
        <div class="rc-sub" id="rCantSemana">0 pedidos</div>
      </div>
      <div class="report-card">
        <div class="rc-label">Domicilios hoy</div>
        <div class="rc-value" id="rDomHoy">0</div>
        <div class="rc-sub">pendientes + entregados</div>
      </div>
      <div class="report-card">
        <div class="rc-label">Mesas activas</div>
        <div class="rc-value" id="rMesasActivas">0</div>
        <div class="rc-sub">ocupadas ahora</div>
      </div>
    </div>
  </section>

  <!-- POS MESA VIEW -->
  <section id="view-pos-mesa" class="view" style="padding:0">
    <div class="pos-layout">
      <!-- Izquierda: productos -->
      <div class="pos-left">
        <div class="pos-top-bar">
          <button class="pos-back-btn" onclick="volverAMesas()">‚Üê Mesas</button>
          <div class="pos-mesa-id">
            <div class="pos-mesa-icon">ü™ë</div>
            <span class="pos-mesa-name" id="posMesaTitle">Mesa 1</span>
          </div>
        </div>
        <div class="pos-search-wrap">
          <input class="pos-search" id="posSearch" placeholder="Buscar producto..." oninput="renderPosProds()">
        </div>
        <div class="pos-cats-bar" id="posCatsBar"></div>
        <div class="pos-prods-grid" id="posProdsGrid"></div>
      </div>
      <!-- Derecha: pedido -->
      <div class="pos-right">
        <div class="pos-order-head">üßæ Pedido en curso</div>
        <div class="pos-order-items" id="posOrderItems">
          <div class="pos-order-empty">Toca un producto para agregarlo</div>
        </div>
        <div class="pos-order-foot">
          <div class="pos-total-row">
            <span class="pos-total-label">Total</span>
            <span class="pos-total-val" id="posTotalVal">$ 0</span>
          </div>
          <div class="pos-foot-btns">
            <button class="btn-secondary" onclick="mostrarComanda()">üñ®Ô∏è Comanda</button>
            <button class="btn-amber" style="flex:1" onclick="abrirCobro()">üí≥ Cobrar</button>
          </div>
        </div>
      </div>
    </div>
  </section>

</main>

<!-- ‚ïê‚ïê‚ïê BOTTOM NAV (mobile) ‚ïê‚ïê‚ïê -->
<nav class="bottom-nav" id="bottomNav">
  <button class="bnav-btn active" onclick="goTo('mesas', this)"><span>ü™ë</span><span>Mesas</span></button>
  <button class="bnav-btn" onclick="goTo('domicilios', this)"><span>üõµ</span><span>Domicilios</span></button>
  <button class="bnav-btn" onclick="goTo('menu', this)"><span>üç±</span><span>Men√∫</span></button>
  <button class="bnav-btn" onclick="goTo('reportes', this)"><span>üìä</span><span>Reportes</span></button>
</nav>

<!-- Items overlay ‚Äî solo para domicilios -->
<div class="items-overlay" id="itemsOverlay">
  <div class="items-header">
    <h3 id="itemsTitle">Agregar al domicilio</h3>
    <button class="items-close" onclick="cerrarSelectorItems()">‚úï Listo</button>
  </div>
  <div class="items-search-wrap">
    <input class="items-search" id="itemsSearch" placeholder="Buscar..." oninput="renderItemsGrid()">
  </div>
  <div class="items-cats" id="itemsCats"></div>
  <div class="items-grid" id="itemsGrid"></div>
</div>

<!-- ‚ïê‚ïê‚ïê MESA BUBBLE ‚ïê‚ïê‚ïê -->
<div class="mesa-bubble" id="mesaBubble"
  onmouseenter="clearBubbleTimer()"
  onmouseleave="schedBubbleHide()">
  <div class="mb-panel">
    <div class="mb-panel-inner">
      <div class="mb-panel-header">
        <span class="mb-panel-title" id="mbPanelTitle">Pedido en curso</span>
      </div>
      <div class="mb-items-list" id="mbItemsList">
        <div class="mb-msg">Cargando...</div>
      </div>
    </div>
    <div class="mb-footer">
      <div class="mb-total-wrap">
        <span class="mb-total-lbl">Total</span>
        <span class="mb-total-val" id="mbTotalVal">$ 0</span>
      </div>
      <div class="mb-btns">
        <button class="btn-secondary" id="mbBtnComanda" onclick="cmdBurbuja()" style="display:none">üñ®Ô∏è Comanda</button>
        <button class="btn-abrir-pos" onclick="abrirBurbuja()">Abrir POS ‚Üí</button>
      </div>
    </div>
  </div>
  <div class="mb-bar" onclick="pinBurbuja(event)">
    <div class="mb-bar-left">
      <div class="mb-icon" id="mbIcon">ü™ë</div>
      <div class="mb-bar-info">
        <span class="mb-bar-mesa" id="mbBarMesa">Mesa</span>
        <span class="mb-bar-sub"  id="mbBarSub">Libre</span>
      </div>
    </div>
    <div class="mb-bar-right">
      <span class="mb-bar-total" id="mbBarTotal"></span>
      <span class="mb-arrow">‚ñæ</span>
      <button class="btn-abrir-pos" onclick="abrirBurbuja()">Abrir ‚Üí</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê MODAL: COMANDA ‚ïê‚ïê‚ïê -->
<div class="overlay" id="comandaOverlay">
  <div class="modal-box">
    <div class="modal-head">
      <h3>Comanda</h3>
      <button class="modal-close" onclick="cerrarOverlay('comandaOverlay')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="comanda-ticket" id="comandaTicket"></div>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" onclick="cerrarOverlay('comandaOverlay')">Listo</button>
      <button class="btn-primary" onclick="imprimirComanda()">üñ®Ô∏è Imprimir</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê MODAL: COBRO ‚ïê‚ïê‚ïê -->
<div class="overlay" id="cobroOverlay">
  <div class="modal-box">
    <div class="modal-head">
      <h3 id="cobroTitle">Cobrar mesa</h3>
      <button class="modal-close" onclick="cerrarOverlay('cobroOverlay')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="cobro-total-box">
        <div class="cobro-total-label">Total a cobrar</div>
        <div class="cobro-total-val" id="cobroTotalVal">$ 0</div>
      </div>
      <div class="cobro-opts">
        <div class="cobro-opt active" id="optCompleto" onclick="setCobroMode('completo')">
          <span class="co-icon">üí≥</span>Pago completo
        </div>
        <div class="cobro-opt" id="optDividir" onclick="setCobroMode('dividir')">
          <span class="co-icon">üë•</span>Dividir cuenta
        </div>
      </div>
      <div id="cobro-panel-dividir" style="display:none">
        <div class="divisiones-list" id="divisionesList"></div>
        <button class="btn-secondary btn-block" onclick="agregarDivision()" style="margin-bottom:12px">
          Ôºã Agregar persona
        </button>
        <div class="cobro-faltante">
          <span>Faltante</span>
          <span id="cobroFaltante" style="color:var(--red)">$ 0</span>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" onclick="cerrarOverlay('cobroOverlay')">Cancelar</button>
      <button class="btn-green" id="btnConfirmarCobro" onclick="confirmarCobro()">‚úì Confirmar pago</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê MODAL: NUEVO DOMICILIO ‚ïê‚ïê‚ïê -->
<div class="overlay" id="domicilioOverlay" onclick="closeDomOnBg(event)">
  <div class="modal-box">
    <div class="modal-head">
      <h3>Nuevo domicilio</h3>
      <button class="modal-close" onclick="cerrarOverlay('domicilioOverlay')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Nombre del cliente</label>
        <input id="domNombre" type="text" class="form-input" placeholder="Nombre completo">
      </div>
      <div class="form-group">
        <label class="form-label">Direcci√≥n</label>
        <input id="domDir" type="text" class="form-input" placeholder="Calle, barrio...">
      </div>
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px">
        <span style="font-size:13px;font-weight:700;color:var(--mid)">√çtems del pedido</span>
        <button class="btn-secondary" onclick="abrirSelectorItemsDom()" style="padding:6px 12px;font-size:12px">Ôºã Agregar</button>
      </div>
      <div id="domItemsList" style="display:flex;flex-direction:column;gap:6px;margin-bottom:12px"></div>
      <div class="pedido-total-row">
        <span class="pedido-total-label">Total</span>
        <span class="pedido-total-val" id="domTotalVal">$ 0</span>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" onclick="cerrarOverlay('domicilioOverlay')">Cancelar</button>
      <button class="btn-amber" onclick="crearDomicilio()">Crear pedido</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê MODAL: PRODUCTO ‚ïê‚ïê‚ïê -->
<div class="overlay" id="productoOverlay" onclick="closeProdOnBg(event)">
  <div class="modal-box">
    <div class="modal-head">
      <h3 id="prodModalTitle">Nuevo producto</h3>
      <button class="modal-close" onclick="cerrarOverlay('productoOverlay')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Emoji</label>
        <input id="prodEmoji" type="text" class="form-input" placeholder="üçï" maxlength="4">
      </div>
      <div class="form-group">
        <label class="form-label">Nombre</label>
        <input id="prodNombre" type="text" class="form-input" placeholder="Nombre del plato">
      </div>
      <div class="form-group">
        <label class="form-label">Precio</label>
        <input id="prodPrecio" type="number" class="form-input" placeholder="0">
      </div>
      <div class="form-group">
        <label class="form-label">Categor√≠a</label>
        <select id="prodCat" class="form-input">
          <option value="general">General</option>
        </select>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" onclick="cerrarOverlay('productoOverlay')">Cancelar</button>
      <button class="btn-primary" onclick="guardarProducto()">Guardar</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê TOAST ‚ïê‚ïê‚ïê -->
<div class="toast" id="toast"></div>

<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   CONFIG
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const SB_URL  = 'https://uegaxpaejvjjwqnyurpx.supabase.co';
const SB_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVlZ2F4cGFlanZqandxbnl1cnB4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE3OTA5MTMsImV4cCI6MjA4NzM2NjkxM30.gtht8IbRcjzO97TymeMIOVALVRq6c38u_-JJYrWXSOk';
const _sb     = supabase.createClient(SB_URL, SB_ANON);

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   STATE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let USER_ID      = null;
let USER_NAME    = '';
let PRODUCTOS    = [];
let CATEGORIAS   = [];

// Mesa / pedido activo
let MESA_ID      = null;
let MESA_NUM     = null;
let PEDIDO_ID    = null;
let PEDIDO_ITEMS = [];
let PEDIDO_TOTAL = 0;

// Domicilio en construcci√≥n
let DOM_ITEMS    = [];
let DOM_TOTAL    = 0;

// Cobro
let COBRO_MODE   = 'completo';
let DIVISIONES   = [];

// Contexto de items selector
let ITEMS_CONTEXT = null; // 'mesa' o 'dom'
let ITEMS_CAT     = 'all';
let PROD_EDIT_ID  = null;

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   HELPERS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function fmt(n) { return '$ ' + Math.round(n).toLocaleString('es-CO'); }
function todayStr() { return new Date().toISOString().split('T')[0]; }
function genId() { return 'r-' + Date.now() + '-' + Math.random().toString(36).slice(2, 7); }

let toastTimer;
function toast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => el.classList.remove('show'), 2400);
}

function abrirOverlay(id) { document.getElementById(id)?.classList.add('open'); }
function cerrarOverlay(id) { document.getElementById(id)?.classList.remove('open'); }

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   NAVEGACI√ìN
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let VIEW_ACTUAL = 'mesas';
let POS_CAT     = 'all';

// Mesa Bubble state
let BUBBLE_ID      = null;
let BUBBLE_NUM     = null;
let BUBBLE_ESTADO  = null;
let BUBBLE_PED_ID  = null;
let BUBBLE_TOTAL   = 0;
let BUBBLE_LOADED  = false;
let _bubbleTimer   = null;

function goTo(view, btn) {
  if (VIEW_ACTUAL === view) return;
  VIEW_ACTUAL = view;

  // desktop tabs
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  // mobile tabs
  document.querySelectorAll('.bnav-btn').forEach(t => t.classList.remove('active'));

  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.getElementById('view-' + view).classList.add('active');

  if (btn) btn.classList.add('active');

  if (view === 'mesas')      cargarMesas();
  if (view === 'domicilios') cargarDomicilios();
  if (view === 'menu')       renderMenu();
  if (view === 'reportes')   cargarReportes();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   AUTH
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function salir() {
  await _sb.auth.signOut();
  window.location.href = 'index.html';
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MESAS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
/* Posiciones default por √≠ndice */
const FLOOR_COLS = 5;
function defaultPos(idx) {
  const col = idx % FLOOR_COLS;
  const row = Math.floor(idx / FLOOR_COLS);
  // Distribuir en % del canvas con margen
  const x = 8 + col * 18;
  const y = 10 + row * 28;
  return { x, y };
}

function getMesaPos(mesaId, idx) {
  const key = `fp_${USER_ID}_${mesaId}`;
  const stored = localStorage.getItem(key);
  if (stored) return JSON.parse(stored);
  return defaultPos(idx);
}

function saveMesaPos(mesaId, x, y) {
  localStorage.setItem(`fp_${USER_ID}_${mesaId}`, JSON.stringify({ x, y }));
}

async function cargarMesas() {
  const canvas = document.getElementById('mesasCanvas');
  const grid   = document.getElementById('mesasGrid');

  const [{ data: mesas, error }, { data: pedidos }] = await Promise.all([
    _sb.from('mesas').select('*').eq('user_id', USER_ID).order('numero'),
    _sb.from('pedidos').select('id, mesa_id, total').eq('user_id', USER_ID).eq('estado', 'abierto')
  ]);

  if (error || !mesas?.length) {
    grid.innerHTML = `<div class="floor-empty">
      <div style="font-size:48px;margin-bottom:12px">ü™ë</div>
      No hay mesas. Crea la primera.
    </div>`;
    return;
  }

  const pedidosAbiertos = {};
  if (pedidos) pedidos.forEach(p => { pedidosAbiertos[p.mesa_id] = p; });

  grid.innerHTML = '';
  mesas.forEach((m, idx) => {
    const pedido = pedidosAbiertos[m.id];
    const estado = m.estado === 'ocupada' ? 'ocupada' : 'libre';
    const pos    = getMesaPos(m.id, idx);
    const total  = pedido?.total || 0;

    const el = document.createElement('div');
    el.className  = `floor-mesa ${estado}`;
    el.id         = `fm-${m.id}`;
    el.style.left = pos.x + '%';
    el.style.top  = pos.y + '%';
    el.dataset.mesaId   = m.id;
    el.dataset.estado   = estado;
    el.dataset.numero   = m.numero;
    el.dataset.pedidoId = pedido?.id || '';
    el.dataset.total    = total;

    el.innerHTML = `
      <div class="mesa-wrap">
        <div class="mesa-chair n"></div>
        <div class="mesa-chair e"></div>
        <div class="mesa-chair s"></div>
        <div class="mesa-chair w"></div>
        <div class="mesa-circle">
          <span class="mesa-floor-num">${m.numero}</span>
          <span class="mesa-floor-dot"></span>
        </div>
        <button class="mesa-floor-del" onclick="eliminarMesa(event,'${m.id}','${estado}')">√ó</button>
      </div>
      <div class="mesa-floor-label">${estado === 'libre' ? 'Libre' : fmt(total)}</div>`;

    // Hover ‚Üí burbuja
    el.addEventListener('mouseenter', () =>
      hoverMesa(m.id, m.numero, estado, pedido?.id || '', total));
    el.addEventListener('mouseleave', schedBubbleHide);

    // Click ‚Üí abrir POS (solo sin arrastre)
    el.addEventListener('click', () => {
      if (el.classList.contains('did-drag')) { el.classList.remove('did-drag'); return; }
      abrirMesa(m.id, estado, m.numero);
    });

    initMesaDrag(el, m.id);
    grid.appendChild(el);
  });
}

/* ‚îÄ‚îÄ Edit mode ‚îÄ‚îÄ */
let EDIT_MODE = false;
function toggleEditMode() {
  EDIT_MODE = !EDIT_MODE;
  const canvas = document.getElementById('mesasCanvas');
  const btn    = document.getElementById('btnEditMode');
  canvas.classList.toggle('edit-mode', EDIT_MODE);
  btn.classList.toggle('active', EDIT_MODE);
  btn.innerHTML = EDIT_MODE ? '‚úì Guardar distribuci√≥n' : '‚ú¶ Mover mesas';

  // Hint banner
  let hint = canvas.querySelector('.floor-edit-hint');
  if (EDIT_MODE) {
    if (!hint) {
      hint = document.createElement('div');
      hint.className = 'floor-edit-hint';
      hint.textContent = '‚ú¶ Arrastra las mesas a la posici√≥n de tu restaurante';
      canvas.appendChild(hint);
    }
  } else {
    hint?.remove();
  }
}

/* ‚îÄ‚îÄ Drag & drop: mueve left/top en tiempo real con el cursor ‚îÄ‚îÄ */
function initMesaDrag(el, mesaId) {
  let dragging = false;
  let offsetX  = 0; // cursor offset dentro del elemento
  let offsetY  = 0;

  function client(e) { return e.touches ? e.touches[0] : e; }

  function onDown(e) {
    if (!EDIT_MODE) return;
    e.preventDefault();
    e.stopPropagation();
    dragging = true;
    el.classList.add('is-dragging');

    const canvas = document.getElementById('mesasCanvas');
    const cRect  = canvas.getBoundingClientRect();
    const eRect  = el.getBoundingClientRect();
    const c      = client(e);

    // Offset: d√≥nde est√° el cursor dentro del elemento
    offsetX = c.clientX - eRect.left;
    offsetY = c.clientY - eRect.top;

    // Convertir posici√≥n actual a px para trabajar en px
    el.style.left = (eRect.left - cRect.left) + 'px';
    el.style.top  = (eRect.top  - cRect.top)  + 'px';
  }

  function onMove(e) {
    if (!dragging) return;
    e.preventDefault();

    const canvas = document.getElementById('mesasCanvas');
    const cRect  = canvas.getBoundingClientRect();
    const c      = client(e);

    const EW = el.offsetWidth  || 90;
    const EH = el.offsetHeight || 110;

    let newLeft = c.clientX - cRect.left - offsetX;
    let newTop  = c.clientY - cRect.top  - offsetY;

    // L√≠mites del canvas
    newLeft = Math.max(0, Math.min(newLeft, cRect.width  - EW));
    newTop  = Math.max(0, Math.min(newTop,  cRect.height - EH));

    el.style.left = newLeft + 'px';
    el.style.top  = newTop  + 'px';

    el.classList.add('did-drag');
  }

  function onUp() {
    if (!dragging) return;
    dragging = false;
    el.classList.remove('is-dragging');

    // Convertir px a % y guardar
    const canvas = document.getElementById('mesasCanvas');
    const cRect  = canvas.getBoundingClientRect();
    const pctL   = (parseFloat(el.style.left) / cRect.width  * 100).toFixed(2);
    const pctT   = (parseFloat(el.style.top)  / cRect.height * 100).toFixed(2);

    el.style.left = pctL + '%';
    el.style.top  = pctT + '%';

    saveMesaPos(mesaId, parseFloat(pctL), parseFloat(pctT));
  }

  el.addEventListener('mousedown',  onDown, { capture: true });
  el.addEventListener('touchstart', onDown, { passive: false, capture: true });
  window.addEventListener('mousemove', onMove);
  window.addEventListener('touchmove', onMove, { passive: false });
  window.addEventListener('mouseup',  onUp);
  window.addEventListener('touchend', onUp);
}

async function crearMesa() {
  const { data: existentes } = await _sb.from('mesas').select('numero').eq('user_id', USER_ID);
  const nums = existentes?.map(m => m.numero) || [];
  let sig = 1;
  while (nums.includes(sig)) sig++;

  const { error } = await _sb.from('mesas').insert({ user_id: USER_ID, numero: sig, estado: 'libre' });
  if (error) { toast('Error al crear mesa'); return; }
  toast(`‚úì Mesa ${sig} creada`);
  cargarMesas();
}

async function eliminarMesa(e, mesaId, estado) {
  e.stopPropagation();
  if (estado === 'ocupada') { toast('‚ö†Ô∏è Cierra el pedido antes de eliminar'); return; }
  if (!confirm('¬øEliminar esta mesa?')) return;
  await _sb.from('mesas').delete().eq('id', mesaId);
  toast('Mesa eliminada');
  cargarMesas();
}

async function abrirMesa(mesaId, estado, numero) {
  MESA_ID  = mesaId;
  MESA_NUM = numero;
  PEDIDO_ID = null; PEDIDO_ITEMS = []; PEDIDO_TOTAL = 0;

  // Mostrar vista inmediatamente (optimistic)
  document.getElementById('posMesaTitle').textContent = `Mesa ${numero}`;
  POS_CAT = 'all';
  document.getElementById('posSearch').value = '';
  renderPosCats();
  renderPosProds();
  renderPosOrder();
  ocultarBurbuja();
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.getElementById('view-pos-mesa').classList.add('active');
  VIEW_ACTUAL = 'pos-mesa';

  if (estado === 'libre') {
    // INSERT pedido y UPDATE mesa en paralelo
    const [{ data: pedido, error }] = await Promise.all([
      _sb.from('pedidos').insert({ user_id: USER_ID, mesa_id: mesaId, estado: 'abierto', total: 0 }).select().single(),
      _sb.from('mesas').update({ estado: 'ocupada' }).eq('id', mesaId)
    ]);
    if (error || !pedido) { toast('Error al abrir mesa'); return; }
    PEDIDO_ID = pedido.id;
    cargarMesas(); // refrescar grid en fondo
    // Mesa nueva = pedido vac√≠o, no hay items que cargar
  } else {
    // Obtener pedido abierto
    const { data: pedido } = await _sb
      .from('pedidos').select('id, total')
      .eq('mesa_id', mesaId).eq('estado', 'abierto').single();
    if (!pedido) { toast('No se encontr√≥ el pedido activo'); return; }
    PEDIDO_ID = pedido.id;
    // Cargar items del pedido (ya en la vista)
    await recargarPedido();
  }
}

async function recargarPedido() {
  const { data: items } = await _sb
    .from('pedido_items')
    .select('*')
    .eq('pedido_id', PEDIDO_ID)
    .order('created_at');

  PEDIDO_ITEMS = items || [];
  PEDIDO_TOTAL = PEDIDO_ITEMS.reduce((a, i) => a + i.precio * i.cantidad, 0);
  renderPosOrder();
}

async function quitarItem(itemId) {
  await _sb.from('pedido_items').delete().eq('id', itemId);
  await recalcularTotal();
  await recargarPedido();
}

async function recalcularTotal() {
  const { data: items } = await _sb.from('pedido_items').select('precio, cantidad').eq('pedido_id', PEDIDO_ID);
  const total = items?.reduce((a, i) => a + i.precio * i.cantidad, 0) || 0;
  await _sb.from('pedidos').update({ total }).eq('id', PEDIDO_ID);
  PEDIDO_TOTAL = total;
}

function cerrarPedido() {
  PEDIDO_ID = null; MESA_ID = null; MESA_NUM = null; PEDIDO_ITEMS = []; PEDIDO_TOTAL = 0;
}

function closePedidoOnBg(e) { if (e.target.id === 'pedidoOverlay') cerrarPedido(); }

function volverAMesas() {
  PEDIDO_ID = null; MESA_ID = null; MESA_NUM = null; PEDIDO_ITEMS = []; PEDIDO_TOTAL = 0;
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.getElementById('view-mesas').classList.add('active');
  VIEW_ACTUAL = 'mesas';
  // Reactivar tab mesas en nav
  document.querySelectorAll('.nav-tab').forEach((t, i) => t.classList.toggle('active', i === 0));
  document.querySelectorAll('.bnav-btn').forEach((t, i) => t.classList.toggle('active', i === 0));
  cargarMesas();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MESA BUBBLE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function hoverMesa(mesaId, num, estado, pedidoId, total) {
  clearBubbleTimer();
  // Si es otra mesa, resetear items cargados
  if (BUBBLE_ID !== mesaId) { BUBBLE_LOADED = false; }

  BUBBLE_ID     = mesaId;
  BUBBLE_NUM    = num;
  BUBBLE_ESTADO = estado;
  BUBBLE_PED_ID = pedidoId;
  BUBBLE_TOTAL  = total;

  const bubble = document.getElementById('mesaBubble');
  document.getElementById('mbBarMesa').textContent = `Mesa ${num}`;
  document.getElementById('mbIcon').textContent    = estado === 'libre' ? 'ü™ë' : 'üçΩÔ∏è';

  if (estado === 'libre') {
    document.getElementById('mbBarSub').textContent    = 'Libre ¬∑ toca para abrir';
    document.getElementById('mbBarTotal').textContent  = '';
    document.getElementById('mbBtnComanda').style.display = 'none';
    document.getElementById('mbPanelTitle').textContent   = 'Mesa libre';
    document.getElementById('mbTotalVal').textContent     = '$ 0';
    document.getElementById('mbItemsList').innerHTML      =
      '<div class="mb-msg">Mesa disponible. Toca para iniciar un pedido.</div>';
  } else {
    document.getElementById('mbBarSub').textContent   = 'Ocupada ¬∑ pasa el cursor para ver';
    document.getElementById('mbBarTotal').textContent = fmt(total);
    document.getElementById('mbBtnComanda').style.display = '';
    document.getElementById('mbPanelTitle').textContent   = `Pedido ¬∑ Mesa ${num}`;
    document.getElementById('mbTotalVal').textContent     = fmt(total);
    // Cargar √≠tems en fondo
    if (!BUBBLE_LOADED) cargarItemsBurbuja();
  }

  bubble.classList.add('visible');
}

function schedBubbleHide() {
  clearBubbleTimer();
  _bubbleTimer = setTimeout(() => {
    const b = document.getElementById('mesaBubble');
    if (!b.classList.contains('pinned')) b.classList.remove('visible');
  }, 350);
}

function clearBubbleTimer() {
  if (_bubbleTimer) { clearTimeout(_bubbleTimer); _bubbleTimer = null; }
}

async function cargarItemsBurbuja() {
  if (!BUBBLE_PED_ID || BUBBLE_ESTADO === 'libre') return;
  BUBBLE_LOADED = true;
  document.getElementById('mbItemsList').innerHTML = '<div class="mb-msg">Cargando √≠tems...</div>';

  const { data: items } = await _sb
    .from('pedido_items').select('*')
    .eq('pedido_id', BUBBLE_PED_ID).order('created_at');

  if (!items?.length) {
    document.getElementById('mbItemsList').innerHTML = '<div class="mb-msg">Sin √≠tems a√∫n</div>';
    return;
  }
  document.getElementById('mbItemsList').innerHTML = items.map(i => `
    <div class="mb-item">
      <div class="mb-item-emoji">${i.emoji || 'üçΩÔ∏è'}</div>
      <div class="mb-item-info">
        <div class="mb-item-name">${i.nombre}</div>
        <div class="mb-item-qty">${i.cantidad} √ó ${fmt(i.precio)}</div>
      </div>
      <div class="mb-item-price">${fmt(i.precio * i.cantidad)}</div>
    </div>`).join('');
}

function pinBurbuja(e) {
  if (e.target.closest('.btn-abrir-pos')) return;
  const b = document.getElementById('mesaBubble');
  b.classList.toggle('pinned');
  // Cargar √≠tems si a√∫n no se han cargado al pinar
  if (b.classList.contains('pinned') && !BUBBLE_LOADED && BUBBLE_ESTADO === 'ocupada') {
    cargarItemsBurbuja();
  }
}

async function abrirBurbuja() {
  if (!BUBBLE_ID) return;
  document.getElementById('mesaBubble').classList.remove('visible', 'pinned');
  clearBubbleTimer();
  await abrirMesa(BUBBLE_ID, BUBBLE_ESTADO, BUBBLE_NUM);
}

function cmdBurbuja() {
  if (!BUBBLE_PED_ID) return;
  // Sincronizar estado global para mostrarComanda
  PEDIDO_ID    = BUBBLE_PED_ID;
  MESA_ID      = BUBBLE_ID;
  MESA_NUM     = BUBBLE_NUM;
  // Leer √≠tems del DOM de la burbuja (ya est√°n cargados)
  const items = [];
  document.querySelectorAll('#mbItemsList .mb-item').forEach(el => {
    const name  = el.querySelector('.mb-item-name')?.textContent || '';
    const qtyTxt = el.querySelector('.mb-item-qty')?.textContent || '';
    const qty   = parseInt(qtyTxt) || 1;
    items.push({ nombre: name, cantidad: qty, emoji: el.querySelector('.mb-item-emoji')?.textContent || 'üçΩÔ∏è' });
  });
  PEDIDO_ITEMS = items;
  mostrarComanda();
}

// Ocultar burbuja al entrar a la vista POS
function ocultarBurbuja() {
  document.getElementById('mesaBubble').classList.remove('visible', 'pinned');
  clearBubbleTimer();
}

// Click fuera de la burbuja ‚Üí despinar
document.addEventListener('click', e => {
  const b = document.getElementById('mesaBubble');
  if (b?.classList.contains('pinned') && !b.contains(e.target)) b.classList.remove('pinned');
});

function renderPosCats() {
  const cats = [{ id: 'all', nombre: 'Todos', icon: 'üè™' }, ...CATEGORIAS];
  document.getElementById('posCatsBar').innerHTML = cats.map(c => `
    <button class="pos-cat-btn ${POS_CAT === c.id ? 'active' : ''}" onclick="setPosCat('${c.id}')">
      ${c.icon || ''} ${c.nombre}
    </button>`).join('');
}

function setPosCat(catId) {
  POS_CAT = catId;
  renderPosCats();
  renderPosProds();
}

function renderPosProds() {
  const q = (document.getElementById('posSearch').value || '').toLowerCase();
  const prods = PRODUCTOS.filter(p => {
    const matchCat = POS_CAT === 'all' || p.categoria === POS_CAT;
    const matchQ   = !q || p.nombre.toLowerCase().includes(q);
    return matchCat && matchQ;
  });
  const grid = document.getElementById('posProdsGrid');
  if (!prods.length) {
    grid.innerHTML = '<div style="padding:24px;text-align:center;color:var(--muted);grid-column:1/-1">Sin productos</div>';
    return;
  }
  grid.innerHTML = prods.map(p => `
    <div class="pos-prod-card" onclick="agregarPosItem('${p.id}')">
      <span class="pos-prod-emoji">${p.emoji || 'üçΩÔ∏è'}</span>
      <div class="pos-prod-name">${p.nombre}</div>
      <div class="pos-prod-price">${fmt(p.precio)}</div>
    </div>`).join('');
}

async function agregarPosItem(prodId) {
  const prod = PRODUCTOS.find(p => p.id === prodId);
  if (!prod) return;
  const ok = await agregarItemAPedido(prod);
  if (ok) {
    await recargarPedido();
    // Feedback visual en la tarjeta
    toast(`‚úì ${prod.nombre}`);
  }
}

function renderPosOrder() {
  document.getElementById('posTotalVal').textContent = fmt(PEDIDO_TOTAL);
  const container = document.getElementById('posOrderItems');
  if (!PEDIDO_ITEMS.length) {
    container.innerHTML = '<div class="pos-order-empty">Toca un producto para agregarlo</div>';
    return;
  }
  container.innerHTML = PEDIDO_ITEMS.map(i => `
    <div class="pos-order-item">
      <span class="poi-emoji">${i.emoji || 'üçΩÔ∏è'}</span>
      <div class="poi-info">
        <div class="poi-name">${i.nombre}</div>
        <div class="poi-qty">${i.cantidad} √ó ${fmt(i.precio)}</div>
      </div>
      <span class="poi-price">${fmt(i.precio * i.cantidad)}</span>
      <button class="poi-del" onclick="quitarItem('${i.id}')">√ó</button>
    </div>`).join('');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SELECTOR DE ITEMS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function abrirSelectorItems() {
  ITEMS_CONTEXT = 'mesa';
  ITEMS_CAT = 'all';
  document.getElementById('itemsTitle').textContent = `Agregar a Mesa ${MESA_NUM}`;
  document.getElementById('itemsSearch').value = '';
  renderCatsItems();
  renderItemsGrid();
  document.getElementById('itemsOverlay').classList.add('open');
}

function abrirSelectorItemsDom() {
  ITEMS_CONTEXT = 'dom';
  ITEMS_CAT = 'all';
  document.getElementById('itemsTitle').textContent = 'Agregar al domicilio';
  document.getElementById('itemsSearch').value = '';
  renderCatsItems();
  renderItemsGrid();
  document.getElementById('itemsOverlay').classList.add('open');
}

function cerrarSelectorItems() {
  document.getElementById('itemsOverlay').classList.remove('open');
  if (ITEMS_CONTEXT === 'mesa') recargarPedido();
  if (ITEMS_CONTEXT === 'dom')  renderDomItems();
  ITEMS_CONTEXT = null;
}

function renderCatsItems() {
  const cats = [{ id: 'all', nombre: 'Todos', icon: 'üè™' }, ...CATEGORIAS];
  document.getElementById('itemsCats').innerHTML = cats.map(c => `
    <div class="items-cat ${ITEMS_CAT === c.id ? 'active' : ''}" onclick="setItemsCat('${c.id}')">
      ${c.icon || ''} ${c.nombre}
    </div>`).join('');
}

function setItemsCat(id) { ITEMS_CAT = id; renderCatsItems(); renderItemsGrid(); }

function renderItemsGrid() {
  const q = document.getElementById('itemsSearch').value.toLowerCase();
  let prods = PRODUCTOS.filter(p => {
    const matchQ   = !q || p.nombre.toLowerCase().includes(q);
    const matchCat = ITEMS_CAT === 'all' || p.categoria === ITEMS_CAT;
    return matchQ && matchCat;
  });

  const grid = document.getElementById('itemsGrid');
  if (!prods.length) {
    grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--muted)">Sin productos</div>';
    return;
  }
  grid.innerHTML = prods.map(p => `
    <div class="item-card" onclick="agregarItemAlContexto('${p.id}')">
      <span class="item-emoji">${p.emoji || 'üçΩÔ∏è'}</span>
      <div class="item-name">${p.nombre}</div>
      <div class="item-price">${fmt(p.precio)}</div>
    </div>`).join('');
}

async function agregarItemAlContexto(prodId) {
  const prod = PRODUCTOS.find(p => p.id === prodId);
  if (!prod) return;

  if (ITEMS_CONTEXT === 'mesa') {
    const ok = await agregarItemAPedido(prod);
    if (ok) toast(`‚úì ${prod.nombre} agregado`);
  } else if (ITEMS_CONTEXT === 'dom') {
    const ex = DOM_ITEMS.find(i => i.producto_id === prodId);
    if (ex) { ex.cantidad++; }
    else {
      DOM_ITEMS.push({
        producto_id: prodId,
        nombre: prod.nombre,
        emoji: prod.emoji || 'üçΩÔ∏è',
        precio: prod.precio,
        cantidad: 1
      });
    }
    DOM_TOTAL = DOM_ITEMS.reduce((a, i) => a + i.precio * i.cantidad, 0);
    toast(`‚úì ${prod.nombre} agregado`);
  }
}

async function agregarItemAPedido(prod) {
  if (!PEDIDO_ID) { toast('‚ö†Ô∏è Error: no hay pedido activo'); return false; }

  // Verificar si el √≠tem ya existe en el pedido
  const { data: existente, error: errBuscar } = await _sb
    .from('pedido_items')
    .select('id, cantidad')
    .eq('pedido_id', PEDIDO_ID)
    .eq('nombre', prod.nombre)
    .maybeSingle();

  if (existente) {
    const { error } = await _sb.from('pedido_items')
      .update({ cantidad: existente.cantidad + 1 })
      .eq('id', existente.id);
    if (error) { toast('‚ùå Error al actualizar: ' + error.message); return false; }
  } else {
    const { error } = await _sb.from('pedido_items').insert({
      pedido_id: PEDIDO_ID,
      nombre: prod.nombre,
      emoji: prod.emoji || 'üçΩÔ∏è',
      precio: prod.precio,
      cantidad: 1
    });
    if (error) { toast('‚ùå Error al agregar: ' + error.message); return false; }
  }
  await recalcularTotal();
  return true;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   COMANDA
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function mostrarComanda() {
  if (!PEDIDO_ITEMS.length) { toast('‚ö†Ô∏è No hay √≠tems en el pedido'); return; }
  const hora  = new Date().toLocaleTimeString('es-CO', { hour: '2-digit', minute: '2-digit' });
  const fecha = new Date().toLocaleDateString('es-CO');

  document.getElementById('comandaTicket').innerHTML = `
    <h4>Mesa ${MESA_NUM}</h4>
    <div class="comanda-meta">${fecha} ‚Äî ${hora}</div>
    <ul class="comanda-ul">
      ${PEDIDO_ITEMS.map(i => `<li><span>${i.cantidad}√ó ${i.nombre}</span></li>`).join('')}
    </ul>`;

  abrirOverlay('comandaOverlay');
}

function imprimirComanda() {
  const html = document.getElementById('comandaTicket').innerHTML;
  const w = window.open('', '_blank', 'width=320,height=500');
  w.document.write(`<!DOCTYPE html><html><head><title>Comanda</title>
    <style>
      body { font-family: 'Courier New', monospace; font-size: 14px; padding: 12px; }
      h4 { text-align: center; font-size: 18px; border-bottom: 1px dashed #999; padding-bottom: 8px; margin-bottom: 8px; }
      .comanda-meta { text-align: center; font-size: 11px; color: #666; margin-bottom: 12px; }
      ul { list-style: none; padding: 0; }
      li { display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px dotted #eee; }
    </style></head><body>${html}</body></html>`);
  w.document.close();
  w.focus();
  w.print();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   COBRO
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function abrirCobro() {
  COBRO_MODE = 'completo';
  DIVISIONES = [];
  document.getElementById('cobroTitle').textContent  = `Cobrar Mesa ${MESA_NUM}`;
  document.getElementById('cobroTotalVal').textContent = fmt(PEDIDO_TOTAL);
  document.getElementById('optCompleto').classList.add('active');
  document.getElementById('optDividir').classList.remove('active');
  document.getElementById('cobro-panel-dividir').style.display = 'none';
  document.getElementById('divisionesList').innerHTML = '';
  abrirOverlay('cobroOverlay');
}

function setCobroMode(mode) {
  COBRO_MODE = mode;
  document.getElementById('optCompleto').classList.toggle('active', mode === 'completo');
  document.getElementById('optDividir').classList.toggle('active', mode === 'dividir');
  document.getElementById('cobro-panel-dividir').style.display = mode === 'dividir' ? 'block' : 'none';
  if (mode === 'dividir' && !DIVISIONES.length) agregarDivision();
}

function agregarDivision() {
  DIVISIONES.push(0);
  renderDivisiones();
}

function renderDivisiones() {
  document.getElementById('divisionesList').innerHTML = DIVISIONES.map((v, i) => `
    <div class="division-row">
      <span class="division-label">Persona ${i + 1}</span>
      <input class="division-input" type="number" value="${v || ''}"
             placeholder="$ monto" oninput="updDivision(${i}, this.value)">
    </div>`).join('');
  actualizarFaltante();
}

function updDivision(i, val) {
  DIVISIONES[i] = parseFloat(val) || 0;
  actualizarFaltante();
}

function actualizarFaltante() {
  const pagado   = DIVISIONES.reduce((a, v) => a + v, 0);
  const faltante = PEDIDO_TOTAL - pagado;
  const el = document.getElementById('cobroFaltante');
  el.textContent  = fmt(Math.max(0, faltante));
  el.style.color  = faltante <= 0 ? 'var(--green)' : 'var(--red)';
}

async function confirmarCobro() {
  if (COBRO_MODE === 'dividir') {
    const pagado   = DIVISIONES.reduce((a, v) => a + v, 0);
    if (pagado < PEDIDO_TOTAL - 1) { toast('‚ö†Ô∏è El monto no cubre el total'); return; }
  }

  const btn = document.getElementById('btnConfirmarCobro');
  btn.disabled  = true;
  btn.innerHTML = '<span class="loading-spinner"></span>Procesando...';

  try {
    // Registrar venta
    await _sb.from('ventas').insert({
      id: genId(),
      orden: String(Math.floor(Math.random() * 9000) + 1000),
      items: JSON.stringify(PEDIDO_ITEMS),
      subtotal: PEDIDO_TOTAL,
      iva: 0,
      total: PEDIDO_TOTAL,
      metodo: 'efectivo',
      user_id: USER_ID
    });

    // Cerrar pedido
    await _sb.from('pedidos').update({
      estado: 'cobrado',
      cerrado_en: new Date().toISOString()
    }).eq('id', PEDIDO_ID);

    // Liberar mesa
    await _sb.from('mesas').update({ estado: 'libre' }).eq('id', MESA_ID);

    cerrarOverlay('cobroOverlay');
    toast(`‚úì Pago registrado ‚Äî ${fmt(PEDIDO_TOTAL)}`);
    volverAMesas();
  } catch (e) {
    toast('Error al procesar el pago');
  } finally {
    btn.disabled  = false;
    btn.innerHTML = '‚úì Confirmar pago';
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   DOMICILIOS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function cargarDomicilios() {
  const hoy = todayStr();
  const { data: doms } = await _sb
    .from('domicilios')
    .select('*, pedidos(total)')
    .eq('user_id', USER_ID)
    .gte('created_at', hoy + 'T00:00:00')
    .order('created_at', { ascending: false });

  const list = document.getElementById('domiciliosList');
  if (!doms?.length) {
    list.innerHTML = '<div class="empty-state"><span class="es-icon">üõµ</span>No hay domicilios hoy</div>';
    return;
  }

  const estadoOpts = ['pendiente','en_camino','entregado'].map(e =>
    `<option value="${e}">${e.replace('_',' ')}</option>`
  ).join('');

  list.innerHTML = doms.map(d => `
    <div class="domicilio-card">
      <div class="dom-icon">üõµ</div>
      <div class="dom-info">
        <div class="dom-nombre">${d.cliente_nombre}</div>
        <div class="dom-dir">${d.cliente_direccion}</div>
        <div class="dom-total">${d.pedidos?.total != null ? fmt(d.pedidos.total) : '‚Äî'}</div>
      </div>
      <select class="dom-status-sel" onchange="cambiarEstadoDom('${d.id}', this.value)">
        ${['pendiente','en_camino','entregado'].map(e =>
          `<option value="${e}" ${d.estado === e ? 'selected' : ''}>${e.replace('_',' ')}</option>`
        ).join('')}
      </select>
    </div>`).join('');
}

function abrirFormDomicilio() {
  DOM_ITEMS = [];
  DOM_TOTAL = 0;
  document.getElementById('domNombre').value = '';
  document.getElementById('domDir').value    = '';
  renderDomItems();
  abrirOverlay('domicilioOverlay');
}

function renderDomItems() {
  document.getElementById('domTotalVal').textContent = fmt(DOM_TOTAL);
  const list = document.getElementById('domItemsList');
  if (!DOM_ITEMS.length) {
    list.innerHTML = '<div style="color:var(--muted);font-size:13px;padding:8px 0">Sin √≠tems a√∫n</div>';
    return;
  }
  list.innerHTML = DOM_ITEMS.map((i, idx) => `
    <div class="pedido-item">
      <span class="pi-emoji">${i.emoji}</span>
      <div class="pi-info">
        <div class="pi-nombre">${i.nombre}</div>
        <div class="pi-qty">${i.cantidad} √ó ${fmt(i.precio)}</div>
      </div>
      <span class="pi-precio">${fmt(i.precio * i.cantidad)}</span>
      <button style="background:none;border:none;cursor:pointer;color:var(--red);font-size:16px;padding:4px"
              onclick="quitarItemDom(${idx})">√ó</button>
    </div>`).join('');
}

function quitarItemDom(idx) {
  DOM_ITEMS.splice(idx, 1);
  DOM_TOTAL = DOM_ITEMS.reduce((a, i) => a + i.precio * i.cantidad, 0);
  renderDomItems();
}

async function crearDomicilio() {
  const nombre = document.getElementById('domNombre').value.trim();
  const dir    = document.getElementById('domDir').value.trim();
  if (!nombre || !dir) { toast('‚ö†Ô∏è Nombre y direcci√≥n son requeridos'); return; }
  if (!DOM_ITEMS.length) { toast('‚ö†Ô∏è Agrega al menos un √≠tem'); return; }

  // Crear pedido
  const { data: pedido, error: pe } = await _sb
    .from('pedidos')
    .insert({ user_id: USER_ID, estado: 'abierto', total: DOM_TOTAL })
    .select().single();
  if (pe) { toast('Error al crear pedido'); return; }

  // Insertar items
  await _sb.from('pedido_items').insert(
    DOM_ITEMS.map(i => ({ ...i, pedido_id: pedido.id }))
  );

  // Actualizar total
  await _sb.from('pedidos').update({ total: DOM_TOTAL, estado: 'cobrado', cerrado_en: new Date().toISOString() }).eq('id', pedido.id);

  // Registrar venta
  await _sb.from('ventas').insert({
    id: genId(), orden: String(Math.floor(Math.random() * 9000) + 1000),
    items: JSON.stringify(DOM_ITEMS), subtotal: DOM_TOTAL, iva: 0,
    total: DOM_TOTAL, metodo: 'domicilio', user_id: USER_ID
  });

  // Crear domicilio
  await _sb.from('domicilios').insert({
    user_id: USER_ID, cliente_nombre: nombre,
    cliente_direccion: dir, pedido_id: pedido.id, estado: 'pendiente'
  });

  cerrarOverlay('domicilioOverlay');
  cargarDomicilios();
  toast(`‚úì Domicilio creado para ${nombre}`);
}

async function cambiarEstadoDom(domId, estado) {
  await _sb.from('domicilios').update({ estado }).eq('id', domId);
  toast(`Estado actualizado: ${estado.replace('_', ' ')}`);
}

function closeDomOnBg(e) { if (e.target.id === 'domicilioOverlay') cerrarOverlay('domicilioOverlay'); }

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MEN√ö (PRODUCTOS)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function cargarProductos() {
  const [{ data: cats }, { data: prods }] = await Promise.all([
    _sb.from('categorias').select('*').eq('user_id', USER_ID).order('created_at'),
    _sb.from('productos').select('*').eq('user_id', USER_ID).order('created_at')
  ]);
  CATEGORIAS = cats || [];
  PRODUCTOS  = (prods || []).map(p => ({
    id: p.id, nombre: p.nombre, precio: p.precio,
    emoji: p.emoji || 'üçΩÔ∏è', categoria: p.categoria || 'general',
    stock: p.stock || 0
  }));
  renderMenu();
}

function renderMenu() {
  const q = (document.getElementById('menuSearch')?.value || '').toLowerCase();
  const prods = PRODUCTOS.filter(p => !q || p.nombre.toLowerCase().includes(q));
  const grid  = document.getElementById('menuGrid');

  if (!prods.length) {
    grid.innerHTML = '<div class="empty-state"><span class="es-icon">üç±</span>No hay productos a√∫n</div>';
    return;
  }
  grid.innerHTML = prods.map(p => `
    <div class="prod-card">
      <span class="prod-emoji">${p.emoji}</span>
      <div class="prod-nombre">${p.nombre}</div>
      <div class="prod-precio">${fmt(p.precio)}</div>
      <div class="prod-actions">
        <button class="prod-btn prod-btn-edit" onclick="editarProducto('${p.id}')">‚úèÔ∏è Editar</button>
        <button class="prod-btn prod-btn-del"  onclick="eliminarProducto('${p.id}')">üóëÔ∏è</button>
      </div>
    </div>`).join('');
}

function abrirFormProducto(id) {
  PROD_EDIT_ID = id || null;
  const prod = id ? PRODUCTOS.find(p => p.id === id) : null;
  document.getElementById('prodModalTitle').textContent = prod ? 'Editar producto' : 'Nuevo producto';
  document.getElementById('prodEmoji').value  = prod?.emoji  || '';
  document.getElementById('prodNombre').value = prod?.nombre || '';
  document.getElementById('prodPrecio').value = prod?.precio || '';

  // Poblar categor√≠as
  const cats = [{ id: 'general', nombre: 'General' }, ...CATEGORIAS];
  document.getElementById('prodCat').innerHTML = cats.map(c =>
    `<option value="${c.id}" ${(prod?.categoria === c.id) ? 'selected' : ''}>${c.nombre}</option>`
  ).join('');

  abrirOverlay('productoOverlay');
}

function editarProducto(id) { abrirFormProducto(id); }

async function guardarProducto() {
  const emoji  = document.getElementById('prodEmoji').value.trim() || 'üçΩÔ∏è';
  const nombre = document.getElementById('prodNombre').value.trim();
  const precio = parseFloat(document.getElementById('prodPrecio').value);
  const cat    = document.getElementById('prodCat').value;

  if (!nombre)    { toast('‚ö†Ô∏è Escribe el nombre'); return; }
  if (isNaN(precio) || precio <= 0) { toast('‚ö†Ô∏è Precio inv√°lido'); return; }

  if (PROD_EDIT_ID) {
    await _sb.from('productos').update({
      nombre, precio, emoji, categoria: cat
    }).eq('id', PROD_EDIT_ID).eq('user_id', USER_ID);
    toast('‚úì Producto actualizado');
  } else {
    const id = genId();
    await _sb.from('productos').insert({
      id, nombre, precio, emoji, categoria: cat,
      costo: 0, stock: 0, descuento: 0, user_id: USER_ID
    });
    toast('‚úì Producto creado');
  }

  cerrarOverlay('productoOverlay');
  await cargarProductos();
}

async function eliminarProducto(id) {
  if (!confirm('¬øEliminar este producto?')) return;
  await _sb.from('productos').delete().eq('id', id);
  toast('Producto eliminado');
  await cargarProductos();
}

function closeProdOnBg(e) { if (e.target.id === 'productoOverlay') cerrarOverlay('productoOverlay'); }

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   REPORTES
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function cargarReportes() {
  const hoy   = todayStr();
  const semana = new Date();
  semana.setDate(semana.getDate() - 7);
  const semanaStr = semana.toISOString().split('T')[0];

  const [{ data: ventasHoy }, { data: ventasSemana }, { data: doms }, { data: mesas }] = await Promise.all([
    _sb.from('ventas').select('total').eq('user_id', USER_ID).gte('created_at', hoy + 'T00:00:00'),
    _sb.from('ventas').select('total').eq('user_id', USER_ID).gte('created_at', semanaStr + 'T00:00:00'),
    _sb.from('domicilios').select('id').eq('user_id', USER_ID).gte('created_at', hoy + 'T00:00:00'),
    _sb.from('mesas').select('estado').eq('user_id', USER_ID).eq('estado', 'ocupada')
  ]);

  const sumHoy    = ventasHoy?.reduce((a, v) => a + (v.total || 0), 0) || 0;
  const sumSemana = ventasSemana?.reduce((a, v) => a + (v.total || 0), 0) || 0;

  document.getElementById('rVentasHoy').textContent   = fmt(sumHoy);
  document.getElementById('rCantHoy').textContent     = `${ventasHoy?.length || 0} pedidos`;
  document.getElementById('rVentasSemana').textContent = fmt(sumSemana);
  document.getElementById('rCantSemana').textContent   = `${ventasSemana?.length || 0} pedidos`;
  document.getElementById('rDomHoy').textContent      = doms?.length || 0;
  document.getElementById('rMesasActivas').textContent = mesas?.length || 0;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   INIT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
(async () => {
  const { data: { session } } = await _sb.auth.getSession();
  if (!session?.user) {
    window.location.href = 'index.html';
    return;
  }

  USER_ID   = session.user.id;
  USER_NAME = session.user.email.split('@')[0];

  document.getElementById('userName').textContent   = USER_NAME;
  document.getElementById('userAvatar').textContent  = USER_NAME.charAt(0).toUpperCase();

  // Verificar perfil y cargar datos en paralelo
  const [{ data: perfil }] = await Promise.all([
    _sb.from('perfiles').select('tipo_negocio').eq('id', USER_ID).maybeSingle(),
    cargarProductos(),
    cargarMesas()
  ]);
  if (perfil && perfil.tipo_negocio !== 'restaurante') {
    window.location.href = 'pos-tienda.html';
    return;
  }
})();
</script>
</body>
</html>
