<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FlowPOS ¬∑ Acceso</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Lato:ital,wght@0,300;0,400;0,700;0,900;1,400&family=Syne:wght@600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:         #0B0D14;
      --surface:    #12151F;
      --card:       #171B28;
      --border:     rgba(255,255,255,0.07);
      --border-hi:  rgba(91,139,217,0.45);
      --text:       #E4EBF5;
      --muted:      rgba(228,235,245,0.42);
      --blue:       #5B8BD9;
      --blue-dark:  #1E3A6E;
      --amber:      #D97706;
      --amber-dim:  rgba(217,119,6,0.12);
      --amber-glow: rgba(217,119,6,0.2);
      --green:      #10B981;
      --red:        #EF4444;
      --shadow:     0 32px 80px rgba(0,0,0,0.6), 0 4px 24px rgba(0,0,0,0.4);
      --r:          18px;
    }

    body {
      font-family: 'Lato', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      overflow: hidden;
      position: relative;
    }

    /* Ambient background */
    .bg-orb {
      position: fixed;
      border-radius: 50%;
      pointer-events: none;
      filter: blur(80px);
    }
    .bg-orb-1 {
      top: -15vh; left: -10vw;
      width: 55vw; height: 55vw;
      background: radial-gradient(circle, rgba(30,58,110,0.35) 0%, transparent 70%);
    }
    .bg-orb-2 {
      bottom: -20vh; right: -15vw;
      width: 50vw; height: 50vw;
      background: radial-gradient(circle, rgba(217,119,6,0.12) 0%, transparent 70%);
    }
    .bg-grid {
      position: fixed;
      inset: 0;
      background-image:
        linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px);
      background-size: 40px 40px;
      pointer-events: none;
    }

    /* Card */
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 24px;
      padding: 48px 44px;
      width: 100%;
      max-width: 420px;
      box-shadow: var(--shadow);
      position: relative;
      z-index: 1;
      animation: cardIn 0.55s cubic-bezier(0.22, 1, 0.36, 1) both;
    }
    @keyframes cardIn {
      from { opacity: 0; transform: translateY(28px) scale(0.96); }
      to   { opacity: 1; transform: translateY(0) scale(1); }
    }

    /* Logo */
    .logo {
      text-align: center;
      margin-bottom: 38px;
    }
    .logo-icon {
      width: 60px; height: 60px;
      background: linear-gradient(135deg, var(--blue-dark), var(--blue));
      border-radius: 18px;
      display: inline-flex; align-items: center; justify-content: center;
      font-size: 28px;
      margin-bottom: 16px;
      box-shadow: 0 8px 28px rgba(91,139,217,0.3);
    }
    .logo-wordmark {
      font-family: 'Syne', sans-serif;
      font-size: 30px;
      font-weight: 800;
      letter-spacing: -0.5px;
      color: var(--text);
      display: block;
    }
    .logo-wordmark em { font-style: normal; color: var(--amber); }
    .logo-tagline {
      font-size: 12.5px;
      color: var(--muted);
      margin-top: 5px;
      letter-spacing: 0.6px;
    }

    /* Views */
    .view { display: none; }
    .view.active {
      display: block;
      animation: viewIn 0.28s ease both;
    }
    @keyframes viewIn {
      from { opacity: 0; transform: translateX(10px); }
      to   { opacity: 1; transform: translateX(0); }
    }

    /* Form */
    .field { margin-bottom: 16px; }
    .field-label {
      display: block;
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 1px;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 7px;
    }
    .field-input {
      width: 100%;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 11px;
      padding: 12px 15px;
      font-family: 'Lato', sans-serif;
      font-size: 15px;
      color: var(--text);
      outline: none;
      transition: border-color 0.18s, background 0.18s;
    }
    .field-input:focus {
      border-color: var(--border-hi);
      background: rgba(91,139,217,0.04);
    }
    .field-input::placeholder { color: var(--muted); }

    /* Business type selector */
    .tipo-title {
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 1px;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 10px;
      display: block;
    }
    .tipo-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 22px;
    }
    .tipo-btn {
      background: var(--surface);
      border: 1.5px solid var(--border);
      border-radius: 13px;
      padding: 18px 10px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      user-select: none;
    }
    .tipo-btn:hover {
      border-color: rgba(91,139,217,0.35);
      background: rgba(91,139,217,0.05);
      transform: translateY(-1px);
    }
    .tipo-btn.sel-tienda     { border-color: var(--blue); background: rgba(91,139,217,0.1); }
    .tipo-btn.sel-restaurante { border-color: var(--amber); background: var(--amber-dim); box-shadow: 0 0 20px var(--amber-glow); }
    .tipo-btn .t-icon { font-size: 26px; display: block; margin-bottom: 7px; }
    .tipo-btn .t-name {
      font-size: 13px;
      font-weight: 700;
      letter-spacing: 0.2px;
      color: var(--text);
    }

    /* Buttons */
    .btn {
      width: 100%;
      border: none;
      border-radius: 11px;
      padding: 13px;
      font-family: 'Lato', sans-serif;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.18s;
      letter-spacing: 0.2px;
    }
    .btn-primary {
      background: linear-gradient(135deg, #1E3A6E 0%, #5B8BD9 100%);
      color: white;
      box-shadow: 0 4px 18px rgba(91,139,217,0.28);
    }
    .btn-primary:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 6px 24px rgba(91,139,217,0.38);
    }
    .btn-primary:active { transform: translateY(0); }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }

    /* Divider */
    .divider {
      position: relative;
      text-align: center;
      margin: 22px 0 18px;
    }
    .divider::before {
      content: '';
      position: absolute;
      top: 50%; left: 0; right: 0;
      height: 1px;
      background: var(--border);
    }
    .divider span {
      background: var(--card);
      padding: 0 12px;
      font-size: 11.5px;
      color: var(--muted);
      position: relative;
      letter-spacing: 0.5px;
    }

    /* Toggle */
    .toggle {
      text-align: center;
      font-size: 13px;
      color: var(--muted);
    }
    .toggle a {
      color: var(--amber);
      font-weight: 700;
      cursor: pointer;
      text-decoration: none;
    }
    .toggle a:hover { text-decoration: underline; }

    /* Error */
    .err {
      background: rgba(239,68,68,0.1);
      border: 1px solid rgba(239,68,68,0.22);
      border-radius: 9px;
      padding: 10px 14px;
      font-size: 13px;
      color: #FCA5A5;
      margin-bottom: 16px;
      display: none;
    }
    .err.on {
      display: block;
      animation: errShake 0.3s ease;
    }
    @keyframes errShake {
      0%,100% { transform: translateX(0); }
      25%      { transform: translateX(-5px); }
      75%      { transform: translateX(5px); }
    }

    /* Spinner */
    .spin {
      display: inline-block;
      width: 16px; height: 16px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spinning 0.65s linear infinite;
      vertical-align: middle;
      margin-right: 7px;
    }
    @keyframes spinning { to { transform: rotate(360deg); } }

    @media (max-width: 480px) {
      .card { padding: 32px 22px; }
    }
  </style>
</head>
<body>
  <div class="bg-orb bg-orb-1"></div>
  <div class="bg-orb bg-orb-2"></div>
  <div class="bg-grid"></div>

  <div class="card">
    <div class="logo">
      <div class="logo-icon">‚ö°</div>
      <span class="logo-wordmark">Flow<em>POS</em></span>
      <div class="logo-tagline">Sistema de punto de venta</div>
    </div>

    <!-- LOGIN -->
    <div id="v-login" class="view active">
      <div id="err-login" class="err"></div>
      <div class="field">
        <label class="field-label">Usuario</label>
        <input id="l-user" type="text" class="field-input" placeholder="tu_usuario" autocomplete="username">
      </div>
      <div class="field">
        <label class="field-label">Contrase√±a</label>
        <input id="l-pass" type="password" class="field-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
      </div>
      <button class="btn btn-primary" id="btn-login" onclick="doLogin()">Iniciar sesi√≥n</button>
      <div class="divider"><span>o</span></div>
      <div class="toggle">¬øNo tienes cuenta? <a onclick="showView('register')">Reg√≠strate gratis</a></div>
    </div>

    <!-- REGISTER -->
    <div id="v-register" class="view">
      <div id="err-reg" class="err"></div>
      <div class="field">
        <label class="field-label">Nombre del negocio</label>
        <input id="r-negocio" type="text" class="field-input" placeholder="Mi Negocio">
      </div>
      <div class="field">
        <label class="field-label">Usuario</label>
        <input id="r-user" type="text" class="field-input" placeholder="tu_usuario">
      </div>
      <div class="field">
        <label class="field-label">Contrase√±a</label>
        <input id="r-pass" type="password" class="field-input" placeholder="M√≠nimo 6 caracteres">
      </div>
      <span class="tipo-title">Tipo de negocio</span>
      <div class="tipo-grid">
        <div class="tipo-btn" id="tb-tienda" onclick="selTipo('tienda')">
          <span class="t-icon">üè™</span>
          <span class="t-name">Tienda</span>
        </div>
        <div class="tipo-btn" id="tb-restaurante" onclick="selTipo('restaurante')">
          <span class="t-icon">üçΩÔ∏è</span>
          <span class="t-name">Restaurante</span>
        </div>
      </div>
      <button class="btn btn-primary" id="btn-reg" onclick="doRegister()">Crear cuenta</button>
      <div class="divider"><span>o</span></div>
      <div class="toggle">¬øYa tienes cuenta? <a onclick="showView('login')">Inicia sesi√≥n</a></div>
    </div>
  </div>

<script>
  const SB_URL  = 'https://uegaxpaejvjjwqnyurpx.supabase.co';
  const SB_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVlZ2F4cGFlanZqandxbnl1cnB4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE3OTA5MTMsImV4cCI6MjA4NzM2NjkxM30.gtht8IbRcjzO97TymeMIOVALVRq6c38u_-JJYrWXSOk';
  const _sb     = supabase.createClient(SB_URL, SB_ANON);
  let   TIPO    = null;

  // Check existing session
  (async () => {
    const { data: { session } } = await _sb.auth.getSession();
    if (session?.user) await redirect(session.user.id);
  })();

  // Enter key
  document.addEventListener('keydown', e => {
    if (e.key !== 'Enter') return;
    if (document.getElementById('v-login').classList.contains('active')) doLogin();
    else doRegister();
  });

  function showView(name) {
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    document.getElementById('v-' + name).classList.add('active');
    document.getElementById('err-login').classList.remove('on');
    document.getElementById('err-reg').classList.remove('on');
  }

  function selTipo(t) {
    TIPO = t;
    document.getElementById('tb-tienda').className     = 'tipo-btn' + (t === 'tienda'     ? ' sel-tienda'     : '');
    document.getElementById('tb-restaurante').className = 'tipo-btn' + (t === 'restaurante' ? ' sel-restaurante' : '');
  }

  function showErr(id, msg) {
    const el = document.getElementById(id);
    el.textContent = msg;
    el.classList.add('on');
  }

  function setLoading(btnId, on, label) {
    const b = document.getElementById(btnId);
    b.disabled    = on;
    b.innerHTML   = on ? '<span class="spin"></span>Cargando...' : label;
  }

  async function redirect(uid) {
    const { data: p } = await _sb.from('perfiles').select('tipo_negocio').eq('id', uid).single();
    if (p?.tipo_negocio === 'restaurante') {
      window.location.href = 'pos-restaurante.html';
    } else {
      window.location.href = 'pos-tienda.html';
    }
  }

  async function doLogin() {
    const user = document.getElementById('l-user').value.trim().toLowerCase().replace(/\s+/g, '');
    const pass = document.getElementById('l-pass').value;
    if (!user || !pass) { showErr('err-login', 'Completa todos los campos'); return; }

    setLoading('btn-login', true, 'Iniciar sesi√≥n');
    const { data, error } = await _sb.auth.signInWithPassword({ email: user + '@flowpos.app', password: pass });
    setLoading('btn-login', false, 'Iniciar sesi√≥n');

    if (error) { showErr('err-login', 'Usuario o contrase√±a incorrectos'); return; }

    // Create perfil if it doesn't exist (backward compat for existing LikePos users)
    const { data: perfil } = await _sb.from('perfiles').select('tipo_negocio').eq('id', data.user.id).single();
    if (!perfil) {
      await _sb.from('perfiles').insert({ id: data.user.id, tipo_negocio: 'tienda', nombre_negocio: user });
    }

    await redirect(data.user.id);
  }

  async function doRegister() {
    const negocio = document.getElementById('r-negocio').value.trim();
    const user    = document.getElementById('r-user').value.trim().toLowerCase().replace(/\s+/g, '');
    const pass    = document.getElementById('r-pass').value;

    if (!negocio || !user || !pass) { showErr('err-reg', 'Completa todos los campos'); return; }
    if (!TIPO) { showErr('err-reg', 'Selecciona el tipo de negocio'); return; }
    if (pass.length < 6) { showErr('err-reg', 'La contrase√±a debe tener al menos 6 caracteres'); return; }

    setLoading('btn-reg', true, 'Crear cuenta');
    const { data, error } = await _sb.auth.signUp({ email: user + '@flowpos.app', password: pass });
    setLoading('btn-reg', false, 'Crear cuenta');

    if (error) {
      showErr('err-reg', error.message === 'User already registered' ? 'Este usuario ya existe' : error.message);
      return;
    }

    if (!data.session) {
      showErr('err-reg', 'Revisa tu correo para confirmar la cuenta antes de ingresar');
      return;
    }

    await _sb.from('perfiles').insert({ id: data.user.id, tipo_negocio: TIPO, nombre_negocio: negocio });
    await redirect(data.user.id);
  }
</script>
</body>
</html>
