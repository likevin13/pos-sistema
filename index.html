<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LikePos · Sistema POS</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Lato:ital,wght@0,300;0,400;0,700;0,900;1,400&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    /* ══ RESET ══ */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:         #E4EEF6;
      --surface:    #EEF5FB;
      --white:      #F6FAFD;
      --blue:       #4A7FA7;
      --blue-mid:   #1A3D63;
      --blue-light: #B3CFE5;
      --blue-xl:    #DCF0FA;
      --navy:       #0A1931;
      --dark:       #0A1931;
      --mid:        #1A3D63;
      --muted:      #6B9AB8;
      --border:     #B3CFE5;
      --green:      #10B981;
      --green-dim:  #ECFDF5;
      --red:        #EF4444;
      --red-dim:    #FEF2F2;
      --orange:     #F59E0B;
      --orange-dim: #FFFBEB;
      --shadow-sm:  0 1px 4px rgba(10,25,49,0.07), 0 2px 10px rgba(10,25,49,0.05);
      --shadow-md:  0 4px 16px rgba(10,25,49,0.10), 0 1px 4px rgba(10,25,49,0.06);
      --shadow-lg:  0 20px 60px rgba(10,25,49,0.18), 0 4px 16px rgba(10,25,49,0.09);
      --shadow-gold: 0 4px 24px rgba(74,127,167,0.38);
      --gold:       #4A7FA7;
      --gold-dark:  #1A3D63;
      --gold-light: #B3CFE5;
      --sand:       #B3CFE5;
      --sand-dim:   #DCF0FA;
      --r:          16px;
    }

    body {
      font-family: 'Lato', sans-serif;
      background: var(--bg);
      color: var(--dark);
      min-height: 100vh;
    }
    body::before {
      content: '';
      position: fixed; top: -200px; right: -200px;
      width: 700px; height: 700px;
      background: radial-gradient(ellipse at center, rgba(74,127,167,0.13) 0%, rgba(74,127,167,0.04) 50%, transparent 70%);
      border-radius: 50%; pointer-events: none; z-index: 0;
    }
    body::after {
      content: '';
      position: fixed; bottom: -160px; left: -160px;
      width: 600px; height: 600px;
      background: radial-gradient(ellipse at center, rgba(74,127,167,0.11) 0%, rgba(74,127,167,0.04) 50%, transparent 70%);
      border-radius: 50%; pointer-events: none; z-index: 0;
    }

    /* ══ HEADER ══ */
    .header {
      position: fixed; top: 0; left: 0; right: 0; z-index: 60;
      height: 60px;
      background: linear-gradient(135deg, #0A1931 0%, #1A3D63 100%);
      display: flex; align-items: center;
      padding: 0 20px;
      gap: 16px;
      box-shadow: 0 2px 20px rgba(10,25,49,0.45);
    }

    .logo { display: flex; align-items: center; gap: 9px; flex-shrink: 0; }
    .logo-mark {
      width: 34px; height: 34px;
      background: linear-gradient(135deg, #4A7FA7, #4A7FA7);
      border-radius: 10px; display: flex; align-items: center;
      justify-content: center; font-size: 17px;
      box-shadow: 0 3px 12px rgba(74,127,167,0.40);
    }
    .logo-name { font-family: 'Lato', sans-serif; font-size: 20px; font-weight: 700; color: white; letter-spacing: 0.2px; }
    .logo-name em { font-style: italic; color: var(--sand); }

    /* Nav tabs */
    .nav-tabs { display: flex; gap: 4px; flex: 1; }
    .nav-tab {
      display: flex; align-items: center; gap: 7px;
      padding: 8px 16px; border-radius: 10px;
      background: transparent; border: none;
      font-family: 'Lato', sans-serif; font-size: 13px; font-weight: 50000;
      color: rgba(255,255,255,0.55); cursor: pointer;
      transition: all 0.18s; white-space: nowrap;
    }
    .nav-tab:hover { background: rgba(255,255,255,0.07); color: rgba(255,255,255,0.9); }
    .nav-tab.active { background: rgba(74,127,167,0.16); color: var(--sand); font-weight: 600; box-shadow: inset 0 0 0 1px rgba(74,127,167,0.28); }
    .nav-tab svg { flex-shrink: 0; opacity: 0.8; }

    .header-right { display: flex; align-items: center; gap: 14px; margin-left: auto; flex-shrink: 0; }
    .datetime-time { font-size: 15px; font-weight: 700; color: white; letter-spacing: -0.3px; }
    .datetime-date { font-size: 10px; color: rgba(255,255,255,0.45); }

    .cashier-pill {
      display: flex; align-items: center; gap: 8px;
      background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.12);
      border-radius: 50px; padding: 5px 12px 5px 5px; cursor: pointer;
      transition: background 0.15s;
    }
    .cashier-pill:hover { background: rgba(255,255,255,0.14); }
    .cashier-av {
      width: 26px; height: 26px;
      background: linear-gradient(135deg, var(--blue), #1A3D63);
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      font-size: 10px; font-weight: 700; color: white;
    }
    .cashier-name { font-size: 12px; font-weight: 500; color: rgba(255,255,255,0.8); }

    /* ══ MAIN ══ */
    main { padding-top: 60px; min-height: 100vh; }

    .view { display: none; }
    .view.active { display: block; }

    /* ══ POS VIEW ══ */
    .pos-topbar {
      background: var(--surface); border-bottom: 1px solid rgba(205,213,219,0.6);
      padding: 12px 24px; display: flex; align-items: center; gap: 12px;
      flex-wrap: wrap; overflow: visible;
      box-shadow: 0 1px 0 rgba(10,25,49,0.04), 0 2px 12px rgba(10,25,49,0.05);
    }

    .search-box {
      display: flex; align-items: center; gap: 8px;
      background: var(--bg); border: 1.5px solid var(--border); border-radius: 50px;
      padding: 8px 16px; min-width: 220px; flex: 1; max-width: 320px;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .search-box:focus-within { border-color: var(--blue); box-shadow: 0 0 0 3px rgba(74,127,167,0.10); }
    .search-box svg { opacity: 0.4; flex-shrink: 0; }
    .search-box input { border: none; background: transparent; font-family: 'Lato', sans-serif; font-size: 13px; color: var(--dark); outline: none; width: 100%; }
    .search-box input::placeholder { color: var(--muted); }

    .cats-scroll { display: flex; gap: 8px; overflow-x: auto; overflow-y: visible; scrollbar-width: none; flex: 1; padding: 4px 2px; }
    .cats-scroll::-webkit-scrollbar { display: none; }

    .cat-pill {
      display: flex; align-items: center; gap: 7px;
      padding: 9px 18px; border: 1.5px solid rgba(205,213,219,0.7); border-radius: 50px;
      background: var(--white); font-family: 'Lato', sans-serif;
      font-size: 13px; font-weight: 400; color: var(--muted);
      cursor: pointer; white-space: nowrap; flex-shrink: 0;
      transition: all 0.18s ease; box-shadow: var(--shadow-sm);
    }
    .cat-pill:hover { border-color: rgba(74,127,167,0.45); color: var(--dark); box-shadow: var(--shadow-md); }
    .cat-pill.active { background: var(--sand-dim); border-color: var(--gold); color: var(--gold-dark); font-weight: 700; box-shadow: var(--shadow-gold); }

    /* Products */
    .products-section { padding: 18px 24px 160px; }
    .section-meta { font-size: 12px; color: var(--muted); margin-bottom: 14px; }
    .section-meta strong { color: var(--dark); }

    .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(162px, 1fr)); gap: 13px; }

    @keyframes card-enter { from { opacity: 0; transform: translateY(14px) scale(0.97); } to { opacity: 1; transform: translateY(0) scale(1); } }
    @keyframes pop { 0% { transform: scale(1); } 35% { transform: scale(0.82) rotate(-6deg); } 70% { transform: scale(1.18) rotate(4deg); } 100% { transform: scale(1); } }

    .product-card {
      background: var(--white); border-radius: 20px; padding: 20px 14px 14px;
      border: 1.5px solid rgba(74,127,167,0.10); cursor: pointer;
      transition: all 0.22s cubic-bezier(0.34, 1.56, 0.64, 1);
      box-shadow: var(--shadow-sm);
      display: flex; flex-direction: column; align-items: center;
      text-align: center; position: relative; overflow: hidden; user-select: none;
      animation: card-enter 0.4s cubic-bezier(0.22,1,0.36,1) both;
    }
    .product-card::after { content: ''; position: absolute; inset: 0; background: linear-gradient(160deg, rgba(74,127,167,0.05) 0%, rgba(227,195,157,0.08) 100%); opacity: 0; transition: opacity 0.22s; pointer-events: none; }
    .product-card:hover { border-color: rgba(74,127,167,0.40); transform: translateY(-5px); box-shadow: 0 8px 32px rgba(74,127,167,0.14), 0 2px 8px rgba(10,25,49,0.06); }
    .product-card:hover::after { opacity: 1; }
    .product-card.in-cart { border-color: var(--gold); box-shadow: 0 0 0 1px rgba(74,127,167,0.15), var(--shadow-sm); }
    .product-card.out-of-stock { opacity: 0.45; cursor: not-allowed; }
    .p-emoji.pop { animation: pop .34s cubic-bezier(0.34, 1.56, 0.64, 1); }

    .p-emoji { font-size: 46px; margin-bottom: 10px; transition: transform 0.25s cubic-bezier(0.34,1.56,0.64,1); filter: drop-shadow(0 3px 8px rgba(0,0,0,0.10)); position: relative; z-index: 1; }
    .product-card:hover .p-emoji { transform: scale(1.14) rotate(-5deg) translateY(-2px); }
    .p-name { font-size: 14px; font-weight: 700; line-height: 1.3; margin-bottom: 5px; position: relative; z-index: 1; color: var(--dark); }
    .p-old-price { font-family: 'Lato', sans-serif; font-size: 11px; color: var(--muted); text-decoration: line-through; margin-bottom: 2px; position: relative; z-index: 1; letter-spacing: 0.3px; }
    .p-price { font-family: 'Lato', sans-serif; font-size: 18px; font-weight: 700; color: var(--dark); position: relative; z-index: 1; letter-spacing: -0.5px; }
    .p-stock { font-size: 10px; color: var(--muted); margin-top: 3px; position: relative; z-index: 1; font-weight: 500; }
    .p-stock.low { color: var(--orange); font-weight: 600; }
    .p-stock.empty { color: var(--red); font-weight: 600; }

    .discount-badge { position: absolute; top: 9px; left: 9px; background: linear-gradient(135deg, #EF4444, #DC2626); color: white; font-size: 10px; font-weight: 700; padding: 3px 7px; border-radius: 20px; z-index: 2; letter-spacing: 0.3px; box-shadow: 0 2px 8px rgba(239,68,68,0.4); }

    /* Card qty controls */
    .card-actions { width: 100%; margin-top: 10px; position: relative; z-index: 2; }
    .card-add-btn {
      width: 100%; padding: 8px 6px; background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dark) 100%); color: white;
      border: none; border-radius: 10px; font-family: 'Lato', sans-serif;
      font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.18s;
      display: flex; align-items: center; justify-content: center; gap: 4px;
      box-shadow: 0 2px 10px rgba(74,127,167,0.35);
    }
    .card-add-btn:hover { background: linear-gradient(135deg, var(--gold-light) 0%, var(--gold) 100%); transform: translateY(-1px); box-shadow: 0 4px 16px rgba(74,127,167,0.45); }
    .card-qty-ctrl { display: none; align-items: center; background: var(--sand-dim); border: 1.5px solid rgba(74,127,167,0.22); border-radius: 10px; overflow: hidden; height: 34px; }
    .card-qty-ctrl.show { display: flex; }
    .cq-btn { width: 34px; height: 34px; background: transparent; border: none; color: var(--gold-dark); font-size: 17px; font-weight: 700; cursor: pointer; flex-shrink: 0; transition: background 0.14s; font-family: 'Lato', sans-serif; display: flex; align-items: center; justify-content: center; }
    .cq-btn:hover { background: rgba(74,127,167,0.18); }
    .cq-input { flex: 1; border: none; background: transparent; text-align: center; font-family: 'Lato', sans-serif; font-size: 16px; font-weight: 700; color: var(--gold-dark); outline: none; width: 0; -moz-appearance: textfield; }
    .cq-input::-webkit-outer-spin-button, .cq-input::-webkit-inner-spin-button { -webkit-appearance: none; }

    .empty-state { grid-column: 1/-1; text-align: center; padding: 60px 20px; color: var(--muted); }
    .empty-state .ei { font-size: 48px; margin-bottom: 12px; }
    .empty-state p { font-size: 14px; }

    /* ══ FLOATING CART ══ */
    .cart-float { position: fixed; bottom: 22px; left: 50%; transform: translateX(-50%); width: 700px; max-width: calc(100vw - 36px); z-index: 50; display: none; }
    .cart-float.visible { display: block; }

    .cart-panel { background: var(--white); border-radius: 22px 22px 0 0; overflow: hidden; max-height: 0; opacity: 0; transition: max-height 0.4s cubic-bezier(0.4,0,0.2,1), opacity 0.28s ease; box-shadow: 0 -8px 40px rgba(10,25,49,0.12), 0 -2px 8px rgba(10,25,49,0.06); }
    .cart-float:hover .cart-panel, .cart-float.pinned .cart-panel { max-height: 460px; opacity: 1; }

    .cart-panel-top { padding: 18px 20px 0; }
    .cp-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
    .cp-title { font-size: 11px; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; }
    .cp-clear { font-size: 11px; font-weight: 600; color: var(--muted); background: none; border: none; cursor: pointer; padding: 3px 10px; border-radius: 20px; transition: all 0.14s; font-family: 'Lato', sans-serif; }
    .cp-clear:hover { background: var(--red-dim); color: var(--red); }

    .cart-list { max-height: 220px; overflow-y: auto; scrollbar-width: thin; scrollbar-color: var(--border) transparent; }

    .ci { display: flex; align-items: center; gap: 10px; padding: 9px 0; border-bottom: 1px solid var(--border); animation: item-in .2s ease; }
    @keyframes item-in { from { opacity: 0; transform: translateX(-8px); } to { opacity: 1; transform: translateX(0); } }
    .ci.removing { animation: item-out .2s ease forwards; }
    @keyframes item-out { to { opacity: 0; transform: translateX(12px); max-height: 0; padding: 0; overflow: hidden; } }

    .ci-emoji { font-size: 22px; width: 40px; height: 40px; background: var(--bg); border-radius: 9px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    .ci-info { flex: 1; min-width: 0; }
    .ci-name { font-size: 12px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .ci-unit { font-size: 11px; color: var(--muted); margin-top: 1px; }
    .ci-qty { display: flex; align-items: center; gap: 5px; flex-shrink: 0; }
    .ciqb { width: 26px; height: 26px; border-radius: 50%; border: 1.5px solid var(--border); background: white; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 700; cursor: pointer; color: var(--dark); transition: all 0.13s; font-family: 'Lato', sans-serif; }
    .ciqb:hover { background: var(--blue); border-color: var(--blue); color: white; }
    .ciqb.minus:hover { background: var(--red); border-color: var(--red); }
    .ci-n { font-size: 13px; font-weight: 700; min-width: 20px; text-align: center; }
    .ci-sub { font-size: 12px; font-weight: 700; min-width: 82px; text-align: right; flex-shrink: 0; }
    .ci-del { width: 28px; height: 28px; border-radius: 8px; border: none; background: transparent; color: var(--muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.13s; flex-shrink: 0; }
    .ci-del:hover { background: var(--red-dim); color: var(--red); }

    .cart-totals-row { display: flex; justify-content: space-between; padding: 12px 20px 14px; background: var(--bg); border-top: 1px solid var(--border); gap: 0; }
    .tc { display: flex; flex-direction: column; gap: 2px; flex: 1; }
    .tc+.tc { border-left: 1px solid var(--border); padding-left: 18px; margin-left: 18px; }
    .tc:last-child { align-items: flex-end; }
    .tc-lbl { font-size: 10px; color: var(--muted); }
    .tc-val { font-size: 12px; font-weight: 700; }
    .tc-val.big { font-family: 'Lato', sans-serif; font-size: 24px; font-weight: 700; letter-spacing: -0.8px; }

    .cart-bar {
      background: linear-gradient(135deg, #0A1931 0%, #122B50 60%, #1A3D63 100%);
      border-radius: 20px; padding: 13px 12px 13px 18px;
      display: flex; align-items: center; justify-content: space-between;
      cursor: pointer; position: relative; z-index: 1;
      box-shadow: 0 8px 40px rgba(10,25,49,0.50), 0 2px 8px rgba(10,25,49,0.3);
      transition: border-radius 0.32s ease;
    }
    .cart-float:hover .cart-bar, .cart-float.pinned .cart-bar { border-radius: 0 0 20px 20px; }

    .cb-left { display: flex; align-items: center; gap: 12px; }
    .cb-badge { background: linear-gradient(135deg, #4A7FA7, #1A3D63); min-width: 36px; height: 36px; border-radius: 11px; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 800; color: white; padding: 0 5px; box-shadow: 0 2px 8px rgba(74,127,167,0.45); }
    .cb-info { display: flex; flex-direction: column; }
    .cb-items { font-size: 11px; color: rgba(255,255,255,0.48); }
    .cb-total { font-family: 'Lato', sans-serif; font-size: 22px; font-weight: 700; color: white; letter-spacing: -0.8px; }
    .cb-right { display: flex; align-items: center; gap: 9px; }
    .cb-arrow { color: rgba(255,255,255,0.35); font-size: 17px; transition: transform 0.3s; user-select: none; }
    .cart-float:hover .cb-arrow, .cart-float.pinned .cb-arrow { transform: rotate(180deg); }

    @keyframes shimmer-sweep { 0% { left: -80%; } 100% { left: 130%; } }

    .btn-pagar { background: linear-gradient(135deg, #5490B8 0%, #4A7FA7 40%, #1A3D63 100%); color: white; border: none; border-radius: 13px; padding: 11px 24px; font-family: 'Lato', sans-serif; font-size: 14px; font-weight: 700; cursor: pointer; transition: all 0.18s; display: flex; align-items: center; gap: 6px; box-shadow: 0 4px 20px rgba(74,127,167,0.55), 0 1px 4px rgba(0,0,0,0.2); white-space: nowrap; position: relative; overflow: hidden; }
    .btn-pagar::before { content: ''; position: absolute; top: -50%; left: -80%; width: 40%; height: 200%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.28), transparent); transform: skewX(-18deg); animation: shimmer-sweep 2.6s ease-in-out infinite; animation-delay: 0.8s; pointer-events: none; }
    .btn-pagar:hover { background: linear-gradient(135deg, #5A8FB7 0%, #5A8FB7 100%); transform: scale(1.04); box-shadow: 0 6px 28px rgba(74,127,167,0.65), 0 2px 6px rgba(0,0,0,0.2); }
    .btn-pagar:active { transform: scale(0.97); }

    /* ══ INVENTORY VIEW ══ */
    .view-content { padding: 32px 36px; max-width: 100%; }

    .page-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 28px; flex-wrap: wrap; gap: 14px; }
    .page-title { font-family: 'Lato', sans-serif; font-size: 34px; font-weight: 700; letter-spacing: -0.5px; }
    .page-subtitle { font-size: 15px; color: var(--muted); margin-top: 4px; }

    .btn-primary { background: linear-gradient(135deg, #4A7FA7, #1A3D63); color: white; border: none; border-radius: 11px; padding: 12px 24px; font-family: 'Lato', sans-serif; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.17s; display: flex; align-items: center; gap: 8px; box-shadow: 0 3px 12px rgba(74,127,167,0.36); }
    .btn-primary:hover { background: linear-gradient(135deg, #1A3D63, #1A3D63); transform: translateY(-1px); box-shadow: 0 5px 16px rgba(74,127,167,0.44); }
    .btn-sm { padding: 9px 16px; font-size: 13px; border-radius: 9px; }

    .inv-filters { display: flex; align-items: center; gap: 12px; margin-bottom: 22px; flex-wrap: wrap; }
    .inv-search { display: flex; align-items: center; gap: 10px; background: var(--white); border: 1.5px solid var(--border); border-radius: 50px; padding: 11px 20px; min-width: 260px; transition: border-color 0.2s; }
    .inv-search:focus-within { border-color: var(--blue); }
    .inv-search input { border: none; background: transparent; font-family: 'Lato', sans-serif; font-size: 15px; color: var(--dark); outline: none; width: 100%; }
    .inv-search input::placeholder { color: var(--muted); }

    .filter-pill { padding: 9px 18px; border: 1.5px solid var(--border); border-radius: 50px; background: var(--white); font-family: 'Lato', sans-serif; font-size: 13px; font-weight: 500; color: var(--muted); cursor: pointer; transition: all 0.15s; }
    .filter-pill:hover { border-color: var(--blue); color: var(--dark); }
    .filter-pill.active { background: var(--blue-light); border-color: var(--blue); color: var(--blue-mid); font-weight: 600; }

    .inv-table-wrap { background: var(--white); border-radius: var(--r); box-shadow: var(--shadow-sm); overflow: hidden; border: 1px solid rgba(205,213,219,0.6); }
    .inv-table { width: 100%; border-collapse: collapse; }
    .inv-table th { background: var(--bg); padding: 15px 20px; text-align: left; font-size: 13px; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: 0.8px; border-bottom: 1px solid var(--border); }
    .inv-table td { padding: 18px 20px; border-bottom: 1px solid var(--border); font-size: 15px; vertical-align: middle; }
    .inv-table tr:last-child td { border-bottom: none; }
    .inv-table tr:hover td { background: var(--bg); }

    .prod-cell { display: flex; align-items: center; gap: 14px; }
    .prod-cell-emoji { font-size: 28px; width: 50px; height: 50px; background: var(--bg); border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    .prod-cell-name { font-weight: 600; font-size: 15px; }
    .prod-cell-id { font-size: 11px; color: var(--muted); }

    .cat-tag { display: inline-flex; padding: 5px 12px; background: var(--blue-xl); color: var(--blue); border-radius: 20px; font-size: 13px; font-weight: 600; }
    .stock-badge { display: inline-flex; align-items: center; gap: 5px; padding: 5px 13px; border-radius: 20px; font-size: 13px; font-weight: 600; }
    .stock-badge.ok { background: var(--green-dim); color: var(--green); }
    .stock-badge.low { background: var(--orange-dim); color: var(--orange); }
    .stock-badge.empty { background: var(--red-dim); color: var(--red); }

    .action-btns { display: flex; gap: 8px; }
    .icon-btn { width: 38px; height: 38px; border-radius: 10px; border: 1.5px solid var(--border); background: var(--white); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.14s; }
    .icon-btn:hover.edit { border-color: var(--blue); background: var(--blue-light); color: var(--blue); }
    .icon-btn:hover.del { border-color: var(--red); background: var(--red-dim); color: var(--red); }

    /* ══ CIERRE VIEW ══ */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 32px; }
    .stat-card { background: var(--white); border-radius: var(--r); padding: 26px; box-shadow: var(--shadow-sm); border: 1px solid rgba(205,213,219,0.5); }
    .stat-card-label { font-size: 13px; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 10px; }
    .stat-card-value { font-family: 'Lato', sans-serif; font-size: 36px; font-weight: 700; letter-spacing: -1.2px; }
    .stat-card-sub { font-size: 13px; color: var(--muted); margin-top: 5px; }
    .stat-card.blue { border-top: 3px solid var(--blue); }
    .stat-card.blue .stat-card-value { color: var(--blue); }
    .stat-card.green { border-top: 3px solid var(--green); }
    .stat-card.green .stat-card-value { color: var(--green); }
    .stat-card.orange { border-top: 3px solid var(--orange); }
    .stat-card.orange .stat-card-value { color: var(--orange); }
    .stat-card.navy { border-top: 3px solid var(--navy); }
    .stat-card.navy .stat-card-value { color: var(--navy); }
    .stat-card.gold { border-top: 3px solid var(--gold); }
    .stat-card.gold .stat-card-value { color: var(--gold-dark); }

    .section-card { background: var(--white); border-radius: var(--r); padding: 28px; box-shadow: var(--shadow-sm); border: 1px solid rgba(205,213,219,0.5); margin-bottom: 24px; }
    .section-card-title { font-family: 'Lato', sans-serif; font-size: 20px; font-weight: 700; letter-spacing: -0.2px; margin-bottom: 22px; display: flex; align-items: center; justify-content: space-between; color: var(--dark); }

    .sales-table { width: 100%; border-collapse: collapse; }
    .sales-table th { padding: 13px 18px; text-align: left; font-size: 13px; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: 0.8px; border-bottom: 1px solid var(--border); }
    .sales-table td { padding: 15px 18px; border-bottom: 1px solid var(--border); font-size: 15px; }
    .sales-table tr:last-child td { border-bottom: none; }
    .sales-table tr:hover td { background: var(--bg); }

    .method-badge { display: inline-flex; align-items: center; gap: 5px; padding: 3px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; }
    .method-badge.efectivo { background: var(--green-dim); color: var(--green); }
    .method-badge.tarjeta { background: var(--blue-xl); color: var(--blue); }
    .method-badge.transferencia { background: var(--sand-dim); color: var(--gold-dark); }

    .cierre-closed-banner { background: var(--green-dim); border: 1.5px solid var(--green); border-radius: var(--r); padding: 20px 24px; display: flex; align-items: center; gap: 14px; margin-bottom: 20px; }
    .cierre-closed-banner .icon { font-size: 32px; }
    .cierre-closed-banner .text strong { display: block; font-size: 16px; font-weight: 700; color: var(--green); }
    .cierre-closed-banner .text span { font-size: 13px; color: var(--mid); }

    .btn-danger { background: var(--red); color: white; border: none; border-radius: 11px; padding: 10px 20px; font-family: 'Lato', sans-serif; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.17s; display: flex; align-items: center; gap: 7px; box-shadow: 0 3px 10px rgba(239,68,68,0.28); }
    .btn-danger:hover { background: #DC2626; transform: translateY(-1px); }
    .btn-success { background: var(--green); color: white; border: none; border-radius: 11px; padding: 10px 20px; font-family: 'Lato', sans-serif; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.17s; display: flex; align-items: center; gap: 7px; box-shadow: 0 3px 10px rgba(16,185,129,0.28); }
    .btn-success:hover { transform: translateY(-1px); }
    .btn-outline { background: transparent; color: var(--mid); border: 1.5px solid var(--border); border-radius: 11px; padding: 10px 20px; font-family: 'Lato', sans-serif; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.17s; display: flex; align-items: center; gap: 7px; }
    .btn-outline:hover { border-color: var(--dark); color: var(--dark); }

    /* ══ REPORTS VIEW ══ */
    .report-filters { display: flex; gap: 8px; margin-bottom: 24px; }
    .rf-btn { padding: 8px 16px; border: 1.5px solid rgba(205,213,219,0.7); border-radius: 50px; background: var(--white); font-family: 'Lato', sans-serif; font-size: 12px; font-weight: 50000; color: var(--muted); cursor: pointer; transition: all 0.17s; box-shadow: var(--shadow-sm); }
    .rf-btn:hover { border-color: rgba(74,127,167,0.4); color: var(--dark); transform: translateY(-1px); }
    .rf-btn.active { background: var(--sand-dim); border-color: var(--gold); color: var(--gold-dark); font-weight: 700; box-shadow: var(--shadow-gold); }

    .reports-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 28px; }

    /* Bar chart */
    .bar-chart { display: flex; flex-direction: column; gap: 10px; }
    .bar-row { display: flex; align-items: center; gap: 10px; }
    .bar-lbl { font-size: 12px; color: var(--mid); min-width: 100px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .bar-track { flex: 1; height: 8px; background: var(--bg); border-radius: 5px; overflow: hidden; }
    .bar-fill { height: 100%; background: linear-gradient(90deg, var(--blue-mid), var(--blue)); border-radius: 5px; transition: width 0.7s cubic-bezier(0.4,0,0.2,1); min-width: 3px; }
    .bar-fill.green { background: linear-gradient(90deg, #059669, var(--green)); }
    .bar-fill.gold { background: linear-gradient(90deg, var(--gold-dark), var(--gold-light)); }
    .bar-val { font-size: 12px; font-weight: 700; color: var(--dark); min-width: 80px; text-align: right; }

    .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }

    /* ══ MODALS ══ */
    .overlay { position: fixed; inset: 0; background: rgba(4,12,28,0.65); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); display: flex; align-items: center; justify-content: center; z-index: 200; opacity: 0; pointer-events: none; transition: opacity 0.22s ease; }
    .overlay.open { opacity: 1; pointer-events: all; }
    .modal { background: var(--white); border-radius: 26px; padding: 32px; width: 460px; max-width: 92vw; box-shadow: 0 32px 100px rgba(10,25,49,0.28), 0 4px 16px rgba(10,25,49,0.10); border: 1px solid rgba(74,127,167,0.10); transform: scale(0.94) translateY(14px); transition: transform 0.28s cubic-bezier(0.34, 1.56, 0.64, 1); max-height: 92vh; overflow-y: auto; }
    .overlay.open .modal { transform: scale(1) translateY(0); }
    .modal.wide { width: 520px; }

    .modal-title { font-family: 'Lato', sans-serif; font-size: 26px; font-weight: 700; letter-spacing: -0.4px; margin-bottom: 4px; }
    .modal-sub { font-size: 13px; color: var(--muted); margin-bottom: 24px; }

    .total-box { background: var(--bg); border-radius: 16px; padding: 22px; text-align: center; margin-bottom: 24px; }
    .total-box-lbl { font-size: 10px; color: var(--muted); text-transform: uppercase; letter-spacing: 1.2px; margin-bottom: 4px; }
    .total-box-amt { font-family: 'Lato', sans-serif; font-size: 52px; font-weight: 700; letter-spacing: -3px; }
    .total-box-break { font-size: 11px; color: var(--muted); margin-top: 4px; }

    .slabel { font-size: 11px; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; }

    .pay-grid { display: grid; grid-template-columns: repeat(3,1fr); gap: 9px; margin-bottom: 22px; }
    .pay-btn { display: flex; flex-direction: column; align-items: center; gap: 6px; padding: 16px 8px; border: 1.5px solid rgba(205,213,219,0.7); border-radius: 14px; background: var(--white); cursor: pointer; transition: all 0.18s; font-family: 'Lato', sans-serif; box-shadow: var(--shadow-sm); }
    .pay-btn:hover { border-color: rgba(74,127,167,0.4); background: var(--sand-dim); transform: translateY(-2px); box-shadow: var(--shadow-md); }
    .pay-btn.active { border-color: var(--gold); background: var(--sand-dim); box-shadow: var(--shadow-gold); }
    .pay-btn .icon { font-size: 26px; }
    .pay-btn .label { font-size: 11px; font-weight: 600; color: var(--dark); text-align: center; line-height: 1.3; }

    .cash-field { background: var(--bg); border: 2px solid var(--blue); border-radius: 13px; padding: 13px 16px; display: flex; align-items: center; gap: 8px; margin-bottom: 11px; }
    .cash-sym { font-size: 20px; font-weight: 700; color: var(--blue); }
    .cash-field input { flex: 1; border: none; background: transparent; font-family: 'Lato', sans-serif; font-size: 26px; font-weight: 700; color: var(--dark); outline: none; }
    .quick-amts { display: flex; gap: 7px; flex-wrap: wrap; margin-bottom: 13px; }
    .qamt { padding: 6px 14px; background: var(--white); border: 1.5px solid rgba(205,213,219,0.7); border-radius: 50px; cursor: pointer; font-family: 'Lato', sans-serif; font-size: 12px; font-weight: 600; color: var(--dark); transition: all 0.16s; box-shadow: var(--shadow-sm); }
    .qamt:hover { background: var(--sand-dim); border-color: var(--gold); color: var(--gold-dark); transform: translateY(-1px); }
    .change-row { display: flex; justify-content: space-between; align-items: center; background: var(--green-dim); border-radius: 11px; padding: 12px 16px; margin-bottom: 20px; }
    .change-lbl { font-size: 13px; font-weight: 600; color: var(--green); }
    .change-amt { font-size: 17px; font-weight: 800; color: var(--green); }

    .modal-btns { display: flex; gap: 9px; margin-top: 22px; }
    .btn-cancel { flex: 1; padding: 13px; background: var(--bg); border: 1.5px solid var(--border); border-radius: 13px; font-family: 'Lato', sans-serif; font-size: 13px; font-weight: 600; color: var(--muted); cursor: pointer; transition: all 0.17s; }
    .btn-cancel:hover { border-color: var(--red); color: var(--red); }
    .btn-confirm { flex: 2; padding: 13px; background: linear-gradient(135deg, var(--green), #059669); color: white; border: none; border-radius: 13px; font-family: 'Lato', sans-serif; font-size: 14px; font-weight: 700; cursor: pointer; transition: all 0.17s; box-shadow: 0 3px 12px rgba(16,185,129,0.34); }
    .btn-confirm:hover { transform: translateY(-1px); }

    /* Form fields */
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
    .form-grid.full { grid-template-columns: 1fr; }
    .field { display: flex; flex-direction: column; gap: 5px; }
    .field label { font-size: 11px; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: 0.8px; }
    .field input, .field select { font-family: 'Lato', sans-serif; font-size: 14px; font-weight: 50000; color: var(--dark); background: var(--bg); border: 1.5px solid var(--border); border-radius: 10px; padding: 10px 14px; outline: none; transition: border-color 0.2s, box-shadow 0.2s; }
    .field input:focus, .field select:focus { border-color: var(--blue); box-shadow: 0 0 0 3px rgba(74,127,167,0.09); }
    .field input::placeholder { color: var(--muted); font-weight: 400; }

    /* Receipt */
    .receipt-header { text-align: center; padding-bottom: 16px; border-bottom: 2px dashed var(--border); margin-bottom: 14px; }
    .receipt-brand { font-family: 'Lato', sans-serif; font-size: 26px; font-weight: 700; letter-spacing: 0.5px; }
    .receipt-info { font-family: 'Courier New', monospace; font-size: 10px; color: var(--muted); line-height: 1.8; margin-top: 4px; }
    .receipt-row { display: flex; justify-content: space-between; font-size: 11px; font-family: 'Courier New', monospace; margin-bottom: 4px; }
    .receipt-hr { border: none; border-top: 1.5px dashed var(--border); margin: 10px 0; }
    .receipt-total-row { display: flex; justify-content: space-between; font-size: 14px; font-weight: 700; font-family: 'Courier New', monospace; }
    .receipt-footer { text-align: center; font-family: 'Courier New', monospace; font-size: 10px; color: var(--muted); margin-top: 14px; line-height: 1.7; }

    .btn-print { width: 100%; padding: 13px; margin-top: 20px; background: var(--blue); color: white; border: none; border-radius: 13px; font-family: 'Lato', sans-serif; font-size: 13px; font-weight: 700; cursor: pointer; transition: all 0.17s; box-shadow: 0 3px 12px rgba(74,127,167,0.3); }
    .btn-print:hover { background: var(--blue-mid); transform: translateY(-1px); }
    .btn-new { width: 100%; padding: 11px; margin-top: 7px; background: transparent; color: var(--muted); border: 1.5px solid var(--border); border-radius: 13px; font-family: 'Lato', sans-serif; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.17s; }
    .btn-new:hover { border-color: var(--dark); color: var(--dark); }

    /* Confirm modal */
    .confirm-icon { font-size: 48px; text-align: center; margin-bottom: 16px; }
    .confirm-text { font-size: 15px; text-align: center; color: var(--mid); margin-bottom: 6px; }
    .confirm-sub { font-size: 13px; text-align: center; color: var(--muted); }

    /* ══ NOISE GRAIN ══ */
    .noise-layer {
      position: fixed; inset: 0; pointer-events: none; z-index: 9998; opacity: 0.028;
      background-image: url("data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='250' height='250'><filter id='n'><feTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/><feColorMatrix type='saturate' values='0'/></filter><rect width='250' height='250' filter='url(%23n)'/></svg>");
      background-repeat: repeat; background-size: 180px;
    }
    body.dark .noise-layer { opacity: 0.045; }

    /* ══ TOAST ══ */
    .toast { position: fixed; bottom: 108px; left: 50%; transform: translateX(-50%) translateY(16px); background: linear-gradient(135deg, #0A1931 0%, #122B50 100%); color: white; padding: 10px 20px; border-radius: 50px; font-size: 12px; font-weight: 500; opacity: 0; transition: all 0.28s cubic-bezier(0.34,1.56,0.64,1); z-index: 300; pointer-events: none; box-shadow: 0 8px 32px rgba(10,25,49,0.4), 0 2px 8px rgba(0,0,0,0.2), inset 0 0 0 1px rgba(255,255,255,0.06); white-space: nowrap; letter-spacing: 0.1px; }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

    ::-webkit-scrollbar { width: 4px; height: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(74,127,167,0.3); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(74,127,167,0.5); }

    /* ══ THEME TOGGLE ══ */
    .theme-btn { width: 34px; height: 34px; border-radius: 9px; border: 1px solid rgba(255,255,255,0.15); background: rgba(255,255,255,0.08); font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.18s; flex-shrink: 0; line-height: 1; }
    .theme-btn:hover { background: rgba(255,255,255,0.18); transform: scale(1.08); }

    /* ══ CAT MANAGE BUTTON ══ */
    .btn-cat-manage { width: 34px; height: 34px; border-radius: 10px; border: 1.5px solid rgba(205,213,219,0.7); background: var(--white); color: var(--muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.16s; flex-shrink: 0; box-shadow: var(--shadow-sm); }
    .btn-cat-manage:hover { border-color: var(--gold); color: var(--gold-dark); box-shadow: var(--shadow-md); }

    /* ══ CATEGORIES MODAL ══ */
    .cats-chips-wrap { border: 1.5px solid var(--border); border-radius: 14px; padding: 12px; min-height: 62px; display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 22px; align-content: flex-start; }
    .cat-chip { display: inline-flex; align-items: center; gap: 7px; padding: 7px 10px 7px 13px; background: var(--blue-xl); border: 1.5px solid var(--border); border-radius: 50px; font-size: 13px; font-weight: 500; color: var(--dark); }
    .cat-chip-del { width: 20px; height: 20px; border-radius: 50%; border: none; background: rgba(0,0,0,0.09); color: var(--muted); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 13px; font-weight: 700; transition: all 0.13s; padding: 0; line-height: 1; }
    .cat-chip-del:hover { background: var(--red); color: white; }
    .cats-empty { font-size: 13px; color: var(--muted); padding: 8px 2px; }
    .cats-add-row { display: flex; gap: 10px; align-items: flex-end; }

    /* ══ DARK MODE ══ */
    body.dark {
      --bg:         #060C18;
      --surface:    #0B1628;
      --white:      #0F1E35;
      --dark:       #D8E6F0;
      --mid:        #90AABF;
      --muted:      #3D5570;
      --border:     #142B48;
      --blue-light: #142B48;
      --blue-xl:    #0A1C30;
      --green-dim:  #05200E;
      --red-dim:    #200808;
      --orange-dim: #201404;
      --sand-dim:   #0A1C35;
      --shadow-sm:  0 1px 4px rgba(0,0,0,0.4), 0 2px 10px rgba(0,0,0,0.3);
      --shadow-md:  0 4px 16px rgba(0,0,0,0.5), 0 1px 4px rgba(0,0,0,0.3);
      --shadow-lg:  0 20px 60px rgba(0,0,0,0.7), 0 4px 16px rgba(0,0,0,0.5);
      --shadow-gold: 0 4px 24px rgba(74,127,167,0.28);
    }
    body.dark body::before { background: radial-gradient(ellipse at center, rgba(74,127,167,0.18) 0%, transparent 65%); }
    body.dark body::after  { background: radial-gradient(ellipse at center, rgba(74,127,167,0.14) 0%, transparent 65%); }

    /* Dark surfaces that override literal 'white' backgrounds */
    body.dark .pos-topbar { background: #0B1E35; border-bottom-color: var(--border); }
    body.dark .cart-panel { background: rgba(7,14,28,0.92); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); }
    body.dark .modal { background: #0F1E35; border-color: rgba(163,184,196,0.08); }
    body.dark .inv-table-wrap { background: #0F1E35; }
    body.dark .section-card { background: #0F1E35; }
    body.dark .stat-card { background: #0F1E35; }
    body.dark .cat-pill { background: rgba(14,32,65,0.8); border-color: rgba(163,184,196,0.12); }
    body.dark .cat-pill.active { background: rgba(74,127,167,0.15); border-color: var(--gold); }
    body.dark .filter-pill { background: #0F1E35; }
    body.dark .inv-search { background: #0F1E35; border-color: var(--border); }
    body.dark .ciqb { background: var(--blue-xl); }
    body.dark .icon-btn { background: #0F1E35; }
    body.dark .rf-btn { background: #0F1E35; }
    body.dark .pay-btn { background: #0F1E35; border-color: var(--border); }
    body.dark .qamt { background: #0F1E35; }
    body.dark .btn-cat-manage { background: #0F1E35; }
    body.dark .inv-table th { background: var(--bg); }
    body.dark .cat-chip { background: var(--blue-xl); }
    body.dark .total-box { background: rgba(6,12,24,0.7); }

    /* Glass product cards in dark mode */
    body.dark .product-card {
      background: rgba(8,20,45,0.65);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border-color: rgba(163,184,196,0.06);
    }
    body.dark .product-card:hover {
      background: rgba(18,38,74,0.88);
      border-color: rgba(74,127,167,0.30);
      box-shadow: 0 0 0 1px rgba(74,127,167,0.12), 0 16px 48px rgba(0,0,0,0.5), 0 0 80px rgba(74,127,167,0.06);
    }
    body.dark .product-card.in-cart {
      border-color: rgba(74,127,167,0.45);
      background: rgba(20,38,72,0.85);
      box-shadow: 0 0 0 1px rgba(74,127,167,0.2), var(--shadow-sm);
    }
    body.dark .card-qty-ctrl { background: rgba(10,30,60,0.6); border-color: rgba(74,127,167,0.2); }
    body.dark .cart-panel { background: rgba(7,14,28,0.95); border-top: 1px solid rgba(255,255,255,0.05); }
    body.dark .cart-totals-row { background: rgba(4,10,22,0.7); }
    body.dark .btn-cancel { background: rgba(6,12,24,0.8); }
    body.dark .ci-emoji, body.dark .prod-cell-emoji { background: rgba(255,255,255,0.04); }
    body.dark .pay-btn.active { background: rgba(74,127,167,0.12); }
    body.dark .total-box { background: rgba(4,10,22,0.8); border: 1px solid rgba(255,255,255,0.04); border-radius: 14px; }
    body.dark .cat-chip { background: rgba(13,32,65,0.8); }
    body.dark .cats-chips-wrap { border-color: var(--border); background: rgba(6,12,24,0.5); }

    /* ══ MODE SELECTION ══ */
    .mode-overlay { position: fixed; inset: 0; z-index: 9996; background: var(--bg); display: none; align-items: center; justify-content: center; }
    .mode-card { background: var(--white); border-radius: 28px; padding: 48px 40px; width: 100%; max-width: 520px; box-shadow: var(--shadow-lg); text-align: center; border: 1px solid rgba(74,127,167,0.15); }
    .mode-title { font-size: 22px; font-weight: 700; color: var(--dark); margin-bottom: 6px; }
    .mode-subtitle { font-size: 14px; color: var(--muted); margin-bottom: 32px; }
    .mode-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .mode-btn { padding: 32px 20px; border-radius: 20px; border: 2px solid var(--border); background: var(--bg); cursor: pointer; transition: all 0.22s cubic-bezier(0.34,1.56,0.64,1); display: flex; flex-direction: column; align-items: center; gap: 10px; font-family: 'Lato', sans-serif; }
    .mode-btn:hover { border-color: var(--gold); background: rgba(74,127,167,0.06); transform: translateY(-3px); box-shadow: var(--shadow-md); }
    .mode-btn-icon { font-size: 44px; }
    .mode-btn-label { font-size: 16px; font-weight: 700; color: var(--dark); }
    .mode-btn-desc { font-size: 12px; color: var(--muted); }
    body.dark .mode-card { background: rgba(8,20,45,0.97); border-color: rgba(74,127,167,0.20); }
    body.dark .mode-btn { background: rgba(255,255,255,0.04); border-color: rgba(255,255,255,0.1); }

    /* ══ ONBOARDING OVERLAY (solo registro nuevo) ══ */
    .onboarding-overlay { position: fixed; inset: 0; z-index: 9999; background: var(--bg); display: none; align-items: center; justify-content: center; }
    .onboarding-card { background: var(--white); border-radius: 28px; padding: 48px 40px; width: 100%; max-width: 560px; box-shadow: var(--shadow-lg); text-align: center; border: 1px solid rgba(74,127,167,0.15); }
    .onboarding-title { font-size: 22px; font-weight: 700; color: var(--dark); margin-bottom: 6px; }
    .onboarding-subtitle { font-size: 14px; color: var(--muted); margin-bottom: 28px; }
    .onboarding-field { margin-bottom: 24px; text-align: left; }
    .onboarding-field label { font-size: 13px; font-weight: 600; color: var(--dark); display: block; margin-bottom: 8px; }
    .onboarding-input { width: 100%; padding: 13px 16px; border-radius: 12px; border: 2px solid var(--border); background: var(--bg); font-size: 15px; font-family: 'Lato', sans-serif; color: var(--dark); outline: none; transition: border-color 0.2s; box-sizing: border-box; }
    .onboarding-input:focus { border-color: var(--gold); }
    .onboarding-section-label { font-size: 13px; font-weight: 600; color: var(--dark); margin-bottom: 14px; text-align: left; }
    .onboarding-mode-btn { padding: 28px 20px; border-radius: 20px; border: 2px solid var(--border); background: var(--bg); cursor: pointer; transition: all 0.22s cubic-bezier(0.34,1.56,0.64,1); display: flex; flex-direction: column; align-items: center; gap: 10px; font-family: 'Lato', sans-serif; width: 100%; }
    .onboarding-mode-btn:hover, .onboarding-mode-btn.selected { border-color: var(--gold); background: rgba(74,127,167,0.06); box-shadow: var(--shadow-md); transform: translateY(-3px); }
    .onboarding-btn-confirm { margin-top: 28px; width: 100%; padding: 15px; border-radius: 14px; background: var(--primary); color: white; font-size: 15px; font-weight: 700; border: none; cursor: pointer; font-family: 'Lato', sans-serif; transition: opacity 0.2s, transform 0.15s; }
    .onboarding-btn-confirm:hover { opacity: 0.9; transform: translateY(-1px); }
    body.dark .onboarding-card { background: rgba(8,20,45,0.97); border-color: rgba(74,127,167,0.20); }
    body.dark .onboarding-mode-btn { background: rgba(255,255,255,0.04); border-color: rgba(255,255,255,0.1); }
    body.dark .onboarding-input { background: rgba(255,255,255,0.06); border-color: rgba(255,255,255,0.12); color: var(--text); }

    /* ══ SALON / FLOOR PLAN ══ */
    .salon-wrap { width: 100%; height: calc(100vh - 60px); position: relative; overflow: hidden; }
    .salon-toolbar { position: absolute; top: 16px; right: 20px; z-index: 10; display: flex; gap: 10px; align-items: center; }
    /* floor plan editor toolbar buttons */
    .btn-design { padding: 7px 14px; border-radius: 8px; border: 1.5px solid var(--border); background: var(--bg); cursor: pointer; font-family: 'Lato', sans-serif; font-size: 12px; font-weight: 600; color: var(--dark); transition: all 0.15s; display: flex; align-items: center; gap: 6px; }
    .btn-design:hover { border-color: var(--blue); color: var(--blue); background: rgba(74,127,167,0.06); }
    .btn-tool { padding: 7px 13px; border-radius: 8px; border: 1.5px solid var(--border); background: var(--bg); cursor: pointer; font-family: 'Lato', sans-serif; font-size: 12px; font-weight: 600; color: var(--dark); transition: all 0.15s; display: flex; align-items: center; gap: 6px; }
    .btn-tool.active { background: var(--primary); border-color: var(--primary); color: white; box-shadow: 0 2px 10px rgba(74,127,167,0.35); }
    .btn-tool:hover:not(.active) { border-color: var(--blue); color: var(--blue); background: rgba(74,127,167,0.06); }
    .btn-tool-done { padding: 7px 16px; border-radius: 8px; border: none; background: #10B981; cursor: pointer; font-family: 'Lato', sans-serif; font-size: 12px; font-weight: 700; color: white; transition: opacity 0.15s; }
    .btn-tool-done:hover { opacity: 0.88; }
    .tool-sep { width: 1px; height: 22px; background: var(--border); flex-shrink: 0; }
    /* SVG floor plan layer */
    .salon-svg { position: absolute; inset: 0; width: 100%; height: 100%; overflow: visible; pointer-events: none; z-index: 1; }
    /* Design mode cursors */
    .salon-wrap.salon-design .salon-canvas { cursor: crosshair; }
    .salon-wrap.salon-design.tool-entrada .salon-canvas { cursor: cell; }
    .salon-wrap.salon-design.tool-borrar .salon-canvas { cursor: default; }
    .floor-pared { transition: opacity 0.15s; }
    .salon-wrap.salon-design .floor-pared:hover { opacity: 0.75; }
    .salon-wrap.salon-design .floor-entrada:hover { opacity: 0.75; }
    .salon-canvas {
      position: absolute; inset: 0;
      background-color: #f8fafc;
      background-image: radial-gradient(circle, #cbd5e1 1px, transparent 1px);
      background-size: 28px 28px;
    }
    .mesa-float { position: absolute; display: flex; flex-direction: column; align-items: center; gap: 5px; cursor: grab; user-select: none; }
    .mesa-float:active { cursor: grabbing; }
    .mesa-float-img { width: 110px; height: 110px; object-fit: contain; transition: transform 0.2s, filter 0.2s; pointer-events: none; }
    .mesa-float:hover .mesa-float-img { transform: scale(1.08); filter: drop-shadow(0 8px 20px rgba(10,25,49,0.2)); }
    .mesa-float-label { font-size: 13px; font-weight: 700; color: var(--dark); background: white; padding: 3px 11px; border-radius: 20px; box-shadow: 0 1px 6px rgba(10,25,49,0.13); pointer-events: none; }
    .mesa-float-status { font-size: 10px; font-weight: 700; padding: 2px 8px; border-radius: 20px; pointer-events: none; }
    .mesa-float-status.libre { background: #ECFDF5; color: #10B981; }
    .mesa-float-status.ocupada { background: #FEF2F2; color: #EF4444; }
    .mesa-float-status.cuenta { background: #FFFBEB; color: #F59E0B; }
    .mesa-float.ocupada .mesa-float-img { filter: drop-shadow(0 0 10px rgba(239,68,68,0.35)); }
    .mesa-float.cuenta .mesa-float-img { filter: drop-shadow(0 0 10px rgba(245,158,11,0.35)); }
    .mesa-delete-btn { position: absolute; top: -8px; right: -8px; width: 22px; height: 22px; border-radius: 50%; background: var(--red); border: none; color: white; font-size: 11px; font-weight: 700; cursor: pointer; display: none; align-items: center; justify-content: center; z-index: 5; box-shadow: 0 2px 6px rgba(239,68,68,0.4); }
    .mesa-float:hover .mesa-delete-btn { display: flex; }

    /* ══ COMANDA PANEL ══ */
    .comanda-bg { position: fixed; inset: 0; background: rgba(10,25,49,0.4); z-index: 200; display: none; }
    .comanda-bg.open { display: block; }
    .comanda-panel { position: fixed; top: 60px; right: 0; bottom: 0; width: 400px; background: var(--surface); border-left: 1px solid var(--border); z-index: 201; display: flex; flex-direction: column; transform: translateX(100%); transition: transform 0.28s cubic-bezier(0.22,1,0.36,1); box-shadow: var(--shadow-lg); }
    .comanda-panel.open { transform: translateX(0); }
    .comanda-header { padding: 16px 18px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; background: var(--white); flex-shrink: 0; }
    .comanda-mesa-name { font-size: 18px; font-weight: 700; color: var(--dark); }
    .comanda-status-badge { font-size: 11px; font-weight: 700; padding: 3px 10px; border-radius: 20px; margin-top: 4px; display: inline-block; }
    .comanda-close { width: 30px; height: 30px; border-radius: 50%; background: var(--bg); border: 1px solid var(--border); cursor: pointer; font-size: 15px; display: flex; align-items: center; justify-content: center; transition: background 0.15s; }
    .comanda-close:hover { background: var(--border); }
    .comanda-items { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 8px; }
    .comanda-empty { display: flex; flex-direction: column; align-items: center; justify-content: center; flex: 1; color: var(--muted); font-size: 14px; gap: 8px; padding: 40px; text-align: center; }
    .comanda-item { background: var(--white); border-radius: 12px; padding: 11px 13px; border: 1px solid rgba(205,213,219,0.6); }
    .comanda-item-top { display: flex; align-items: center; gap: 9px; }
    .comanda-item-emoji { font-size: 20px; flex-shrink: 0; }
    .comanda-item-info { flex: 1; min-width: 0; }
    .comanda-item-name { font-size: 13px; font-weight: 700; color: var(--dark); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .comanda-item-price { font-size: 11px; color: var(--muted); }
    .comanda-item-controls { display: flex; align-items: center; gap: 5px; flex-shrink: 0; }
    .ci-btn2 { width: 24px; height: 24px; border-radius: 50%; border: 1.5px solid var(--border); background: var(--bg); cursor: pointer; font-size: 14px; font-weight: 700; display: flex; align-items: center; justify-content: center; transition: all 0.15s; }
    .ci-btn2:hover { background: var(--blue); border-color: var(--blue); color: white; }
    .ci-qty2 { font-size: 14px; font-weight: 700; color: var(--dark); min-width: 18px; text-align: center; }
    .comanda-item-sent { font-size: 10px; font-weight: 700; padding: 2px 7px; border-radius: 10px; margin-top: 5px; display: inline-block; }
    .comanda-item-sent.sent { background: #ECFDF5; color: #10B981; }
    .comanda-item-sent.pending { background: #FFF7ED; color: #F59E0B; }
    .comanda-note { width: 100%; margin-top: 7px; font-size: 12px; padding: 5px 10px; border: 1.5px solid var(--border); border-radius: 8px; font-family: 'Lato', sans-serif; background: var(--bg); color: var(--dark); outline: none; resize: none; transition: border-color 0.2s; }
    .comanda-note:focus { border-color: var(--blue); }
    .btn-add-items { margin: 8px 10px; padding: 11px; background: var(--bg); border: 1.5px dashed var(--border); border-radius: 10px; font-family: 'Lato', sans-serif; font-size: 13px; font-weight: 600; color: var(--muted); cursor: pointer; transition: all 0.15s; width: calc(100% - 20px); }
    .btn-add-items:hover { border-color: var(--blue); color: var(--blue); background: rgba(74,127,167,0.05); }
    .comanda-total-box { padding: 12px 18px; border-top: 1px solid var(--border); background: var(--white); flex-shrink: 0; }
    .comanda-total-row { display: flex; justify-content: space-between; font-size: 13px; color: var(--muted); margin-bottom: 3px; }
    .comanda-total-row.main { font-size: 16px; font-weight: 700; color: var(--dark); margin-top: 4px; }
    .comanda-actions { padding: 10px 12px; border-top: 1px solid var(--border); display: flex; gap: 7px; background: var(--white); flex-shrink: 0; }
    .btn-kitchen { flex: 1; padding: 10px 6px; border-radius: 10px; border: 1.5px solid var(--blue); background: rgba(74,127,167,0.08); color: var(--blue); font-family: 'Lato', sans-serif; font-size: 11px; font-weight: 700; cursor: pointer; transition: all 0.15s; }
    .btn-kitchen:hover { background: var(--blue); color: white; }
    .btn-bill { flex: 1; padding: 10px 6px; border-radius: 10px; border: 1.5px solid var(--orange); background: rgba(245,158,11,0.08); color: var(--orange); font-family: 'Lato', sans-serif; font-size: 11px; font-weight: 700; cursor: pointer; transition: all 0.15s; }
    .btn-bill:hover { background: var(--orange); color: white; }
    .btn-cobrar-mesa { flex: 1.2; padding: 10px 6px; border-radius: 10px; background: linear-gradient(135deg, #0A1931, #1A3D63); color: white; border: none; font-family: 'Lato', sans-serif; font-size: 11px; font-weight: 700; cursor: pointer; transition: opacity 0.15s; }
    .btn-cobrar-mesa:hover { opacity: 0.85; }
    body.dark .comanda-panel { background: #0B1929; border-color: rgba(255,255,255,0.06); }
    body.dark .comanda-header, body.dark .comanda-total-box, body.dark .comanda-actions { background: #0F1E35; }
    body.dark .comanda-item { background: #0F1E35; border-color: rgba(255,255,255,0.06); }
    body.dark .comanda-note { background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.1); color: white; }

    /* ══ PICKER FLOAT (estilo Rappi) ══ */
    .picker-float { position: fixed; bottom: 22px; left: 50%; transform: translateX(-50%); width: 700px; max-width: calc(100vw - 36px); z-index: 203; display: none; }
    .picker-float.open { display: block; }
    .picker-fpanel { background: var(--white); border-radius: 22px 22px 0 0; overflow: hidden; max-height: 0; opacity: 0; transition: max-height 0.4s cubic-bezier(0.4,0,0.2,1), opacity 0.28s; box-shadow: 0 -8px 40px rgba(10,25,49,0.12); }
    .picker-float:hover .picker-fpanel, .picker-float.pinned .picker-fpanel { max-height: 430px; opacity: 1; }
    .picker-rows { padding: 14px 16px 8px; overflow-y: auto; max-height: 370px; display: flex; flex-direction: column; gap: 5px; }
    .picker-row { display: flex; align-items: center; gap: 11px; padding: 9px 12px; background: var(--bg); border-radius: 12px; transition: background 0.15s; }
    .picker-row:hover { background: rgba(74,127,167,0.07); }
    .pr-emoji { font-size: 22px; flex-shrink: 0; }
    .pr-info { flex: 1; min-width: 0; }
    .pr-name  { font-size: 13px; font-weight: 700; color: var(--dark); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .pr-price { font-size: 11px; color: var(--muted); }
    .pr-ctrl  { display: flex; align-items: center; gap: 6px; flex-shrink: 0; }
    .pr-btn   { width: 28px; height: 28px; border-radius: 50%; border: none; background: var(--blue); color: white; font-size: 17px; font-weight: 300; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.15s; line-height: 1; }
    .pr-btn.minus { background: var(--bg); color: var(--dark); border: 1.5px solid var(--border); }
    .pr-btn:hover { opacity: 0.82; transform: scale(1.1); }
    .pr-qty { font-size: 14px; font-weight: 700; color: var(--dark); min-width: 18px; text-align: center; }
    .picker-fbar { background: linear-gradient(135deg, #0A1931 0%, #1A3D63 100%); border-radius: 20px; padding: 13px 18px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; box-shadow: var(--shadow-gold); transition: border-radius 0.32s; }
    .picker-float:hover .picker-fbar, .picker-float.pinned .picker-fbar { border-radius: 0 0 20px 20px; }
    .pfbar-left  { display: flex; align-items: center; gap: 10px; }
    .pfbar-badge { width: 32px; height: 32px; border-radius: 10px; background: rgba(255,255,255,0.14); display: flex; align-items: center; justify-content: center; font-size: 17px; }
    .pfbar-title { font-size: 14px; font-weight: 700; color: white; }
    .pfbar-sub   { font-size: 11px; color: rgba(255,255,255,0.5); margin-top: 1px; }
    .pfbar-arrow { color: rgba(255,255,255,0.35); font-size: 17px; transition: transform 0.3s; margin-right: 4px; }
    .picker-float:hover .pfbar-arrow, .picker-float.pinned .pfbar-arrow { transform: rotate(180deg); }
    .pfbar-close { width: 30px; height: 30px; border-radius: 50%; background: rgba(255,255,255,0.12); border: none; color: white; font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .pfbar-close:hover { background: rgba(255,255,255,0.22); }
    @media (max-width: 768px) { .picker-float { width: calc(100vw - 24px); } }

    /* ══ MESA HOVER TOOLTIP ══ */
    .mesa-tooltip { position: absolute; bottom: calc(100% + 10px); left: 50%; transform: translateX(-50%); background: var(--white); border-radius: 14px; padding: 12px 14px; min-width: 200px; max-width: 250px; box-shadow: var(--shadow-lg); border: 1px solid var(--border); display: none; z-index: 50; pointer-events: none; }
    .mesa-float:hover .mesa-tooltip { display: block; }
    .mesa-tooltip-head { font-size: 12px; font-weight: 700; color: var(--dark); margin-bottom: 8px; padding-bottom: 6px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; }
    .mesa-tooltip-row { display: flex; align-items: baseline; gap: 6px; font-size: 12px; padding: 3px 0; }
    .mesa-tooltip-qty { font-weight: 700; color: var(--blue); min-width: 22px; }
    .mesa-tooltip-name { flex: 1; color: var(--dark); font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .mesa-tooltip-sub { color: var(--muted); font-size: 11px; min-width: 58px; text-align: right; }
    .mesa-tooltip-total { margin-top: 8px; padding-top: 6px; border-top: 1px solid var(--border); display: flex; justify-content: space-between; font-size: 12px; font-weight: 700; color: var(--dark); }
    .mesa-tooltip-empty { font-size: 12px; color: var(--muted); text-align: center; padding: 4px 0; }

    /* ══ COMANDA TICKET ══ */
    .comanda-ticket-overlay { position: fixed; inset: 0; background: rgba(10,25,49,0.6); z-index: 500; display: none; align-items: center; justify-content: center; padding: 20px; }
    .comanda-ticket-overlay.open { display: flex; }
    .comanda-ticket { background: white; width: 310px; border-radius: 20px; overflow: hidden; box-shadow: var(--shadow-lg); font-family: 'Courier New', monospace; }
    .ticket-top { background: var(--dark); color: white; text-align: center; padding: 18px 16px 14px; }
    .ticket-brand { font-size: 11px; letter-spacing: 2px; opacity: 0.7; font-family: 'Lato', sans-serif; }
    .ticket-mesa-num { font-size: 32px; font-weight: 900; letter-spacing: -1px; }
    .ticket-timestamp { font-size: 11px; opacity: 0.65; margin-top: 2px; font-family: 'Lato', sans-serif; }
    .ticket-body { padding: 14px 16px; }
    .ticket-hr { border: none; border-top: 2px dashed #ddd; margin: 10px 0; }
    .ticket-item { display: flex; align-items: baseline; gap: 6px; padding: 4px 0; font-size: 13px; }
    .ticket-item-qty { font-weight: 700; min-width: 26px; }
    .ticket-item-name { flex: 1; }
    .ticket-item-price { font-size: 11px; color: #777; min-width: 70px; text-align: right; }
    .ticket-nota { font-size: 11px; color: #888; padding: 1px 0 5px 26px; font-style: italic; }
    .ticket-total-row { display: flex; justify-content: space-between; font-size: 15px; font-weight: 900; padding: 4px 0; }
    .ticket-estado-badge { display: inline-block; font-size: 11px; font-family: 'Lato', sans-serif; font-weight: 700; padding: 3px 12px; border-radius: 20px; margin-top: 8px; }
    .ticket-actions { display: flex; gap: 10px; padding: 12px 16px; border-top: 1px solid #eee; }
    .btn-ticket-print { flex: 1; padding: 10px; border-radius: 10px; background: var(--dark); color: white; border: none; font-family: 'Lato', sans-serif; font-size: 13px; font-weight: 700; cursor: pointer; }
    .btn-ticket-close { flex: 1; padding: 10px; border-radius: 10px; background: var(--bg); color: var(--dark); border: 1px solid var(--border); font-family: 'Lato', sans-serif; font-size: 13px; font-weight: 700; cursor: pointer; }
    @media print { body > *:not(.comanda-ticket-overlay) { display: none !important; } .comanda-ticket-overlay { position: static !important; background: none !important; display: block !important; } .comanda-ticket { box-shadow: none !important; } .ticket-actions { display: none !important; } }

    /* ══ RUBBER BAND SELECTION ══ */
    .rubber-band { position: absolute; border: 2px dashed rgba(74,127,167,0.9); background: rgba(74,127,167,0.13); border-radius: 4px; pointer-events: none; z-index: 20; display: none; }
    .mesa-sel-check { position: absolute; top: 4px; left: 4px; width: 22px; height: 22px; background: var(--blue); border: 2px solid white; border-radius: 50%; display: none; align-items: center; justify-content: center; z-index: 10; pointer-events: none; color: white; font-size: 13px; font-weight: 900; }
    .mesa-float.selected .mesa-sel-check { display: flex; }
    .mesa-float.selected .mesa-float-img { filter: drop-shadow(0 0 14px rgba(74,127,167,0.9)) brightness(0.85) !important; }
    .salon-toolbar { gap: 10px; }
    .sel-count-label { font-size: 13px; font-weight: 700; color: white; background: rgba(255,255,255,0.15); padding: 7px 14px; border-radius: 10px; backdrop-filter: blur(4px); }
    .btn-del-sel { padding: 8px 16px; border-radius: 10px; background: var(--red); color: white; border: none; font-family: 'Lato', sans-serif; font-size: 13px; font-weight: 700; cursor: pointer; transition: opacity 0.15s; }
    .btn-del-sel:hover { opacity: 0.85; }
    .btn-cancel-sel { padding: 8px 14px; border-radius: 10px; background: rgba(255,255,255,0.18); color: white; border: 1px solid rgba(255,255,255,0.35); font-family: 'Lato', sans-serif; font-size: 13px; font-weight: 700; cursor: pointer; }

    /* ══ MESA FLOAT EXTRAS ══ */
    .mesa-float-del { position: absolute; top: -6px; right: -6px; width: 20px; height: 20px; border-radius: 50%; background: var(--red); border: none; color: white; font-size: 10px; font-weight: 700; cursor: pointer; display: none; align-items: center; justify-content: center; z-index: 5; box-shadow: 0 2px 6px rgba(239,68,68,0.4); padding: 0; }
    .mesa-float:hover .mesa-float-del { display: flex; }
    .mesa-float-total { font-size: 11px; font-weight: 700; color: var(--green); background: var(--green-dim); padding: 1px 9px; border-radius: 20px; pointer-events: none; }
    .mesa-float-open .mesa-float-img { filter: drop-shadow(0 0 14px rgba(74,127,167,0.6)) !important; }
    .mesa-float-label.en_cocina { color: var(--orange) !important; }
    .mesa-float-label.cuenta_pedida { color: var(--red) !important; }
    .status-libre { background: #ECFDF5; color: #10B981; }
    .status-en_curso { background: #FFF7ED; color: #F59E0B; }
    .status-en_cocina { background: #FFF7ED; color: #F59E0B; }
    .status-cuenta_pedida { background: #FEF2F2; color: #EF4444; }

    /* ══ MESAS VIEW ══ */
    .mesas-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 20px; padding: 24px;
    }
    .mesa-card {
      background: var(--white); border-radius: 20px;
      border: 2px solid var(--border); padding: 20px 16px 16px;
      cursor: pointer; transition: all 0.22s cubic-bezier(0.34,1.56,0.64,1);
      box-shadow: var(--shadow-sm); display: flex; flex-direction: column;
      align-items: center; text-align: center; position: relative; user-select: none;
    }
    .mesa-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-md); }
    .mesa-card.libre { border-color: rgba(16,185,129,0.25); }
    .mesa-card.libre:hover { border-color: var(--green); }
    .mesa-card.ocupada { border-color: rgba(239,68,68,0.3); background: #FFF8F8; }
    .mesa-card.ocupada:hover { border-color: var(--red); }
    .mesa-card.active-mesa { box-shadow: 0 0 0 3px var(--blue); }
    body.dark .mesa-card { background: #0F1E35; }
    body.dark .mesa-card.ocupada { background: rgba(239,68,68,0.06); }
    .mesa-img { width: 90px; height: 90px; object-fit: contain; margin-bottom: 10px; transition: transform 0.2s; }
    .mesa-card:hover .mesa-img { transform: scale(1.08); }
    .mesa-num { font-size: 15px; font-weight: 700; color: var(--dark); margin-bottom: 6px; }
    .mesa-status {
      font-size: 11px; font-weight: 600; letter-spacing: 0.3px;
      padding: 3px 10px; border-radius: 20px;
    }
    .mesa-status.libre { background: var(--green-dim); color: var(--green); }
    .mesa-status.ocupada { background: var(--red-dim); color: var(--red); }
    .mesa-total { font-size: 12px; font-weight: 700; color: var(--red); margin-top: 5px; }
    .mesa-delete {
      position: absolute; top: 10px; right: 10px; width: 22px; height: 22px;
      background: var(--red-dim); border: none; border-radius: 50%;
      color: var(--red); font-size: 10px; font-weight: 700;
      cursor: pointer; display: none; align-items: center; justify-content: center;
      transition: background 0.15s;
    }
    .mesa-card:hover .mesa-delete { display: flex; }
    .mesa-delete:hover { background: var(--red); color: white; }
    .mesa-badge {
      display: none; align-items: center; gap: 6px;
      background: rgba(74,127,167,0.18); border: 1px solid rgba(74,127,167,0.35);
      border-radius: 20px; padding: 5px 12px;
      font-size: 12px; font-weight: 700; color: var(--sand);
      cursor: pointer; white-space: nowrap; flex-shrink: 0;
      transition: background 0.15s;
    }
    .mesa-badge:hover { background: rgba(74,127,167,0.28); }

    @media print {
      .header, .categories-bar, #view-pos .pos-topbar, .products-section, .cart-float, .overlay:not(#receiptOverlay) { display: none !important; }
      #receiptOverlay { position: static; opacity: 1; pointer-events: all; background: white; display: flex !important; }
      #receiptOverlay .modal { box-shadow: none; transform: none; max-height: none; }
      .btn-print, .btn-new { display: none; }
    }

    /* ══ AUTH OVERLAY ══ */
    .auth-overlay {
      position: fixed; inset: 0; z-index: 9999;
      background: var(--bg);
      display: none; align-items: center; justify-content: center;
    }
    .auth-card {
      background: var(--white); border-radius: 24px; padding: 40px 40px 36px;
      width: 100%; max-width: 400px;
      box-shadow: var(--shadow-lg); border: 1px solid rgba(74,127,167,0.15);
    }
    .auth-logo { display: flex; align-items: center; gap: 10px; justify-content: center; margin-bottom: 28px; }
    .auth-logo-mark {
      width: 42px; height: 42px; background: linear-gradient(135deg, #4A7FA7, #4A7FA7);
      border-radius: 13px; display: flex; align-items: center; justify-content: center;
      font-size: 20px; box-shadow: 0 3px 12px rgba(74,127,167,0.40);
    }
    .auth-logo-name { font-size: 24px; font-weight: 700; color: var(--dark); }
    .auth-logo-name em { font-style: italic; color: var(--gold); }
    .auth-tabs {
      display: flex; margin-bottom: 24px;
      border: 1.5px solid var(--border); border-radius: 10px; overflow: hidden;
    }
    .auth-tab {
      flex: 1; padding: 9px; background: transparent; border: none;
      font-family: 'Lato', sans-serif; font-size: 13px; font-weight: 600;
      color: var(--muted); cursor: pointer; transition: all 0.18s;
    }
    .auth-tab.active { background: var(--dark); color: white; }
    .auth-field { margin-bottom: 16px; }
    .auth-field label {
      display: block; font-size: 11px; font-weight: 700; color: var(--mid);
      margin-bottom: 6px; letter-spacing: 0.5px; text-transform: uppercase;
    }
    .auth-field input {
      width: 100%; padding: 11px 14px; background: var(--bg);
      border: 1.5px solid var(--border); border-radius: 10px;
      font-family: 'Lato', sans-serif; font-size: 14px; color: var(--dark); outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .auth-field input:focus { border-color: var(--gold); box-shadow: 0 0 0 3px rgba(74,127,167,0.12); }
    .auth-btn {
      width: 100%; padding: 13px; background: linear-gradient(135deg, #0A1931, #1A3D63);
      color: white; border: none; border-radius: 12px;
      font-family: 'Lato', sans-serif; font-size: 15px; font-weight: 700;
      cursor: pointer; margin-top: 8px; transition: opacity 0.15s, transform 0.15s;
      box-shadow: 0 4px 16px rgba(10,25,49,0.25);
    }
    .auth-btn:hover { opacity: 0.9; transform: translateY(-1px); }
    .auth-btn:disabled { opacity: 0.55; cursor: not-allowed; transform: none; }
    .auth-error {
      background: var(--red-dim); border: 1px solid rgba(239,68,68,0.2);
      border-radius: 8px; padding: 10px 14px; color: var(--red);
      font-size: 13px; font-weight: 500; margin-bottom: 14px; display: none;
    }
    .auth-error.show { display: block; }
    .auth-sub { text-align: center; font-size: 12px; color: var(--muted); margin-top: 16px; }
    .signout-btn {
      background: transparent; border: none; cursor: pointer; padding: 6px 10px;
      border-radius: 8px; font-size: 11px; color: rgba(255,255,255,0.5);
      font-family: 'Lato', sans-serif; transition: all 0.15s;
    }
    .signout-btn:hover { background: rgba(255,255,255,0.08); color: rgba(255,255,255,0.9); }
    body.dark .auth-card { background: rgba(8,20,45,0.97); border-color: rgba(74,127,167,0.20); }
    body.dark .auth-field input { background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.1); color: white; }

    /* ══ ROLE OVERLAY ══ */
    .role-overlay {
      position: fixed; inset: 0; z-index: 9998;
      background: var(--bg);
      display: none; align-items: center; justify-content: center;
    }
    .role-card {
      background: var(--white); border-radius: 24px; padding: 40px;
      width: 100%; max-width: 420px;
      box-shadow: var(--shadow-lg); border: 1px solid rgba(74,127,167,0.15);
      text-align: center;
    }
    .role-title { font-size: 20px; font-weight: 700; color: var(--dark); margin-bottom: 6px; }
    .role-subtitle { font-size: 13px; color: var(--muted); margin-bottom: 28px; }
    .role-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px; }
    .role-btn {
      padding: 24px 16px; border-radius: 16px; border: 2px solid var(--border);
      background: var(--bg); cursor: pointer; transition: all 0.2s;
      display: flex; flex-direction: column; align-items: center; gap: 8px;
    }
    .role-btn:hover { border-color: var(--gold); background: rgba(74,127,167,0.06); transform: translateY(-2px); }
    .role-btn.selected { border-color: var(--gold); background: rgba(74,127,167,0.10); }
    .role-btn-icon { font-size: 32px; }
    .role-btn-label { font-size: 14px; font-weight: 700; color: var(--dark); }
    .role-btn-desc { font-size: 11px; color: var(--muted); }
    .role-pin-section { display: none; }
    .role-pin-section.show { display: block; animation: fadeIn 0.2s ease; }
    .role-pin-label { font-size: 11px; font-weight: 700; color: var(--mid); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
    .role-pin-input {
      width: 100%; padding: 13px 14px; background: var(--bg);
      border: 2px solid var(--border); border-radius: 12px;
      font-family: 'Lato', sans-serif; font-size: 24px; font-weight: 700;
      color: var(--dark); outline: none; text-align: center; letter-spacing: 10px;
      transition: border-color 0.2s; box-sizing: border-box;
    }
    .role-pin-input:focus { border-color: var(--gold); }
    .role-enter-btn {
      width: 100%; padding: 13px; background: linear-gradient(135deg, #0A1931, #1A3D63);
      color: white; border: none; border-radius: 12px;
      font-family: 'Lato', sans-serif; font-size: 15px; font-weight: 700;
      cursor: pointer; margin-top: 12px; transition: opacity 0.15s, transform 0.15s;
      box-shadow: 0 4px 16px rgba(10,25,49,0.25);
    }
    .role-enter-btn:hover { opacity: 0.9; transform: translateY(-1px); }
    .role-error { color: var(--red); font-size: 13px; font-weight: 600; margin-top: 10px; min-height: 18px; }
    .role-badge {
      display: inline-flex; align-items: center; gap: 4px;
      padding: 3px 10px; border-radius: 20px; font-size: 10px; font-weight: 700;
      text-transform: uppercase; letter-spacing: 0.5px; cursor: default;
    }
    .role-badge.admin { background: rgba(74,127,167,0.25); color: var(--gold); }
    .role-badge.cajero { background: rgba(74,222,128,0.18); color: #4ade80; }
    .change-role-btn {
      background: transparent; border: 1px solid rgba(255,255,255,0.15); cursor: pointer;
      padding: 5px 9px; border-radius: 8px; font-size: 10px; color: rgba(255,255,255,0.45);
      font-family: 'Lato', sans-serif; transition: all 0.15s; white-space: nowrap;
    }
    .change-role-btn:hover { background: rgba(255,255,255,0.08); color: rgba(255,255,255,0.85); }
    body.dark .role-card { background: rgba(8,20,45,0.97); border-color: rgba(74,127,167,0.20); }
    body.dark .role-btn { background: rgba(255,255,255,0.04); border-color: rgba(255,255,255,0.1); }
    body.dark .role-btn:hover { border-color: var(--gold); background: rgba(74,127,167,0.10); }
    body.dark .role-pin-input { background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.1); color: white; }

    /* ══ BOTTOM NAV ══ */
    .bottom-nav {
      display: none;
      position: fixed; bottom: 0; left: 0; right: 0; z-index: 55;
      height: 62px;
      background: linear-gradient(135deg, #0A1931 0%, #1A3D63 100%);
      box-shadow: 0 -2px 20px rgba(10,25,49,0.35);
      align-items: center; justify-content: space-around;
      padding: 0 4px;
    }
    .bn-tab {
      display: flex; flex-direction: column; align-items: center; gap: 3px;
      flex: 1; padding: 8px 4px; border-radius: 10px;
      background: transparent; border: none;
      font-family: 'Lato', sans-serif; font-size: 9px; font-weight: 700;
      color: rgba(255,255,255,0.45); cursor: pointer;
      transition: all 0.18s; letter-spacing: 0.3px; text-transform: uppercase;
    }
    .bn-tab.active { color: var(--sand); background: rgba(74,127,167,0.14); }
    .bn-tab svg { opacity: 0.7; }
    .bn-tab.active svg { opacity: 1; }

    /* ══ RESPONSIVE ══ */
    @media (max-width: 640px) {
      /* Header: hide nav & extras */
      .nav-tabs { display: none; }
      .header { padding: 0 14px; gap: 10px; }
      .datetime-time, .datetime-date { font-size: 13px; }
      .cashier-name { display: none; }
      .datetime-block { display: none; }
      .signout-btn { padding: 6px 8px; font-size: 14px; }
      .signout-btn .signout-text { display: none; }
      .change-role-btn { padding: 4px 7px; font-size: 10px; }

      /* Show bottom nav */
      .bottom-nav { display: flex; }

      /* Main gets bottom padding for bottom nav */
      main { padding-bottom: 62px; }

      /* POS topbar */
      .pos-topbar { padding: 10px 12px; gap: 8px; }
      .search-box { min-width: 0; max-width: none; flex: 1; padding: 7px 12px; }
      .cats-scroll { padding: 2px 0; }
      .cat-pill { padding: 7px 13px; font-size: 12px; }

      /* Products grid: 2 columns */
      .products-section { padding: 12px 10px 20px; }
      .products-grid { grid-template-columns: repeat(2, 1fr); gap: 8px; }
      .product-card { padding: 14px 10px 12px; border-radius: 16px; }
      .p-emoji { font-size: 36px; margin-bottom: 8px; }
      .p-name { font-size: 12px; }
      .p-price { font-size: 15px; }
      .p-stock { font-size: 9px; }
      .card-add-btn { padding: 7px 4px; font-size: 12px; }

      /* Cart: sit above bottom nav */
      .cart-float { bottom: 64px; left: 8px; right: 8px; width: auto; transform: none; max-width: none; }
      .cart-bar { border-radius: 14px; padding: 10px 14px; }
      .btn-pagar { padding: 10px 18px; font-size: 13px; }
      .cart-panel { border-radius: 14px 14px 0 0; max-height: 60vh; }

      /* Modals slide up from bottom */
      .overlay { align-items: flex-end; }
      .modal { border-radius: 22px 22px 0 0; max-height: 90vh; width: 100%; max-width: 100%; overflow-y: auto; }
      .modal.wide { max-width: 100%; }

      /* Inventory */
      .view-content { padding: 14px 12px; }
      .page-title { font-size: 22px; }
      .page-header { margin-bottom: 14px; }
      .inv-table-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; }
      .inv-search { min-width: 0; flex: 1; }
      .inv-table th, .inv-table td { padding: 10px 12px; font-size: 12px; }

      /* Stats & reports */
      .stats-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
      .reports-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
      .stat-card { padding: 14px; }
      .stat-card-value { font-size: 22px; letter-spacing: -0.5px; }
      .two-col { grid-template-columns: 1fr !important; }
      .section-card { padding: 16px; }

      /* Auth card */
      .auth-overlay { align-items: center; padding: 16px; }
      .auth-card { padding: 28px 22px; border-radius: 20px; }

      /* Evitar zoom en iOS al tocar inputs */
      input, select, textarea { font-size: 16px !important; }
    }

    @media (max-width: 380px) {
      .products-grid { gap: 6px; }
      .p-emoji { font-size: 30px; }
      .product-card { padding: 12px 8px 10px; }
    }
  </style>
</head>
<body>
<div class="noise-layer" aria-hidden="true"></div>

<!-- ═══ HEADER ═══ -->
<header class="header">
  <div class="logo">
    <div class="logo-mark">💲</div>
    <div class="logo-name" id="logoName">Like<em>Pos</em></div>
  </div>

  <nav class="nav-tabs">
    <button class="nav-tab active" data-view="pos" data-mode-tienda onclick="goTo('pos')">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 01-8 0"/></svg>
      POS / Venta
    </button>
    <button class="nav-tab" data-view="salon" data-mode-rest onclick="goTo('salon')" style="display:none">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><rect x="1" y="5" width="22" height="3" rx="1"/><path d="M4 8v11M20 8v11M7 14h10"/></svg>
      Salón
    </button>
    <button class="nav-tab" data-view="pos" data-mode-rest onclick="goTo('pos')" style="display:none">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
      Carta
    </button>
    <button class="nav-tab" data-view="inventory" onclick="goTo('inventory')">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><rect x="2" y="3" width="20" height="14" rx="2"/><path d="M8 21h8M12 17v4"/></svg>
      Inventario
    </button>
    <button class="nav-tab" data-view="cierre" onclick="goTo('cierre')">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
      Cierre de Caja
    </button>
    <button class="nav-tab" data-view="reports" onclick="goTo('reports')">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
      Reportes
    </button>
  </nav>

  <div class="header-right">
    <div class="datetime-block">
      <div class="datetime-time" id="clock">--:--</div>
      <div class="datetime-date" id="dateDisplay">--</div>
    </div>
    <div class="cashier-pill">
      <div class="cashier-av" id="cashierInitial">?</div>
      <span class="cashier-name" id="cashierName">...</span>
    </div>
    <span id="roleBadge" class="role-badge admin" style="display:none">Admin</span>
    <button class="change-role-btn" id="changeRoleBtn" onclick="showRoleOverlay()" style="display:none">⇄ Rol</button>
    <button class="signout-btn" onclick="signOut()" title="Cerrar sesión">⏻ <span class="signout-text">Salir</span></button>
    <button class="theme-btn" id="themeBtn" onclick="toggleTheme()" title="Modo oscuro">🌙</button>
  </div>
</header>

<main>
  <!-- ═══ POS VIEW ═══ -->
  <div id="view-pos" class="view active">
    <div class="pos-topbar">
      <div class="search-box">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
        <input type="text" id="searchInput" placeholder="Buscar producto...">
      </div>
      <div class="cats-scroll" id="categoriesBar"></div>
      <span class="mesa-badge" id="mesaBadge" onclick="goTo('mesas')" title="Volver a mesas"></span>
      <button class="btn-cat-manage" onclick="openCatsModal()" title="Gestionar categorías">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
      </button>
    </div>
    <div class="products-section">
      <div class="section-meta" id="sectionMeta"></div>
      <div class="products-grid" id="productsGrid"></div>
    </div>
  </div>

  <!-- ═══ INVENTORY VIEW ═══ -->
  <div id="view-inventory" class="view">
    <div class="view-content">
      <div class="page-header">
        <div>
          <div class="page-title">Inventario</div>
          <div class="page-subtitle">Gestiona tus productos, precios y stock</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <div style="display:flex;align-items:center;gap:7px;background:var(--white);border:1.5px solid var(--border);border-radius:10px;padding:6px 12px">
            <span style="font-size:12px;font-weight:700;color:var(--muted)">IVA</span>
            <input type="number" id="ivaInput" min="0" max="100" step="0.5"
              style="width:44px;border:none;background:transparent;font-family:'Lato',sans-serif;font-size:14px;font-weight:700;color:var(--dark);outline:none;text-align:center"
              oninput="updateIva(this.value)">
            <span style="font-size:12px;color:var(--muted)">%</span>
          </div>
          <button class="btn-outline btn-sm" onclick="openCatsModal()">🏷️ Categorías</button>
          <button class="btn-primary" onclick="openProductModal()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            Nuevo Producto
          </button>
        </div>
      </div>
      <div class="inv-filters">
        <div class="inv-search">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" opacity="0.5"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
          <input type="text" id="invSearchInput" placeholder="Buscar en inventario...">
        </div>
        <div id="invCatFilters"></div>
      </div>
      <div class="inv-table-wrap">
        <table class="inv-table">
          <thead>
            <tr>
              <th>Producto</th><th>Categoría</th><th>Costo</th><th>Precio venta</th><th>Stock</th><th>Acciones</th>
            </tr>
          </thead>
          <tbody id="invTableBody"></tbody>
        </table>
      </div>

    </div>
  </div>

  <!-- ═══ CIERRE VIEW ═══ -->
  <div id="view-cierre" class="view">
    <div class="view-content">
      <div class="page-header">
        <div>
          <div class="page-title">Cierre de Caja</div>
          <div class="page-subtitle" id="cierreDate">--</div>
        </div>
        <div style="display:flex;gap:10px;align-items:center" id="cierreActions">
          <button class="btn-secondary" onclick="changeAdminPin()" style="font-size:12px;padding:7px 14px" title="Cambiar PIN de administrador">🔑 Cambiar PIN</button>
        </div>
      </div>
      <div id="cierreBanner"></div>
      <div class="stats-grid" id="cierreStats"></div>
      <div class="section-card">
        <div class="section-card-title">Ventas de hoy</div>
        <div id="cierreSalesList"></div>
      </div>
    </div>
  </div>

  <!-- ═══ REPORTS VIEW ═══ -->
  <div id="view-reports" class="view">
    <div class="view-content">
      <div class="page-header">
        <div>
          <div class="page-title">Reportes</div>
          <div class="page-subtitle">Análisis de ventas y ganancias</div>
        </div>
      </div>
      <div class="report-filters" id="reportFilters">
        <button class="rf-btn active" data-range="today" onclick="setReportRange('today')">Hoy</button>
        <button class="rf-btn" data-range="week" onclick="setReportRange('week')">Esta semana</button>
        <button class="rf-btn" data-range="month" onclick="setReportRange('month')">Este mes</button>
        <button class="rf-btn" data-range="all" onclick="setReportRange('all')">Todo</button>
      </div>
      <div class="reports-grid" id="reportKPIs"></div>
      <div class="two-col">
        <div class="section-card">
          <div class="section-card-title">Top productos</div>
          <div class="bar-chart" id="chartTopProducts"></div>
        </div>
        <div class="section-card">
          <div class="section-card-title">Método de pago</div>
          <div class="bar-chart" id="chartMethods"></div>
        </div>
      </div>
      <div class="section-card">
        <div class="section-card-title">Ingresos por día</div>
        <div class="bar-chart" id="chartDays"></div>
      </div>
    </div>
  </div>

  <!-- ═══ SALON VIEW (Restaurante) ═══ -->
  <div id="view-salon" class="view">
    <div class="salon-wrap">
      <div class="salon-toolbar" id="salonToolbar"></div>
      <div class="salon-canvas" id="salonCanvas">
        <svg id="salonSvg" class="salon-svg"></svg>
      </div>
    </div>
  </div>

  <!-- ═══ MESAS VIEW ═══ -->
  <div id="view-mesas" class="view">
    <div class="view-content">
      <div class="page-header">
        <div>
          <div class="page-title">Mesas</div>
          <div class="page-subtitle">Selecciona una mesa para tomar el pedido</div>
        </div>
        <button class="btn-primary" onclick="addMesa()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          Nueva Mesa
        </button>
      </div>
      <div class="mesas-grid" id="mesasGrid"></div>
    </div>
  </div>

</main>

<!-- ═══ FLOATING CART ═══ -->
<div class="cart-float" id="cartFloat">
  <div class="cart-panel">
    <div class="cart-panel-top">
      <div class="cp-header">
        <span class="cp-title">Tu pedido</span>
        <button class="cp-clear" onclick="clearCart()">Vaciar todo</button>
      </div>
      <div class="cart-list" id="cartList"></div>
    </div>
    <div class="cart-totals-row" id="cartTotals"></div>
  </div>
  <div class="cart-bar" id="cartBar">
    <div class="cb-left">
      <div class="cb-badge" id="cbBadge">0</div>
      <div class="cb-info">
        <span class="cb-items" id="cbItems">0 productos</span>
        <span class="cb-total" id="cbTotal">$ 0</span>
      </div>
    </div>
    <div class="cb-right">
      <span class="cb-arrow">▾</span>
      <button class="btn-pagar" onclick="openPayment(event)">
        Pagar
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
      </button>
    </div>
  </div>
</div>

<!-- ═══ PAYMENT MODAL ═══ -->
<div class="overlay" id="payOverlay">
  <div class="modal">
    <div class="modal-title">Cobrar pedido</div>
    <div class="modal-sub">Orden #<span id="orderNum">—</span></div>
    <div class="total-box">
      <div class="total-box-lbl">Total a pagar</div>
      <div class="total-box-amt" id="modalTotal">$ 0</div>
      <div class="total-box-break" id="modalBreak"></div>
    </div>
    <div class="slabel">Método de pago</div>
    <div class="pay-grid">
      <button class="pay-btn active" id="btn-efectivo" onclick="selectMethod('efectivo')"><span class="icon">💵</span><span class="label">Efectivo</span></button>
      <button class="pay-btn" id="btn-tarjeta" onclick="selectMethod('tarjeta')"><span class="icon">💳</span><span class="label">Tarjeta</span></button>
      <button class="pay-btn" id="btn-transferencia" onclick="selectMethod('transferencia')"><span class="icon">📲</span><span class="label">Nequi / Daviplata</span></button>
    </div>
    <div id="cashSection">
      <div class="slabel">Recibido</div>
      <div class="cash-field">
        <span class="cash-sym">$</span>
        <input type="number" id="cashInput" placeholder="0" oninput="calcChange()">
      </div>
      <div class="quick-amts" id="quickAmts"></div>
      <div class="change-row" id="changeRow" style="display:none">
        <span class="change-lbl">💰 Cambio a devolver</span>
        <span class="change-amt" id="changeAmt">$ 0</span>
      </div>
    </div>
    <div class="modal-btns">
      <button class="btn-cancel" onclick="closePayment()">Cancelar</button>
      <button class="btn-confirm" onclick="confirmPayment()">✓ Confirmar pago</button>
    </div>
  </div>
</div>

<!-- ═══ RECEIPT MODAL ═══ -->
<div class="overlay" id="receiptOverlay">
  <div class="modal">
    <div class="receipt-header">
      <div class="receipt-brand" id="receiptBrand">LikePos</div>
      <div class="receipt-info">Tienda Principal · NIT: 900.123.456-7<br>Calle 10 #5-40, Yopal, Casanare · Tel: (608) 555-0000</div>
    </div>
    <div id="receiptBody"></div>
    <div class="receipt-footer">¡Gracias por su compra! Vuelva pronto 🛍️</div>
    <button class="btn-print" onclick="window.print()">🖨️ Imprimir recibo</button>
    <button class="btn-new" onclick="newSale()">+ Nueva venta</button>
  </div>
</div>

<!-- ═══ PRODUCT MODAL ═══ -->
<div class="overlay" id="productOverlay">
  <div class="modal wide">
    <div class="modal-title" id="productModalTitle">Nuevo Producto</div>
    <div class="modal-sub">Completa los datos del producto</div>
    <input type="hidden" id="productId">
    <div class="form-grid" style="margin-bottom:14px">
      <div class="field">
        <label>Emoji / Icono</label>
        <input type="text" id="pEmoji" placeholder="📦" maxlength="4" oninput="emojiManual=true">
      </div>
      <div class="field">
        <label>Nombre del producto *</label>
        <input type="text" id="pName" placeholder="Ej: Camiseta Básica" oninput="suggestEmoji(this.value)">
      </div>
    </div>
    <div class="form-grid" style="margin-bottom:14px">
      <div class="field">
        <label>Categoría *</label>
        <select id="pCat"></select>
      </div>
      <div class="field">
        <label>Precio de costo (COP)</label>
        <input type="number" id="pCost" placeholder="20000" min="0">
      </div>
    </div>
    <div class="form-grid" style="margin-bottom:14px">
      <div class="field">
        <label>Precio de venta (COP) *</label>
        <input type="number" id="pPrice" placeholder="35000" min="0">
      </div>
      <div class="field">
        <label>Descuento (%)</label>
        <input type="number" id="pDiscount" placeholder="0" min="0" max="90">
      </div>
    </div>
    <div class="form-grid" style="margin-bottom:22px">
      <div class="field">
        <label>Stock disponible</label>
        <input type="number" id="pStock" placeholder="100" min="0">
      </div>
    </div>
    <div class="modal-btns">
      <button class="btn-cancel" onclick="closeProductModal()">Cancelar</button>
      <button class="btn-confirm" onclick="saveProduct()">Guardar producto</button>
    </div>
  </div>
</div>

<!-- ═══ CONFIRM MODAL ═══ -->
<div class="overlay" id="confirmOverlay">
  <div class="modal" style="text-align:center;padding:36px">
    <div class="confirm-icon" id="confirmIcon">⚠️</div>
    <div class="modal-title" style="text-align:center" id="confirmTitle">¿Estás seguro?</div>
    <div class="confirm-text" id="confirmText" style="margin-top:8px"></div>
    <div class="confirm-sub" id="confirmSub"></div>
    <div class="modal-btns" style="margin-top:24px">
      <button class="btn-cancel" onclick="closeConfirm()">Cancelar</button>
      <button id="confirmBtn" class="btn-danger" onclick="doConfirm()">Confirmar</button>
    </div>
  </div>
</div>

<!-- ═══ CATEGORIES MODAL ═══ -->
<div class="overlay" id="catsOverlay">
  <div class="modal wide">
    <div class="modal-title">Categorías</div>
    <div class="modal-sub">Agrega o elimina categorías de tu tienda</div>
    <div class="slabel" style="margin-bottom:10px">Categorías actuales</div>
    <div class="cats-chips-wrap" id="catsChips"></div>
    <div class="slabel" style="margin-bottom:10px">Nueva categoría</div>
    <div class="cats-add-row">
      <div class="field" style="width:82px">
        <label>Ícono</label>
        <input type="text" id="newCatIcon" placeholder="🏷️" maxlength="4">
      </div>
      <div class="field" style="flex:1">
        <label>Nombre *</label>
        <input type="text" id="newCatName" placeholder="Ej: Juguetes" onkeydown="if(event.key==='Enter')addCat()">
      </div>
      <button class="btn-primary" onclick="addCat()" style="flex-shrink:0;align-self:flex-end">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        Agregar
      </button>
    </div>
    <div class="modal-btns" style="margin-top:24px">
      <button class="btn-confirm" onclick="closeCatsModal()">Listo</button>
    </div>
  </div>
</div>

<!-- ═══ BOTTOM NAV (mobile) ═══ -->
<nav class="bottom-nav" id="bottomNav">
  <button class="bn-tab active" data-view="pos" data-mode-tienda onclick="goTo('pos')">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 002 1.61h9.72a2 2 0 002-1.61L23 6H6"/></svg>
    POS
  </button>
  <button class="bn-tab" data-view="salon" data-mode-rest onclick="goTo('salon')" style="display:none">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="5" width="22" height="3" rx="1"/><path d="M4 8v11M20 8v11M7 14h10"/></svg>
    Salón
  </button>
  <button class="bn-tab" data-view="pos" data-mode-rest onclick="goTo('pos')" style="display:none">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
    Carta
  </button>
  <button class="bn-tab" data-view="inventory" onclick="goTo('inventory')">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/></svg>
    Inventario
  </button>
  <button class="bn-tab" data-view="cierre" onclick="goTo('cierre')">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
    Cierre
  </button>
  <button class="bn-tab" data-view="reports" onclick="goTo('reports')">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
    Reportes
  </button>
</nav>

<!-- ═══ MODE SELECTION OVERLAY ═══ -->
<div class="mode-overlay" id="modeOverlay">
  <div class="mode-card">
    <div class="auth-logo" style="margin-bottom:20px">
      <div class="auth-logo-mark">💲</div>
      <div class="auth-logo-name">Like<em>Pos</em></div>
    </div>
    <div class="mode-title">¿Qué tipo de negocio?</div>
    <div class="mode-subtitle">Selecciona el modo para esta sesión</div>
    <div class="mode-buttons">
      <button class="mode-btn" onclick="selectMode('tienda')">
        <span class="mode-btn-icon">🛒</span>
        <span class="mode-btn-label">Tienda</span>
        <span class="mode-btn-desc">POS para tienda, venta directa</span>
      </button>
      <button class="mode-btn" onclick="selectMode('restaurante')">
        <span class="mode-btn-icon">🍽️</span>
        <span class="mode-btn-label">Restaurante</span>
        <span class="mode-btn-desc">Mesas, comandas y cocina</span>
      </button>
    </div>
  </div>
</div>

<!-- ═══ ONBOARDING OVERLAY (solo en registro nuevo) ═══ -->
<div class="onboarding-overlay" id="onboardingOverlay">
  <div class="onboarding-card">
    <div class="auth-logo" style="margin-bottom:20px">
      <div class="auth-logo-mark">💲</div>
      <div class="auth-logo-name">Like<em>Pos</em></div>
    </div>
    <div class="onboarding-title">¡Bienvenido!</div>
    <div class="onboarding-subtitle">Cuéntanos sobre tu negocio para personalizar tu experiencia</div>
    <div class="onboarding-field">
      <label for="onboardingBizName">Nombre del negocio o restaurante</label>
      <input type="text" id="onboardingBizName" class="onboarding-input" placeholder="Ej: El Buen Sabor, Tienda Mi Gente..." maxlength="50">
    </div>
    <div class="onboarding-section-label">¿Qué tipo de negocio tienes?</div>
    <div class="mode-buttons">
      <button class="onboarding-mode-btn" id="onboardingBtnTienda" onclick="selectOnboardingMode('tienda')">
        <span class="mode-btn-icon">🛒</span>
        <span class="mode-btn-label">Tienda</span>
        <span class="mode-btn-desc">POS para tienda, venta directa</span>
      </button>
      <button class="onboarding-mode-btn" id="onboardingBtnRestaurante" onclick="selectOnboardingMode('restaurante')">
        <span class="mode-btn-icon">🍽️</span>
        <span class="mode-btn-label">Restaurante</span>
        <span class="mode-btn-desc">Mesas, comandas y cocina</span>
      </button>
    </div>
    <button class="onboarding-btn-confirm" onclick="confirmOnboarding()">Comenzar →</button>
  </div>
</div>

<!-- ═══ COMANDA PANEL (Restaurante) ═══ -->
<div class="comanda-bg" id="comandaBg" onclick="closeComanda()"></div>
<div class="comanda-panel" id="comandaPanel">
  <div class="comanda-header">
    <div>
      <div class="comanda-mesa-name" id="comandaMesaName">Mesa 1</div>
      <span class="comanda-status-badge" id="comandaStatusBadge"></span>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <button class="btn-kitchen" style="flex:none;padding:7px 12px;font-size:11px" onclick="showComandaTicket()">📋 Comanda</button>
      <button class="comanda-close" onclick="closeComanda()">✕</button>
    </div>
  </div>
  <div class="comanda-items" id="comandaItems"></div>
  <button class="btn-add-items" onclick="openPickerFloat()">＋ Agregar productos al pedido</button>
  <div class="comanda-total-box" id="comandaTotalBox"></div>
  <div class="comanda-actions">
    <button class="btn-kitchen" onclick="sendToKitchen()">🍳 A Cocina</button>
    <button class="btn-bill" onclick="requestBill()">🧾 Cuenta</button>
    <button class="btn-cobrar-mesa" onclick="payMesa()">💳 Cobrar</button>
  </div>
</div>

<!-- ═══ PRODUCT PICKER FLOAT (Restaurante) ═══ -->
<div class="picker-float" id="pickerFloat">
  <div class="picker-fpanel">
    <div class="picker-rows" id="pickerRows"></div>
  </div>
  <div class="picker-fbar" onclick="document.getElementById('pickerFloat').classList.toggle('pinned')">
    <div class="cb-left">
      <div class="cb-badge" id="pfBadge">0</div>
      <div class="cb-info">
        <span class="cb-items" id="pfMesa">Mesa —</span>
        <span class="cb-total" id="pfTotal">$ 0</span>
      </div>
    </div>
    <div class="cb-right">
      <span class="pfbar-arrow">▾</span>
      <button class="pfbar-close" onclick="event.stopPropagation(); closePickerFloat()">✕</button>
    </div>
  </div>
</div>

<!-- ═══ COMANDA TICKET OVERLAY ═══ -->
<div class="comanda-ticket-overlay" id="comandaTicketOverlay" onclick="if(event.target===this)closeComandaTicket()">
  <div class="comanda-ticket">
    <div class="ticket-top">
      <div class="ticket-brand">COMANDA DE COCINA</div>
      <div class="ticket-mesa-num" id="ticketMesaNum">Mesa 1</div>
      <div class="ticket-timestamp" id="ticketTime">--:--</div>
    </div>
    <div class="ticket-body" id="ticketBody"></div>
    <div class="ticket-actions">
      <button class="btn-ticket-print" onclick="window.print()">🖨️ Imprimir</button>
      <button class="btn-ticket-close" onclick="closeComandaTicket()">Cerrar</button>
    </div>
  </div>
</div>

<!-- ═══ AUTH OVERLAY ═══ -->
<div class="auth-overlay" id="authOverlay">
  <div class="auth-card">
    <div class="auth-logo">
      <div class="auth-logo-mark">💲</div>
      <div class="auth-logo-name">Like<em>Pos</em></div>
    </div>
    <div class="auth-tabs">
      <button class="auth-tab active" id="tabLogin" onclick="switchAuthTab('login')">Iniciar sesión</button>
      <button class="auth-tab" id="tabRegister" onclick="switchAuthTab('register')">Registrarse</button>
    </div>
    <div class="auth-error" id="authError"></div>
    <div class="auth-field">
      <label>Usuario</label>
      <input type="text" id="authEmail" placeholder="Ej: juantienda" autocomplete="username"
        onkeydown="if(event.key==='Enter') document.getElementById('authPassword').focus()">
    </div>
    <div class="auth-field">
      <label>Contraseña</label>
      <input type="password" id="authPassword" placeholder="••••••••"
        onkeydown="if(event.key==='Enter') submitAuth()">
    </div>
    <button class="auth-btn" id="authSubmitBtn" onclick="submitAuth()">Entrar</button>
    <div class="auth-sub" id="authSubText">
      ¿No tienes cuenta? <a href="#" onclick="switchAuthTab('register'); return false;" style="color:var(--gold);font-weight:700">Regístrate gratis</a>
    </div>
  </div>
</div>

<!-- ═══ ROLE OVERLAY ═══ -->
<div class="role-overlay" id="roleOverlay">
  <div class="role-card">
    <div class="auth-logo" style="margin-bottom:20px">
      <div class="auth-logo-mark">💲</div>
      <div class="auth-logo-name">Like<em>Pos</em></div>
    </div>
    <div class="role-title">¿Cómo vas a trabajar hoy?</div>
    <div class="role-subtitle">Elige tu rol para continuar</div>
    <div class="role-buttons">
      <button class="role-btn" id="roleBtnCajero" onclick="selectRole('cajero')">
        <span class="role-btn-icon">🛒</span>
        <span class="role-btn-label">Cajero</span>
        <span class="role-btn-desc">Solo ventas</span>
      </button>
      <button class="role-btn" id="roleBtnAdmin" onclick="selectRole('admin')">
        <span class="role-btn-icon">⚙️</span>
        <span class="role-btn-label">Administrador</span>
        <span class="role-btn-desc">Acceso completo</span>
      </button>
    </div>
    <div class="role-pin-section" id="rolePinSection">
      <div class="role-pin-label">PIN de administrador</div>
      <input type="password" class="role-pin-input" id="rolePinInput" maxlength="6"
        placeholder="••••" inputmode="numeric"
        onkeydown="if(event.key==='Enter') confirmRole()">
      <button class="role-enter-btn" onclick="confirmRole()">Entrar como Administrador</button>
      <div class="role-error" id="roleError"></div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* ═══════════════════════════════════════════
   SUPABASE
═══════════════════════════════════════════ */
const SUPABASE_URL  = 'https://uegaxpaejvjjwqnyurpx.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVlZ2F4cGFlanZqandxbnl1cnB4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE3OTA5MTMsImV4cCI6MjA4NzM2NjkxM30.gtht8IbRcjzO97TymeMIOVALVRq6c38u_-JJYrWXSOk';
const _sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
let currentUser = null;
let currentRole  = null;
const PIN_KEY    = 'flowpos_admin_pin';

/* ═══════════════════════════════════════════
   DATA
═══════════════════════════════════════════ */
const DEFAULT_CATS = [
  { id: 'ropa',        label: 'Ropa',        icon: '👔' },
  { id: 'calzado',     label: 'Calzado',     icon: '👟' },
  { id: 'accesorios',  label: 'Accesorios',  icon: '👜' },
  { id: 'electronica', label: 'Electrónica', icon: '📱' },
  { id: 'hogar',       label: 'Hogar',       icon: '🏠' },
  { id: 'ofertas',     label: 'Ofertas 🔥',  icon: '🏷️' },
];
let CATS = [];

const DEFAULT_PRODUCTS = [
  { id: 'def-01', name: 'Camiseta Básica',    price: 35000,  emoji: '👕', cat: 'ropa',        stock: 50 },
  { id: 'def-02', name: 'Pantalón Clásico',   price: 89000,  emoji: '👖', cat: 'ropa',        stock: 30 },
  { id: 'def-03', name: 'Vestido Casual',     price: 75000,  emoji: '👗', cat: 'ropa',        stock: 20 },
  { id: 'def-04', name: 'Chaqueta Denim',     price: 125000, emoji: '🧥', cat: 'ropa',        stock: 15 },
  { id: 'def-05', name: 'Camisa Formal',      price: 68000,  emoji: '👔', cat: 'ropa',        stock: 25 },
  { id: 'def-06', name: 'Sudadera',           price: 82000,  emoji: '🩱', cat: 'ropa',        stock: 18 },
  { id: 'def-07', name: 'Zapatillas Deporte', price: 180000, emoji: '👟', cat: 'calzado',     stock: 12 },
  { id: 'def-08', name: 'Botas Cuero',        price: 248000, emoji: '🥾', cat: 'calzado',     stock: 8  },
  { id: 'def-09', name: 'Sandalias Verano',   price: 95000,  emoji: '🩴', cat: 'calzado',     stock: 22 },
  { id: 'def-10', name: 'Mocasines',          price: 138000, emoji: '👞', cat: 'calzado',     stock: 14 },
  { id: 'def-11', name: 'Bolso Cuero',        price: 165000, emoji: '👜', cat: 'accesorios',  stock: 10 },
  { id: 'def-12', name: 'Cinturón',           price: 45000,  emoji: '🪢', cat: 'accesorios',  stock: 35 },
  { id: 'def-13', name: 'Reloj Elegante',     price: 320000, emoji: '⌚', cat: 'accesorios',  stock: 5  },
  { id: 'def-14', name: 'Gafas de Sol',       price: 85000,  emoji: '🕶️', cat: 'accesorios', stock: 17 },
  { id: 'def-15', name: 'Bufanda',            price: 42000,  emoji: '🧣', cat: 'accesorios',  stock: 28 },
  { id: 'def-16', name: 'Audífonos BT',       price: 89000,  emoji: '🎧', cat: 'electronica', stock: 9  },
  { id: 'def-17', name: 'Cable USB-C',        price: 22000,  emoji: '🔌', cat: 'electronica', stock: 60 },
  { id: 'def-18', name: 'Cargador Rápido',    price: 48000,  emoji: '⚡', cat: 'electronica', stock: 40 },
  { id: 'def-19', name: 'Funda Celular',      price: 28000,  emoji: '📱', cat: 'electronica', stock: 55 },
  { id: 'def-20', name: 'Power Bank 10K',     price: 78000,  emoji: '🔋', cat: 'electronica', stock: 11 },
  { id: 'def-21', name: 'Vela Aromática',     price: 28000,  emoji: '🕯️', cat: 'hogar',       stock: 32 },
  { id: 'def-22', name: 'Cojín Decorativo',   price: 62000,  emoji: '🛋️', cat: 'hogar',       stock: 16 },
  { id: 'def-23', name: 'Marco de Foto',      price: 35000,  emoji: '🖼️', cat: 'hogar',       stock: 24 },
  { id: 'def-24', name: 'Planta Interior',    price: 45000,  emoji: '🪴', cat: 'hogar',       stock: 13 },
  { id: 'def-25', name: 'Camiseta Promo',     price: 40000,  emoji: '🎽', cat: 'ofertas',     stock: 45, discount: 30 },
  { id: 'def-26', name: 'Pack Calcetines x5', price: 28000,  emoji: '🧦', cat: 'ofertas',     stock: 38, discount: 20 },
  { id: 'def-27', name: 'Tote Bag',           price: 38000,  emoji: '🛍️', cat: 'ofertas',     stock: 27, discount: 15 },
  { id: 'def-28', name: 'Gorra Promo',        price: 45000,  emoji: '🎩', cat: 'ofertas',     stock: 19, discount: 25 },
];

/* ═══ STORAGE ═══ */
const ls = localStorage;
const K  = 'fp_'; // key prefix

const DB = {
  getProducts: () => JSON.parse(ls.getItem(K+'products') || 'null') || JSON.parse(JSON.stringify(DEFAULT_PRODUCTS)),
  saveProducts: p => ls.setItem(K+'products', JSON.stringify(p)),
  getSales:    () => JSON.parse(ls.getItem(K+'sales')    || '[]'),
  saveSales:    s => ls.setItem(K+'sales',    JSON.stringify(s)),
  getCierres:  () => JSON.parse(ls.getItem(K+'cierres')  || '[]'),
  saveCierres:  c => ls.setItem(K+'cierres',  JSON.stringify(c)),
  getCats:     () => JSON.parse(ls.getItem(K+'cats')     || 'null') || JSON.parse(JSON.stringify(DEFAULT_CATS)),
  saveCats:     c => ls.setItem(K+'cats',     JSON.stringify(c)),
};

/* ═══ SUPABASE SYNC ═══ */
const SB = {
  async syncProduct(p) {
    if (!currentUser) return;
    const { error } = await _sb.from('productos').upsert({
      id: p.id, nombre: p.name, precio: p.price, costo: p.cost || 0, emoji: p.emoji,
      categoria: p.cat, stock: p.stock, descuento: p.discount || 0,
      user_id: currentUser.id
    });
    if (error) console.error('Error sincronizando producto:', error);
  },
  async deleteProduct(id) {
    if (!currentUser) return;
    await _sb.from('productos').delete().eq('id', id).eq('user_id', currentUser.id);
  },
  async syncCat(c) {
    if (!currentUser) return;
    await _sb.from('categorias').upsert({ id: c.id, nombre: c.label, icon: c.icon, user_id: currentUser.id });
  },
  async deleteCat(id) {
    if (!currentUser) return;
    await _sb.from('categorias').delete().eq('id', id).eq('user_id', currentUser.id);
  },
  async saveSale(sale) {
    if (!currentUser) return;
    const { error } = await _sb.from('ventas').insert({
      id: sale.id, orden: sale.order, items: sale.items,
      subtotal: sale.subtotal, iva: sale.iva, total: sale.total,
      metodo: sale.method, user_id: currentUser.id
    });
    if (error) console.error('Error guardando venta:', error);
  }
};

/* ═══ STATE ═══ */
const APP = {
  view: 'pos',
  mode: 'tienda',
  products: [],
  cart: [],
  cat: 'all',
  search: '',
  method: 'efectivo',
  order: genOrder(),
  invSearch: '',
  invCat: 'all',
  reportRange: 'today',
  confirmCallback: null,
  mesa: null,
};

/* ═══ HELPERS ═══ */
function fmt(n)   { return '$ ' + Math.round(n).toLocaleString('es-CO'); }
function fp(p)    { return p.discount ? p.price * (1 - p.discount / 100) : p.price; }
function genOrder(){ return String(Math.floor(Math.random() * 9000) + 1000); }
function todayStr(){ return new Date().toISOString().split('T')[0]; }

let IVA_RATE = parseFloat(ls.getItem(K+'iva') ?? 19);

function updateIva(val) {
  const n = parseFloat(val);
  if (isNaN(n) || n < 0 || n > 100) return;
  IVA_RATE = n;
  ls.setItem(K+'iva', n);
  toast(`✓ IVA actualizado a ${n}%`);
}

function totals() {
  const total = APP.cart.reduce((a, i) => a + fp(i) * i.qty, 0);
  const iva   = total * IVA_RATE / (100 + IVA_RATE);
  const sub   = total - iva;
  return { sub, iva, total };
}

/* ═══════════════════════════════════════════
   MESAS
═══════════════════════════════════════════ */
let MESAS = JSON.parse(ls.getItem(K + 'mesas') ?? '[]');
let MESA_ORDERS = JSON.parse(ls.getItem(K + 'mesa_orders') ?? '{}');

function saveMesas() { ls.setItem(K + 'mesas', JSON.stringify(MESAS)); }
function saveMesaOrders() { ls.setItem(K + 'mesa_orders', JSON.stringify(MESA_ORDERS)); }

function addMesa() {
  const nums = MESAS.map(m => m.numero);
  const next = nums.length ? Math.max(...nums) + 1 : 1;
  MESAS.push({ id: 'mesa_' + Date.now(), numero: next });
  saveMesas();
  renderMesas();
}

function deleteMesa(id) {
  if (APP.mesa === id) { APP.mesa = null; updateMesaBadge(); }
  MESAS = MESAS.filter(m => m.id !== id);
  delete MESA_ORDERS[id];
  saveMesas(); saveMesaOrders();
  renderMesas();
}

function openMesa(id) {
  if (APP.mesa && APP.mesa !== id) {
    MESA_ORDERS[APP.mesa] = { cart: [...APP.cart], order: APP.order };
    saveMesaOrders();
  }
  APP.mesa = id;
  const saved = MESA_ORDERS[id];
  APP.cart = saved ? [...(saved.cart || [])] : [];
  APP.order = saved?.order || genOrder();
  updateMesaBadge();
  goTo('pos');
}

function updateMesaBadge() {
  const badge = document.getElementById('mesaBadge');
  if (!badge) return;
  if (APP.mesa) {
    const m = MESAS.find(x => x.id === APP.mesa);
    if (m) { badge.textContent = '🪑 Mesa ' + m.numero; badge.style.display = 'flex'; return; }
  }
  badge.style.display = 'none';
}

function renderMesas() {
  const grid = document.getElementById('mesasGrid');
  if (!grid) return;
  if (!MESAS.length) {
    grid.innerHTML = `<div style="grid-column:1/-1" class="empty-state"><div class="ei">🪑</div><p>No hay mesas creadas</p><p style="font-size:13px;color:var(--muted);margin-top:6px">Haz clic en "Nueva Mesa" para agregar</p></div>`;
    return;
  }
  grid.innerHTML = MESAS.map(m => {
    const saved = MESA_ORDERS[m.id];
    const cart = saved?.cart || [];
    const ocupada = cart.length > 0;
    const total = ocupada ? cart.reduce((a, i) => a + fp(i) * i.qty, 0) : 0;
    const isActive = APP.mesa === m.id;
    return `
      <div class="mesa-card ${ocupada ? 'ocupada' : 'libre'}${isActive ? ' active-mesa' : ''}" onclick="openMesa('${m.id}')">
        <img class="mesa-img" src="images/mesa.png" alt="Mesa ${m.numero}">
        <div class="mesa-num">Mesa ${m.numero}</div>
        <div class="mesa-status ${ocupada ? 'ocupada' : 'libre'}">${ocupada ? '🔴 Ocupada' : '🟢 Libre'}</div>
        ${ocupada ? `<div class="mesa-total">${fmt(total)}</div>` : ''}
        <button class="mesa-delete" onclick="event.stopPropagation(); deleteMesa('${m.id}')" title="Eliminar mesa">✕</button>
      </div>`;
  }).join('');
}

/* ═══════════════════════════════════════════
   RESTAURANTE — MODO, MESAS Y COMANDAS
═══════════════════════════════════════════ */
let REST_MESAS     = JSON.parse(ls.getItem(K + 'rest_mesas')      ?? '[]');
let REST_COMANDAS  = JSON.parse(ls.getItem(K + 'rest_comandas')   ?? '{}');
let REST_ELEMENTOS = JSON.parse(ls.getItem(K + 'rest_elementos')  ?? '[]');
let ACTIVE_COMANDA  = null;
let _drag = null;
let _rb   = null;
let _selectedMesas    = new Set();
let _salonDesignMode  = false;
let _salonTool        = 'pared';   // 'pared' | 'entrada' | 'borrar'
let _drawState        = null;      // { x1, y1 } during wall draw
let _dragElemActive   = false;     // true while dragging a floor element

function saveRestMesas()      { ls.setItem(K + 'rest_mesas',      JSON.stringify(REST_MESAS)); }
function saveRestComandas()   { ls.setItem(K + 'rest_comandas',   JSON.stringify(REST_COMANDAS)); }
function saveRestElementos()  { ls.setItem(K + 'rest_elementos',  JSON.stringify(REST_ELEMENTOS)); }

/* ── MODE SELECTION ── */
function showModeOverlay() {
  document.getElementById('modeOverlay').style.display = 'flex';
}

function selectMode(mode) {
  APP.mode = mode;
  ls.setItem(K + 'mode', mode);
  document.getElementById('modeOverlay').style.display = 'none';
  applyMode(mode);
  showRoleOverlay();
}

function applyMode(mode) {
  document.querySelectorAll('[data-mode-tienda]').forEach(el => {
    el.style.display = mode === 'tienda' ? '' : 'none';
  });
  document.querySelectorAll('[data-mode-rest]').forEach(el => {
    el.style.display = mode === 'restaurante' ? '' : 'none';
  });
}

/* ── FLOOR PLAN EDITOR ── */
function toggleDesignMode() {
  _salonDesignMode = !_salonDesignMode;
  _salonTool = 'pared';
  _drawState = null;
  const wrap = document.querySelector('.salon-wrap');
  if (wrap) {
    wrap.classList.toggle('salon-design', _salonDesignMode);
    wrap.classList.remove('tool-pared', 'tool-entrada', 'tool-borrar');
    if (_salonDesignMode) wrap.classList.add('tool-pared');
  }
  renderElements();
  renderSalon();
}

function setSalonTool(tool) {
  _salonTool = tool;
  _drawState = null;
  const wrap = document.querySelector('.salon-wrap');
  if (wrap) {
    wrap.classList.remove('tool-pared', 'tool-entrada', 'tool-borrar');
    wrap.classList.add('tool-' + tool);
  }
  renderElements();
  renderSalon();
}

function renderElements() {
  const svg = document.getElementById('salonSvg');
  if (!svg) return;
  svg.querySelectorAll('.floor-el').forEach(el => el.remove());
  const NS = 'http://www.w3.org/2000/svg';
  const canEdit = _salonDesignMode;
  const EW = 100, EH = 52;

  REST_ELEMENTOS.forEach(el => {
    if (el.type === 'pared') {
      /* ── wall: <g translate> wrapping a <rect> ── */
      const g = document.createElementNS(NS, 'g');
      g.setAttribute('class', 'floor-el floor-pared');
      g.setAttribute('data-elid', el.id);
      g.setAttribute('transform', `translate(${el.x},${el.y})`);
      const rect = document.createElementNS(NS, 'rect');
      rect.setAttribute('x', '0'); rect.setAttribute('y', '0');
      rect.setAttribute('width', el.w); rect.setAttribute('height', el.h);
      rect.setAttribute('fill', '#5c6070');
      rect.setAttribute('stroke', '#3a3d50');
      rect.setAttribute('stroke-width', '1');
      rect.setAttribute('rx', '3');
      g.appendChild(rect);
      if (canEdit) {
        g.setAttribute('pointer-events', 'all');
        if (_salonTool === 'borrar') {
          g.style.cursor = 'pointer';
          g.addEventListener('click', ev => { ev.stopPropagation(); deleteElem(el.id); });
        } else {
          g.style.cursor = 'grab';
          g.addEventListener('mousedown', ev => startElemDrag(ev, el.id));
        }
      }
      svg.appendChild(g);

    } else if (el.type === 'entrada') {
      /* ── entrance: all coords local (0,0), translate+rotate the group ── */
      const g = document.createElementNS(NS, 'g');
      g.setAttribute('class', 'floor-el floor-entrada');
      g.setAttribute('data-elid', el.id);
      g.setAttribute('transform', `translate(${el.x},${el.y}) rotate(${el.angle||0},${EW/2},${EH/2})`);

      const arrows = document.createElementNS(NS, 'text');
      arrows.setAttribute('x', EW / 2); arrows.setAttribute('y', '16');
      arrows.setAttribute('text-anchor', 'middle'); arrows.setAttribute('font-size', '14');
      arrows.setAttribute('fill', '#e06010'); arrows.setAttribute('font-family', 'sans-serif');
      arrows.setAttribute('pointer-events', 'none');
      arrows.textContent = '▼  ▼  ▼';

      const box = document.createElementNS(NS, 'rect');
      box.setAttribute('x', '0'); box.setAttribute('y', '20');
      box.setAttribute('width', EW); box.setAttribute('height', '28');
      box.setAttribute('fill', 'rgba(255,200,120,0.18)');
      box.setAttribute('stroke', '#e06010'); box.setAttribute('stroke-width', '2'); box.setAttribute('rx', '7');

      const label = document.createElementNS(NS, 'text');
      label.setAttribute('x', EW / 2); label.setAttribute('y', '39');
      label.setAttribute('text-anchor', 'middle'); label.setAttribute('font-size', '11');
      label.setAttribute('font-weight', '700'); label.setAttribute('fill', '#e06010');
      label.setAttribute('font-family', 'Lato,sans-serif'); label.setAttribute('letter-spacing', '1.5');
      label.setAttribute('pointer-events', 'none');
      label.textContent = 'ENTRADA';

      const hit = document.createElementNS(NS, 'rect');
      hit.setAttribute('x', '0'); hit.setAttribute('y', '0');
      hit.setAttribute('width', EW); hit.setAttribute('height', EH);
      hit.setAttribute('fill', 'rgba(0,0,0,0)'); hit.setAttribute('pointer-events', 'all');

      g.appendChild(arrows); g.appendChild(box); g.appendChild(label); g.appendChild(hit);
      if (canEdit) {
        g.setAttribute('pointer-events', 'all');
        if (_salonTool === 'borrar') {
          g.style.cursor = 'pointer';
          hit.addEventListener('click', ev => { ev.stopPropagation(); deleteElem(el.id); });
        } else {
          g.style.cursor = 'grab';
          g.addEventListener('mousedown', ev => startElemDrag(ev, el.id));
        }
      }
      svg.appendChild(g);
    }
  });
  svg.style.pointerEvents = _salonDesignMode ? 'all' : 'none';
}

function deleteElem(id) {
  REST_ELEMENTOS = REST_ELEMENTOS.filter(x => x.id !== id);
  saveRestElementos(); renderElements();
}

/* ── FLOOR ELEMENT DRAG ── */
let _dragElem = null;

function startElemDrag(e, elId) {
  if (!_salonDesignMode || _salonTool === 'borrar') return;
  e.preventDefault(); e.stopPropagation();
  const elem = REST_ELEMENTOS.find(x => x.id === elId);
  if (!elem) return;
  const svgEl = document.querySelector(`[data-elid="${elId}"]`);
  _dragElem = { id: elId, svgEl, startX: e.clientX, startY: e.clientY, origX: elem.x, origY: elem.y, moved: false };
  if (svgEl) svgEl.style.cursor = 'grabbing';
  document.addEventListener('mousemove', onElemDragMove);
  document.addEventListener('mouseup',   onElemDragEnd);
}

function onElemDragMove(e) {
  if (!_dragElem) return;
  const dx = e.clientX - _dragElem.startX;
  const dy = e.clientY - _dragElem.startY;
  if (Math.abs(dx) > 4 || Math.abs(dy) > 4) _dragElem.moved = true;
  if (!_dragElem.moved) return;
  const elem = REST_ELEMENTOS.find(x => x.id === _dragElem.id);
  if (!elem || !_dragElem.svgEl) return;
  const EW = 100;
  elem.x = Math.max(0, snap(_dragElem.origX + dx));
  elem.y = Math.max(0, snap(_dragElem.origY + dy));
  if (elem.type === 'pared') {
    _dragElem.svgEl.setAttribute('transform', `translate(${elem.x},${elem.y})`);
  } else if (elem.type === 'entrada') {
    _dragElem.svgEl.setAttribute('transform', `translate(${elem.x},${elem.y}) rotate(${elem.angle||0},${EW/2},${EW/2})`);
  }
}

function onElemDragEnd(e) {
  document.removeEventListener('mousemove', onElemDragMove);
  document.removeEventListener('mouseup',   onElemDragEnd);
  if (!_dragElem) return;
  const elem = REST_ELEMENTOS.find(x => x.id === _dragElem.id);
  if (_dragElem.moved) {
    saveRestElementos();
    if (_dragElem.svgEl) _dragElem.svgEl.style.cursor = 'grab';
  } else if (elem && elem.type === 'entrada') {
    // click without move → rotate 90°
    elem.angle = ((elem.angle || 0) + 90) % 360;
    saveRestElementos(); renderElements();
  }
  _dragElem = null;
}

/* wall drawing */
function startDrawPared(e) {
  const canvas = document.getElementById('salonCanvas');
  const rect   = canvas.getBoundingClientRect();
  const x = snap(e.clientX - rect.left);
  const y = snap(e.clientY - rect.top);
  _drawState = { x1: x, y1: y };
  const NS  = 'http://www.w3.org/2000/svg';
  const svg = document.getElementById('salonSvg');
  let preview = svg.querySelector('#floorPreview');
  if (!preview) {
    preview = document.createElementNS(NS, 'rect');
    preview.id = 'floorPreview';
    preview.setAttribute('fill', '#5c6070');
    preview.setAttribute('stroke', '#3a3d50');
    preview.setAttribute('stroke-width', '1');
    preview.setAttribute('rx', '3');
    preview.setAttribute('opacity', '0.6');
    preview.style.pointerEvents = 'none';
    svg.appendChild(preview);
  }
  preview.setAttribute('x', x); preview.setAttribute('y', y);
  preview.setAttribute('width', '0'); preview.setAttribute('height', '0');
  document.addEventListener('mousemove', onDrawMove);
  document.addEventListener('mouseup',   onDrawEnd);
}

function snap(v) { return Math.round(v / 14) * 14; }

function onDrawMove(e) {
  if (!_drawState) return;
  const canvas = document.getElementById('salonCanvas');
  const rect   = canvas.getBoundingClientRect();
  const x2 = snap(e.clientX - rect.left);
  const y2 = snap(e.clientY - rect.top);
  const preview = document.getElementById('floorPreview');
  if (!preview) return;
  preview.setAttribute('x', Math.min(_drawState.x1, x2));
  preview.setAttribute('y', Math.min(_drawState.y1, y2));
  preview.setAttribute('width',  Math.abs(x2 - _drawState.x1));
  preview.setAttribute('height', Math.abs(y2 - _drawState.y1));
}

function onDrawEnd(e) {
  document.removeEventListener('mousemove', onDrawMove);
  document.removeEventListener('mouseup',   onDrawEnd);
  const preview = document.getElementById('floorPreview');
  if (preview) { preview.setAttribute('width', '0'); preview.setAttribute('height', '0'); }
  if (!_drawState) return;
  const canvas = document.getElementById('salonCanvas');
  const rect   = canvas.getBoundingClientRect();
  const x2 = snap(e.clientX - rect.left);
  const y2 = snap(e.clientY - rect.top);
  const x = Math.min(_drawState.x1, x2);
  const y = Math.min(_drawState.y1, y2);
  const w = Math.abs(x2 - _drawState.x1);
  const h = Math.abs(y2 - _drawState.y1);
  _drawState = null;
  if (w < 14 && h < 14) return; // too small, ignore
  REST_ELEMENTOS.push({
    id:   Date.now().toString(36) + Math.random().toString(36).slice(2, 6),
    type: 'pared',
    x, y,
    w: Math.max(w, 14),
    h: Math.max(h, 10)
  });
  saveRestElementos();
  renderElements();
}

/* entrance/door placement */
function placeEntrada(e) {
  const canvas = document.getElementById('salonCanvas');
  const rect   = canvas.getBoundingClientRect();
  const x = snap(e.clientX - rect.left) - 50;  // center 100px wide
  const y = snap(e.clientY - rect.top)  - 26;  // center 52px tall
  REST_ELEMENTOS.push({
    id:    Date.now().toString(36) + Math.random().toString(36).slice(2, 6),
    type:  'entrada',
    x:     Math.round(x),
    y:     Math.round(y),
    w:     100,
    angle: 0
  });
  saveRestElementos();
  renderElements();
}

/* ── ONBOARDING (nuevo usuario) ── */
let _onboardingMode = null;

function showOnboarding() {
  _onboardingMode = null;
  document.getElementById('onboardingBizName').value = '';
  document.getElementById('onboardingBtnTienda').classList.remove('selected');
  document.getElementById('onboardingBtnRestaurante').classList.remove('selected');
  document.getElementById('onboardingOverlay').style.display = 'flex';
  setTimeout(() => document.getElementById('onboardingBizName').focus(), 150);
}

function selectOnboardingMode(mode) {
  _onboardingMode = mode;
  document.getElementById('onboardingBtnTienda').classList.toggle('selected', mode === 'tienda');
  document.getElementById('onboardingBtnRestaurante').classList.toggle('selected', mode === 'restaurante');
}

function confirmOnboarding() {
  const name = document.getElementById('onboardingBizName').value.trim();
  if (!name) { document.getElementById('onboardingBizName').focus(); document.getElementById('onboardingBizName').style.borderColor = '#ef4444'; return; }
  if (!_onboardingMode) {
    document.getElementById('onboardingBtnTienda').style.animation = 'none';
    document.getElementById('onboardingBtnRestaurante').style.borderColor = '#ef4444';
    document.getElementById('onboardingBtnTienda').style.borderColor = '#ef4444';
    setTimeout(() => {
      document.getElementById('onboardingBtnTienda').style.borderColor = '';
      document.getElementById('onboardingBtnRestaurante').style.borderColor = '';
    }, 1200);
    return;
  }
  document.getElementById('onboardingBizName').style.borderColor = '';
  ls.setItem(K + 'bizname', name);
  ls.setItem(K + 'mode', _onboardingMode);
  APP.mode = _onboardingMode;
  document.getElementById('onboardingOverlay').style.display = 'none';
  applyBizName();
  applyMode(_onboardingMode);
  showRoleOverlay();
}

function applyBizName() {
  const biz = ls.getItem(K + 'bizname');
  if (!biz) return;
  const logo = document.getElementById('logoName');
  if (logo) logo.textContent = biz;
  const rb = document.getElementById('receiptBrand');
  if (rb) rb.textContent = biz;
}

/* ── SALON MESAS ── */
function addRestMesa() {
  const nums = REST_MESAS.map(m => m.numero);
  const next = nums.length ? Math.max(...nums) + 1 : 1;
  const col = (next - 1) % 4;
  const row = Math.floor((next - 1) / 4);
  REST_MESAS.push({ id: 'rm_' + Date.now(), numero: next, x: 60 + col * 170, y: 60 + row * 200 });
  saveRestMesas();
  renderSalon();
}

function deleteRestMesa(id) {
  REST_MESAS = REST_MESAS.filter(m => m.id !== id);
  delete REST_COMANDAS[id];
  saveRestMesas(); saveRestComandas();
  if (ACTIVE_COMANDA === id) closeComanda();
  else renderSalon();
}

function getRestMesaEstado(id) {
  const c = REST_COMANDAS[id];
  if (!c || !c.items || !c.items.length) return 'libre';
  return c.estado || 'en_curso';
}

function getRestMesaTotal(id) {
  const c = REST_COMANDAS[id];
  if (!c || !c.items) return 0;
  return c.items.reduce((s, i) => s + i.unitPrice * i.qty, 0);
}

function renderSalon() {
  const canvas  = document.getElementById('salonCanvas');
  const toolbar = document.getElementById('salonToolbar');
  if (!canvas) return;

  /* ── toolbar ── */
  if (toolbar) {
    const n = _selectedMesas.size;
    if (_salonDesignMode) {
      toolbar.innerHTML = `
        <span style="font-size:11px;color:var(--muted);font-weight:700;letter-spacing:0.4px;text-transform:uppercase">Diseñar espacio</span>
        <div class="tool-sep"></div>
        <button class="btn-tool ${_salonTool==='pared'   ? 'active' : ''}" onclick="setSalonTool('pared')">🧱 Pared</button>
        <button class="btn-tool ${_salonTool==='entrada' ? 'active' : ''}" onclick="setSalonTool('entrada')">🚪 Entrada</button>
        <div class="tool-sep"></div>
        <button class="btn-tool ${_salonTool==='borrar'  ? 'active' : ''}" onclick="setSalonTool('borrar')" style="${_salonTool==='borrar'?'background:#EF4444;border-color:#EF4444;':''}">🗑️ Borrar</button>
        <button class="btn-tool-done" onclick="toggleDesignMode()">✓ Listo</button>`;
    } else if (n > 0) {
      toolbar.innerHTML = `
        <span class="sel-count-label">${n} mesa${n !== 1 ? 's' : ''} seleccionada${n !== 1 ? 's' : ''}</span>
        <button class="btn-del-sel" onclick="deleteSelectedMesas()">🗑️ Eliminar</button>
        <button class="btn-cancel-sel" onclick="clearSelection()">✕</button>`;
    } else {
      toolbar.innerHTML = `
        <button class="btn-primary" onclick="addRestMesa()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          Nueva Mesa
        </button>
        <button class="btn-design" onclick="toggleDesignMode()">✏️ Diseñar espacio</button>`;
    }
  }

  /* ── mesas ── */
  canvas.querySelectorAll('.mesa-float').forEach(el => el.remove());
  REST_MESAS.forEach(m => {
    const estado = getRestMesaEstado(m.id);
    const total  = getRestMesaTotal(m.id);
    const isOpen = ACTIVE_COMANDA === m.id;
    const isSel  = _selectedMesas.has(m.id);
    const el = document.createElement('div');
    el.className = ['mesa-float', isOpen ? 'mesa-float-open' : '', isSel ? 'selected' : ''].filter(Boolean).join(' ');
    el.dataset.mesaId = m.id;
    el.style.left = m.x + 'px';
    el.style.top  = m.y + 'px';
    const c = REST_COMANDAS[m.id];
    const items = c?.items || [];
    const tooltipItems = items.length
      ? items.map(it => `<div class="mesa-tooltip-row"><span class="mesa-tooltip-qty">${it.qty}×</span><span class="mesa-tooltip-name">${it.emoji} ${it.name}</span><span class="mesa-tooltip-sub">${fmt(it.unitPrice * it.qty)}</span></div>`).join('')
      : `<div class="mesa-tooltip-empty">Mesa libre</div>`;
    const tooltipTotal = items.length ? `<div class="mesa-tooltip-total"><span>Total</span><span>${fmt(total)}</span></div>` : '';
    const estadoEmoji = { libre:'🟢', en_curso:'🟡', en_cocina:'🍳', cuenta_pedida:'🧾' }[estado] || '🟢';
    el.innerHTML = `
      <div class="mesa-tooltip">
        <div class="mesa-tooltip-head"><span>Mesa ${m.numero}</span><span>${estadoEmoji}</span></div>
        ${tooltipItems}${tooltipTotal}
      </div>
      <div class="mesa-sel-check">✓</div>
      <img class="mesa-float-img" src="images/mesa.png" alt="Mesa ${m.numero}">
      <div class="mesa-float-label ${estado}">${estado !== 'libre' ? '🔴 ' : ''}Mesa ${m.numero}</div>
      ${total ? `<div class="mesa-float-total">${fmt(total)}</div>` : ''}
      <button class="mesa-float-del" onclick="event.stopPropagation(); deleteRestMesa('${m.id}')" title="Eliminar">✕</button>`;
    el.addEventListener('mousedown', (e) => startDrag(e, m.id));
    el.addEventListener('touchstart', (e) => startDragTouch(e, m.id), { passive: false });
    canvas.appendChild(el);
  });
  setupSalonCanvas();
  renderElements();
}

/* ── RUBBER BAND SELECTION ── */
function setupSalonCanvas() {
  const canvas = document.getElementById('salonCanvas');
  if (!canvas || canvas._rbSetup) return;
  canvas._rbSetup = true;
  const wrap = canvas.closest('.salon-wrap');
  if (!wrap) return;
  wrap.addEventListener('mousedown', (e) => {
    if (e.button !== 0) return;
    if (e.target.closest('.salon-toolbar, button')) return;
    if (_salonDesignMode) {
      if (e.target.closest('.mesa-float')) return; // mesas still draggable
      if (e.target.closest('.floor-el')) return;   // SVG element clicks handled by renderElements
      if (_salonTool === 'pared')   startDrawPared(e);
      else if (_salonTool === 'entrada') placeEntrada(e);
    } else {
      if (e.target.closest('.mesa-float')) return;
      startRubberBand(e);
    }
  });
}

function startRubberBand(e) {
  const canvas = document.getElementById('salonCanvas');
  const rect   = canvas.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;
  _rb = { x1: x, y1: y, x2: x, y2: y };
  let rb = document.getElementById('rubberBandEl');
  if (!rb) {
    rb = document.createElement('div');
    rb.id = 'rubberBandEl';
    rb.className = 'rubber-band';
    canvas.appendChild(rb);
  }
  rb.style.cssText = 'display:block;left:' + x + 'px;top:' + y + 'px;width:0;height:0';
  document.addEventListener('mousemove', onRbMove);
  document.addEventListener('mouseup',   onRbEnd);
}

function onRbMove(e) {
  if (!_rb) return;
  const canvas = document.getElementById('salonCanvas');
  const rect   = canvas.getBoundingClientRect();
  _rb.x2 = e.clientX - rect.left;
  _rb.y2 = e.clientY - rect.top;
  const rb = document.getElementById('rubberBandEl');
  if (!rb) return;
  const x1 = Math.min(_rb.x1, _rb.x2), y1 = Math.min(_rb.y1, _rb.y2);
  const x2 = Math.max(_rb.x1, _rb.x2), y2 = Math.max(_rb.y1, _rb.y2);
  rb.style.left = x1 + 'px'; rb.style.top = y1 + 'px';
  rb.style.width = (x2 - x1) + 'px'; rb.style.height = (y2 - y1) + 'px';
}

function onRbEnd() {
  document.removeEventListener('mousemove', onRbMove);
  document.removeEventListener('mouseup',   onRbEnd);
  const rb = document.getElementById('rubberBandEl');
  if (rb) rb.style.display = 'none';
  if (!_rb) return;
  const x1 = Math.min(_rb.x1, _rb.x2), y1 = Math.min(_rb.y1, _rb.y2);
  const x2 = Math.max(_rb.x1, _rb.x2), y2 = Math.max(_rb.y1, _rb.y2);
  _rb = null;
  if (x2 - x1 < 8 && y2 - y1 < 8) return;
  _selectedMesas.clear();
  REST_MESAS.forEach(m => {
    const cx = m.x + 55, cy = m.y + 55;
    if (cx >= x1 && cx <= x2 && cy >= y1 && cy <= y2) _selectedMesas.add(m.id);
  });
  renderSalon();
}

function clearSelection() {
  _selectedMesas.clear();
  renderSalon();
}

function deleteSelectedMesas() {
  if (!_selectedMesas.size) return;
  const n = _selectedMesas.size;
  REST_MESAS = REST_MESAS.filter(m => !_selectedMesas.has(m.id));
  _selectedMesas.forEach(id => { delete REST_COMANDAS[id]; if (ACTIVE_COMANDA === id) ACTIVE_COMANDA = null; });
  saveRestMesas(); saveRestComandas();
  clearSelection();
  toast(`🗑️ ${n} mesa${n !== 1 ? 's' : ''} eliminada${n !== 1 ? 's' : ''}`);
}

/* ── DRAG & DROP ── */
function startDrag(e, mesaId) {
  if (e.target.classList.contains('mesa-float-del')) return;
  e.preventDefault();
  const el = e.currentTarget;
  const m = REST_MESAS.find(x => x.id === mesaId);
  _drag = { mesaId, startX: e.clientX, startY: e.clientY, origX: m.x, origY: m.y, moved: false, el };
  document.addEventListener('mousemove', onDrag);
  document.addEventListener('mouseup', endDrag);
}

function startDragTouch(e, mesaId) {
  const t = e.touches[0];
  const m = REST_MESAS.find(x => x.id === mesaId);
  _drag = { mesaId, startX: t.clientX, startY: t.clientY, origX: m.x, origY: m.y, moved: false, el: e.currentTarget };
  document.addEventListener('touchmove', onDragTouch, { passive: false });
  document.addEventListener('touchend', endDragTouch);
}

function onDrag(e) {
  if (!_drag) return;
  const dx = e.clientX - _drag.startX;
  const dy = e.clientY - _drag.startY;
  if (Math.abs(dx) > 4 || Math.abs(dy) > 4) _drag.moved = true;
  if (_drag.moved) {
    _drag.el.style.left = Math.max(0, _drag.origX + dx) + 'px';
    _drag.el.style.top  = Math.max(0, _drag.origY + dy) + 'px';
    _drag.el.style.cursor = 'grabbing';
  }
}

function onDragTouch(e) {
  if (!_drag) return;
  e.preventDefault();
  const t = e.touches[0];
  const dx = t.clientX - _drag.startX;
  const dy = t.clientY - _drag.startY;
  if (Math.abs(dx) > 4 || Math.abs(dy) > 4) _drag.moved = true;
  if (_drag.moved) {
    _drag.el.style.left = Math.max(0, _drag.origX + dx) + 'px';
    _drag.el.style.top  = Math.max(0, _drag.origY + dy) + 'px';
  }
}

function endDrag(e) {
  document.removeEventListener('mousemove', onDrag);
  document.removeEventListener('mouseup', endDrag);
  if (!_drag) return;
  if (_drag.moved) {
    const m = REST_MESAS.find(x => x.id === _drag.mesaId);
    if (m) {
      m.x = Math.max(0, _drag.origX + (e.clientX - _drag.startX));
      m.y = Math.max(0, _drag.origY + (e.clientY - _drag.startY));
      saveRestMesas();
    }
  } else {
    if (!_salonDesignMode) openComanda(_drag.mesaId);
  }
  _drag.el.style.cursor = '';
  _drag = null;
}

function endDragTouch(e) {
  document.removeEventListener('touchmove', onDragTouch);
  document.removeEventListener('touchend', endDragTouch);
  if (!_drag) return;
  if (_drag.moved) {
    const t = e.changedTouches[0];
    const m = REST_MESAS.find(x => x.id === _drag.mesaId);
    if (m) {
      m.x = Math.max(0, _drag.origX + (t.clientX - _drag.startX));
      m.y = Math.max(0, _drag.origY + (t.clientY - _drag.startY));
      saveRestMesas();
    }
  } else {
    openComanda(_drag.mesaId);
  }
  _drag = null;
}

/* ── COMANDA ── */
function openComanda(mesaId) {
  ACTIVE_COMANDA = mesaId;
  const m = REST_MESAS.find(x => x.id === mesaId);
  document.getElementById('comandaMesaName').textContent = 'Mesa ' + (m ? m.numero : '');
  renderComandaItems(mesaId);
  document.getElementById('comandaBg').classList.add('open');
  document.getElementById('comandaPanel').classList.add('open');
  renderSalon();
}

function closeComanda() {
  ACTIVE_COMANDA = null;
  document.getElementById('comandaBg').classList.remove('open');
  document.getElementById('comandaPanel').classList.remove('open');
  closePickerFloat();
  renderSalon();
}

function renderComandaItems(mesaId) {
  const c = REST_COMANDAS[mesaId] || { items: [], estado: 'libre' };
  const itemsEl = document.getElementById('comandaItems');
  const badgeEl = document.getElementById('comandaStatusBadge');
  const totalEl = document.getElementById('comandaTotalBox');
  const labels  = { libre:'🟢 Libre', en_curso:'🟡 En curso', en_cocina:'🍳 En cocina', cuenta_pedida:'🧾 Cuenta pedida' };
  badgeEl.textContent = labels[c.estado] || '🟢 Libre';
  badgeEl.className   = 'comanda-status-badge status-' + (c.estado || 'libre');
  if (!c.items || !c.items.length) {
    itemsEl.innerHTML = `<div class="comanda-empty"><div style="font-size:32px">🍽️</div><p>Sin productos</p><p style="font-size:12px;color:var(--muted)">Toca "＋ Agregar" para añadir</p></div>`;
    totalEl.innerHTML = '';
    return;
  }
  itemsEl.innerHTML = c.items.map(it => `
    <div class="comanda-item">
      <div class="comanda-item-top">
        <span class="comanda-item-emoji">${it.emoji}</span>
        <div class="comanda-item-info">
          <div class="comanda-item-name">${it.name}</div>
          <div class="comanda-item-price">${fmt(it.unitPrice)} c/u</div>
        </div>
        <div class="comanda-item-controls">
          <button class="ci-btn2" onclick="changeComandaQty('${mesaId}','${it.id}',-1)">−</button>
          <span class="ci-qty2">${it.qty}</span>
          <button class="ci-btn2" onclick="changeComandaQty('${mesaId}','${it.id}',1)">+</button>
        </div>
        <span style="font-size:13px;font-weight:700;color:var(--dark);min-width:62px;text-align:right;margin-left:4px">${fmt(it.unitPrice * it.qty)}</span>
      </div>
      <textarea class="comanda-note" rows="1" placeholder="Nota… (sin azúcar, bien cocido…)"
        onchange="updateComandaNota('${mesaId}','${it.id}',this.value)">${it.nota || ''}</textarea>
    </div>`).join('');
  const total = c.items.reduce((s, i) => s + i.unitPrice * i.qty, 0);
  totalEl.innerHTML = `<div class="comanda-total-row main"><span>Total mesa</span><strong>${fmt(total)}</strong></div>`;
}

function changeComandaQty(mesaId, prodId, delta) {
  if (!REST_COMANDAS[mesaId]) return;
  const c  = REST_COMANDAS[mesaId];
  const it = c.items.find(i => i.id === prodId);
  if (!it) return;
  it.qty = Math.max(0, it.qty + delta);
  if (it.qty === 0) c.items = c.items.filter(i => i.id !== prodId);
  saveRestComandas();
  renderComandaItems(mesaId);
  renderSalon();
}

function updateComandaNota(mesaId, prodId, nota) {
  if (!REST_COMANDAS[mesaId]) return;
  const it = REST_COMANDAS[mesaId].items.find(i => i.id === prodId);
  if (it) { it.nota = nota; saveRestComandas(); }
}

function sendToKitchen() {
  if (!ACTIVE_COMANDA) return;
  const c = REST_COMANDAS[ACTIVE_COMANDA];
  if (!c || !c.items || !c.items.length) { toast('⚠️ Sin productos en la comanda'); return; }
  c.estado = 'en_cocina';
  saveRestComandas();
  renderComandaItems(ACTIVE_COMANDA);
  renderSalon();
  toast('🍳 Pedido enviado a cocina');
}

function requestBill() {
  if (!ACTIVE_COMANDA) return;
  const c = REST_COMANDAS[ACTIVE_COMANDA];
  if (!c || !c.items || !c.items.length) { toast('⚠️ Sin productos en la comanda'); return; }
  c.estado = 'cuenta_pedida';
  saveRestComandas();
  renderComandaItems(ACTIVE_COMANDA);
  renderSalon();
  toast('🧾 Cuenta solicitada');
}

function payMesa() {
  if (!ACTIVE_COMANDA) return;
  const c = REST_COMANDAS[ACTIVE_COMANDA];
  if (!c || !c.items || !c.items.length) { toast('⚠️ Sin productos para cobrar'); return; }
  const mesaId = ACTIVE_COMANDA;
  APP.cart = c.items.map(it => ({
    id: it.id, name: it.name, emoji: it.emoji, qty: it.qty,
    price: it.unitPrice, cost: it.cost || 0, discount: 0, stock: 9999,
  }));
  APP.mesa  = mesaId;
  APP.order = genOrder();
  closeComanda();
  goTo('pos');
  openPayment();
}

/* ── PRODUCT PICKER FLOAT ── */
function openPickerFloat() {
  if (!ACTIVE_COMANDA) return;
  const m = REST_MESAS.find(x => x.id === ACTIVE_COMANDA);
  document.getElementById('pfbarTitle').textContent = 'Mesa ' + (m ? m.numero : '');
  renderPickerRows();
  const f = document.getElementById('pickerFloat');
  f.classList.add('open', 'pinned');
}

function closePickerFloat() {
  document.getElementById('pickerFloat').classList.remove('open', 'pinned');
}

function renderPickerRows() {
  if (!ACTIVE_COMANDA) return;
  const c      = REST_COMANDAS[ACTIVE_COMANDA] || { items: [] };
  const m      = REST_MESAS.find(x => x.id === ACTIVE_COMANDA);
  const totalQty = (c.items || []).reduce((s, i) => s + i.qty, 0);
  const totalAmt = (c.items || []).reduce((s, i) => s + i.qty * (i.unitPrice || 0), 0);
  const badge = document.getElementById('pfBadge');
  const mesa  = document.getElementById('pfMesa');
  const total = document.getElementById('pfTotal');
  if (badge) badge.textContent = totalQty || '0';
  if (mesa)  mesa.textContent  = m ? `Mesa ${m.numero}` : 'Mesa';
  if (total) total.textContent = fmt(totalAmt);
  const rows = document.getElementById('pickerRows');
  if (!APP.products.length) {
    rows.innerHTML = '<div style="padding:20px;text-align:center;color:var(--muted);font-size:13px">No hay productos registrados</div>';
    return;
  }
  rows.innerHTML = APP.products.map(p => {
    const existing = (c.items || []).find(i => i.id === p.id);
    const qty = existing ? existing.qty : 0;
    return `<div class="picker-row">
      <span class="pr-emoji">${p.emoji}</span>
      <div class="pr-info">
        <div class="pr-name">${p.name}</div>
        <div class="pr-price">${fmt(fp(p))}</div>
      </div>
      <div class="pr-ctrl">
        ${qty > 0 ? `<button class="pr-btn minus" onclick="pickerQty('${p.id}',-1)">−</button><span class="pr-qty">${qty}</span>` : ''}
        <button class="pr-btn" onclick="pickerQty('${p.id}',1)">+</button>
      </div>
    </div>`;
  }).join('');
}

function pickerQty(prodId, delta) {
  if (!ACTIVE_COMANDA) return;
  const p = APP.products.find(x => x.id === prodId);
  if (!p) return;
  if (!REST_COMANDAS[ACTIVE_COMANDA]) {
    REST_COMANDAS[ACTIVE_COMANDA] = { items: [], estado: 'en_curso', timestamp: Date.now() };
  }
  const c        = REST_COMANDAS[ACTIVE_COMANDA];
  const existing = c.items.find(i => i.id === prodId);
  if (delta > 0) {
    if (existing) existing.qty++;
    else c.items.push({ id: p.id, name: p.name, emoji: p.emoji, qty: 1, unitPrice: fp(p), cost: p.cost || 0, nota: '' });
    if (c.estado === 'libre') c.estado = 'en_curso';
  } else if (existing) {
    existing.qty = Math.max(0, existing.qty - 1);
    if (existing.qty === 0) c.items = c.items.filter(i => i.id !== prodId);
  }
  saveRestComandas();
  renderPickerRows();
  renderComandaItems(ACTIVE_COMANDA);
  renderSalon();
  if (APP.view === 'pos') syncCardRest(prodId);
}

/* ── COMANDA TICKET ── */
function showComandaTicket() {
  if (!ACTIVE_COMANDA) return;
  const m = REST_MESAS.find(x => x.id === ACTIVE_COMANDA);
  const c = REST_COMANDAS[ACTIVE_COMANDA] || { items: [], estado: 'libre' };
  const tiempo = new Date().toLocaleTimeString('es-CO', { hour: '2-digit', minute: '2-digit' });
  const estadoLabel = { libre:'🟢 Libre', en_curso:'🟡 En curso', en_cocina:'🍳 Enviado a cocina', cuenta_pedida:'🧾 Cuenta pedida' };
  const estadoBg    = { libre:'#ECFDF5', en_curso:'#FFF7ED', en_cocina:'#FFF7ED', cuenta_pedida:'#FEF2F2' };
  const estadoColor = { libre:'#10B981', en_curso:'#F59E0B', en_cocina:'#F59E0B', cuenta_pedida:'#EF4444' };
  const estado = c.estado || 'libre';
  const total  = (c.items || []).reduce((s, i) => s + i.unitPrice * i.qty, 0);
  document.getElementById('ticketMesaNum').textContent = 'Mesa ' + (m ? m.numero : '');
  document.getElementById('ticketTime').textContent    = tiempo;
  document.getElementById('ticketBody').innerHTML = `
    <hr class="ticket-hr" style="margin-top:0">
    ${(c.items || []).length
      ? (c.items || []).map(it => `
          <div class="ticket-item">
            <span class="ticket-item-qty">${it.qty}×</span>
            <span class="ticket-item-name">${it.emoji} ${it.name}</span>
            <span class="ticket-item-price">${fmt(it.unitPrice * it.qty)}</span>
          </div>
          ${it.nota ? `<div class="ticket-nota">↳ ${it.nota}</div>` : ''}`).join('')
      : '<div style="text-align:center;color:#999;padding:10px 0;font-family:Lato,sans-serif;font-size:13px">Sin productos</div>'}
    <hr class="ticket-hr">
    <div class="ticket-total-row"><span>TOTAL</span><span>${fmt(total)}</span></div>
    <div style="text-align:center;margin-top:10px">
      <span class="ticket-estado-badge" style="background:${estadoBg[estado]};color:${estadoColor[estado]}">${estadoLabel[estado]}</span>
    </div>`;
  document.getElementById('comandaTicketOverlay').classList.add('open');
}

function closeComandaTicket() {
  document.getElementById('comandaTicketOverlay').classList.remove('open');
}

/* ═══════════════════════════════════════════
   NAVIGATION
═══════════════════════════════════════════ */
function goTo(view) {
  const prevView = APP.view;
  if (prevView === 'pos' && APP.mesa && view !== 'pos') {
    MESA_ORDERS[APP.mesa] = { cart: [...APP.cart], order: APP.order };
    saveMesaOrders();
  }
  APP.view = view;
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.toggle('active', t.dataset.view === view));
  document.querySelectorAll('.bn-tab').forEach(t => t.classList.toggle('active', t.dataset.view === view));
  document.querySelectorAll('.view').forEach(v => v.classList.toggle('active', v.id === 'view-' + view));
  document.getElementById('cartFloat').style.display = (view === 'pos' && APP.mode !== 'restaurante') ? '' : 'none';
  if (view !== 'pos') closePickerFloat();
  if (view === 'pos')       { renderCats(); renderProducts(); renderCart();
    if (APP.mode === 'restaurante' && ACTIVE_COMANDA) openPickerFloat();
  }
  if (view === 'inventory') { renderInventory(); }
  if (view === 'cierre')    { renderCierre(); }
  if (view === 'reports')   { renderReports(); }
  if (view === 'mesas')     { renderMesas(); }
  if (view === 'salon')     { renderSalon(); }
}

/* ═══════════════════════════════════════════
   POS — CATEGORIES
═══════════════════════════════════════════ */
function renderCats() {
  const bar = document.getElementById('categoriesBar');
  const all = [{ id: 'all', label: 'Todos', icon: '🏪' }, ...CATS];
  bar.innerHTML = all.map(c => `
    <button class="cat-pill ${c.id === APP.cat ? 'active' : ''}" onclick="setCat('${c.id}')">
      ${c.icon} ${c.label}
    </button>`).join('');
}

function setCat(id) { APP.cat = id; renderCats(); renderProducts(); }

/* ═══════════════════════════════════════════
   POS — PRODUCTS
═══════════════════════════════════════════ */
function renderProducts() {
  let list = APP.products;
  if (APP.cat !== 'all') list = list.filter(p => p.cat === APP.cat);
  if (APP.search) {
    const q = APP.search.toLowerCase();
    list = list.filter(p => p.name.toLowerCase().includes(q));
  }

  document.getElementById('sectionMeta').innerHTML =
    `<strong>${list.length}</strong> producto${list.length !== 1 ? 's' : ''}`;

  if (!list.length) {
    document.getElementById('productsGrid').innerHTML = `<div class="empty-state"><div class="ei">🔍</div><p>No se encontraron productos</p></div>`;
    return;
  }

  const isRest  = APP.mode === 'restaurante';
  const comanda = isRest && ACTIVE_COMANDA ? (REST_COMANDAS[ACTIVE_COMANDA] || { items: [] }) : null;

  document.getElementById('productsGrid').innerHTML = list.map((p, idx) => {
    const price  = fp(p);
    const item   = comanda ? (comanda.items || []).find(x => x.id === p.id) : APP.cart.find(x => x.id === p.id);
    const qty    = item ? item.qty : 0;
    const sClass = p.stock === 0 ? 'empty' : p.stock <= 5 ? 'low' : '';
    const oos    = p.stock === 0;
    return `
      <div class="product-card ${qty > 0 ? 'in-cart' : ''} ${oos ? 'out-of-stock' : ''}" id="pc-${p.id}" style="animation-delay:${idx * 38}ms"
           onclick="cardClick('${p.id}', event)">
        ${p.discount ? `<div class="discount-badge">-${p.discount}%</div>` : ''}
        <div class="p-emoji">${p.emoji}</div>
        <div class="p-name">${p.name}</div>
        ${p.discount ? `<div class="p-old-price">${fmt(p.price)}</div>` : ''}
        <div class="p-price">${fmt(price)}</div>
        <div class="p-stock ${sClass}">Stock: ${p.stock}</div>
        <div class="card-actions">
          <button class="card-add-btn" id="cadd-${p.id}"
            style="${qty > 0 || oos ? 'display:none' : ''}"
            onclick="event.stopPropagation(); onAddCard('${p.id}')">
            + Agregar
          </button>
          <div class="card-qty-ctrl ${qty > 0 ? 'show' : ''}" id="cqctrl-${p.id}">
            <button class="cq-btn" onclick="event.stopPropagation(); handleCardQty('${p.id}',-1)">−</button>
            <input type="number" class="cq-input" id="cqnum-${p.id}" value="${qty}" min="0"
              onclick="event.stopPropagation(); this.select()"
              oninput="event.stopPropagation(); handleCardQtyInput('${p.id}', this.value)"
              onkeydown="event.stopPropagation()">
            <button class="cq-btn" onclick="event.stopPropagation(); handleCardQty('${p.id}',1)">+</button>
          </div>
        </div>
      </div>`;
  }).join('');
}

/* Sync just one card's display */
function syncCard(id) {
  const item  = APP.cart.find(x => x.id === id);
  const qty   = item ? item.qty : 0;
  const prod  = APP.products.find(p => p.id === id);
  const card  = document.getElementById(`pc-${id}`);
  const addB  = document.getElementById(`cadd-${id}`);
  const ctrl  = document.getElementById(`cqctrl-${id}`);
  const numEl = document.getElementById(`cqnum-${id}`);
  if (!card) return;
  if (qty > 0) {
    card.classList.add('in-cart');
    if (addB)  addB.style.display = 'none';
    if (ctrl)  ctrl.classList.add('show');
    if (numEl) numEl.value = qty;
  } else {
    card.classList.remove('in-cart');
    if (addB)  addB.style.display = prod && prod.stock > 0 ? '' : 'none';
    if (ctrl)  ctrl.classList.remove('show');
  }
  // Update stock display
  const sEl = card.querySelector('.p-stock');
  if (sEl && prod) {
    sEl.className = `p-stock ${prod.stock === 0 ? 'empty' : prod.stock <= 5 ? 'low' : ''}`;
    sEl.textContent = `Stock: ${prod.stock}`;
  }
}

/* Click anywhere on card (not on action area) */
function cardClick(id, e) {
  if (e.target.closest('.card-actions')) return;
  const prod = APP.products.find(p => p.id === id);
  if (!prod || prod.stock === 0) return;
  onAddCard(id);
}

/* Mode-aware add from product card */
function onAddCard(id) {
  if (APP.mode === 'restaurante') addProdToComanda(id);
  else addToCart(id);
}

/* Add product to active comanda (restaurante mode) */
function addProdToComanda(id) {
  if (!ACTIVE_COMANDA) { toast('🪑 Selecciona una mesa primero'); return; }
  pickerQty(id, 1);
  const f = document.getElementById('pickerFloat');
  if (!f.classList.contains('open')) openPickerFloat();
  const p = APP.products.find(x => x.id === id);
  const m = REST_MESAS.find(x => x.id === ACTIVE_COMANDA);
  if (p) toast(`✓ ${p.name}${m ? ` → Mesa ${m.numero}` : ''}`);
}

/* Mode-aware +/− on card */
function handleCardQty(id, delta) {
  if (APP.mode === 'restaurante') {
    if (!ACTIVE_COMANDA) { toast('🪑 Selecciona una mesa primero'); return; }
    pickerQty(id, delta);
    const f = document.getElementById('pickerFloat');
    if (!f.classList.contains('open')) openPickerFloat();
  } else {
    cardQty(id, delta);
  }
}

/* Mode-aware qty input on card */
function handleCardQtyInput(id, val) {
  if (APP.mode === 'restaurante') {
    if (!ACTIVE_COMANDA) return;
    const n = parseInt(val) || 0;
    const p = APP.products.find(x => x.id === id);
    if (!p) return;
    if (!REST_COMANDAS[ACTIVE_COMANDA]) REST_COMANDAS[ACTIVE_COMANDA] = { items: [], estado: 'en_curso', timestamp: Date.now() };
    const c = REST_COMANDAS[ACTIVE_COMANDA];
    const ex = c.items.find(i => i.id === id);
    if (n > 0) {
      if (ex) ex.qty = n;
      else c.items.push({ id: p.id, name: p.name, emoji: p.emoji, qty: n, unitPrice: fp(p), cost: p.cost || 0, nota: '' });
    } else {
      c.items = c.items.filter(i => i.id !== id);
    }
    saveRestComandas();
    syncCardRest(id);
    renderPickerRows();
    renderComandaItems(ACTIVE_COMANDA);
  } else {
    cardQtyInput(id, val);
  }
}

/* Sync card display from comanda qty (restaurante mode) */
function syncCardRest(id) {
  if (!ACTIVE_COMANDA) return;
  const c   = REST_COMANDAS[ACTIVE_COMANDA] || { items: [] };
  const item = (c.items || []).find(x => x.id === id);
  const qty  = item ? item.qty : 0;
  const prod = APP.products.find(p => p.id === id);
  const card  = document.getElementById(`pc-${id}`);
  const addB  = document.getElementById(`cadd-${id}`);
  const ctrl  = document.getElementById(`cqctrl-${id}`);
  const numEl = document.getElementById(`cqnum-${id}`);
  if (!card) return;
  if (qty > 0) {
    card.classList.add('in-cart');
    if (addB)  addB.style.display = 'none';
    if (ctrl)  ctrl.classList.add('show');
    if (numEl) numEl.value = qty;
  } else {
    card.classList.remove('in-cart');
    if (addB)  addB.style.display = prod && prod.stock > 0 ? '' : 'none';
    if (ctrl)  ctrl.classList.remove('show');
  }
}

/* ═══ CART OPERATIONS ═══ */
function addToCart(id) {
  const p = APP.products.find(x => x.id === id);
  if (!p || p.stock === 0) return;
  const ex = APP.cart.find(x => x.id === id);
  if (ex) {
    if (ex.qty >= p.stock) { toast(`⚠️ Solo hay ${p.stock} en stock`); return; }
    ex.qty++;
  } else {
    APP.cart.push({ ...p, qty: 1 });
  }
  const card = document.getElementById(`pc-${id}`);
  const emojiEl = card ? card.querySelector('.p-emoji') : null;
  if (emojiEl) { emojiEl.classList.remove('pop'); void emojiEl.offsetWidth; emojiEl.classList.add('pop'); setTimeout(() => emojiEl.classList.remove('pop'), 340); }
  syncCard(id);
  renderCart();
  toast(`✓ ${p.name} agregado`);
}

function cardQty(id, delta) {
  if (delta === 1) {
    const prod = APP.products.find(p => p.id === id);
    const ex   = APP.cart.find(x => x.id === id);
    if (!ex) { addToCart(id); return; }
    if (ex.qty >= prod.stock) { toast(`⚠️ Solo hay ${prod.stock} en stock`); return; }
  }
  const i = APP.cart.findIndex(x => x.id === id);
  if (i === -1) return;
  APP.cart[i].qty += delta;
  if (APP.cart[i].qty <= 0) APP.cart.splice(i, 1);
  syncCard(id);
  renderCart();
}

function cardQtyInput(id, val) {
  const n    = parseInt(val) || 0;
  const prod = APP.products.find(p => p.id === id);
  const i    = APP.cart.findIndex(x => x.id === id);
  const capped = Math.min(n, prod ? prod.stock : n);
  if (capped > 0) {
    if (i === -1) APP.cart.push({ ...prod, qty: capped });
    else APP.cart[i].qty = capped;
  } else {
    if (i !== -1) APP.cart.splice(i, 1);
  }
  syncCard(id);
  renderCart();
}

function panelQty(id, delta) {
  const i = APP.cart.findIndex(x => x.id === id);
  if (i === -1) return;
  if (delta === 1) {
    const prod = APP.products.find(p => p.id === id);
    if (APP.cart[i].qty >= prod.stock) { toast(`⚠️ Stock máximo: ${prod.stock}`); return; }
  }
  APP.cart[i].qty += delta;
  if (APP.cart[i].qty <= 0) APP.cart.splice(i, 1);
  syncCard(id);
  renderCart();
}

function removeFromCart(id) {
  const row = document.querySelector(`[data-ci="${id}"]`);
  if (row) {
    row.classList.add('removing');
    setTimeout(() => {
      APP.cart = APP.cart.filter(x => x.id !== id);
      syncCard(id);
      renderCart();
    }, 200);
  } else {
    APP.cart = APP.cart.filter(x => x.id !== id);
    syncCard(id);
    renderCart();
  }
}

function clearCart() {
  const ids = APP.cart.map(x => x.id);
  APP.cart = [];
  ids.forEach(syncCard);
  renderCart();
  document.getElementById('cartFloat').classList.remove('pinned');
  toast('🗑️ Carrito vaciado');
}

/* ═══ RENDER CART ═══ */
function renderCart() {
  const cf = document.getElementById('cartFloat');
  if (APP.view !== 'pos' || !APP.cart.length) { cf.classList.remove('visible'); return; }
  cf.classList.add('visible');
  const n = APP.cart.reduce((a, i) => a + i.qty, 0);
  const { sub, iva, total } = totals();

  document.getElementById('cbBadge').textContent = n;
  document.getElementById('cbItems').textContent  = `${n} producto${n !== 1 ? 's' : ''}`;
  document.getElementById('cbTotal').textContent  = fmt(total);

  document.getElementById('cartList').innerHTML = APP.cart.map(item => `
    <div class="ci" data-ci="${item.id}">
      <div class="ci-emoji">${item.emoji}</div>
      <div class="ci-info">
        <div class="ci-name">${item.name}</div>
        <div class="ci-unit">${fmt(fp(item))} c/u</div>
      </div>
      <div class="ci-qty">
        <button class="ciqb minus" onclick="panelQty('${item.id}',-1)">−</button>
        <span class="ci-n">${item.qty}</span>
        <button class="ciqb" onclick="panelQty('${item.id}',1)">+</button>
      </div>
      <div class="ci-sub">${fmt(fp(item) * item.qty)}</div>
      <button class="ci-del" onclick="removeFromCart('${item.id}')" title="Eliminar">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 01-2 2H8a2 2 0 01-2-2L5 6"/><path d="M10 11v6M14 11v6"/></svg>
      </button>
    </div>`).join('');

  document.getElementById('cartTotals').innerHTML = `
    <div class="tc"><span class="tc-lbl">Subtotal</span><span class="tc-val">${fmt(sub)}</span></div>
    <div class="tc"><span class="tc-lbl">IVA (19%)</span><span class="tc-val">${fmt(iva)}</span></div>
    <div class="tc"><span class="tc-lbl">Total</span><span class="tc-val big">${fmt(total)}</span></div>`;
}

/* Cart pin */
document.getElementById('cartBar').addEventListener('click', e => {
  if (e.target.closest('.btn-pagar')) return;
  document.getElementById('cartFloat').classList.toggle('pinned');
});
document.addEventListener('click', e => {
  const cf = document.getElementById('cartFloat');
  if (cf.classList.contains('pinned') && !cf.contains(e.target)) cf.classList.remove('pinned');
});

/* ═══════════════════════════════════════════
   PAYMENT
═══════════════════════════════════════════ */
function openPayment(e) {
  if (e) e.stopPropagation();
  if (!APP.cart.length) return;
  const { sub, iva, total } = totals();
  document.getElementById('orderNum').textContent    = APP.order;
  document.getElementById('modalTotal').textContent  = fmt(total);
  document.getElementById('modalBreak').textContent  = `Subtotal: ${fmt(sub)} · IVA: ${fmt(iva)}`;
  document.getElementById('cashInput').value         = '';
  document.getElementById('changeRow').style.display = 'none';
  selectMethod('efectivo');
  const rounds = [50000, 100000, 200000, 500000].filter(v => v > total);
  document.getElementById('quickAmts').innerHTML =
    `<button class="qamt" onclick="setAmt(${total})">Exacto</button>` +
    [...new Set(rounds)].slice(0, 3).map(v =>
      `<button class="qamt" onclick="setAmt(${v})">${fmt(v)}</button>`).join('');
  document.getElementById('payOverlay').classList.add('open');
}
function closePayment()  { document.getElementById('payOverlay').classList.remove('open'); }

function selectMethod(m) {
  APP.method = m;
  ['efectivo','tarjeta','transferencia'].forEach(x =>
    document.getElementById(`btn-${x}`).classList.toggle('active', x === m));
  document.getElementById('cashSection').style.display = m === 'efectivo' ? 'block' : 'none';
}
function setAmt(v)  { document.getElementById('cashInput').value = v; calcChange(); }
function calcChange() {
  const { total } = totals();
  const recv = parseFloat(document.getElementById('cashInput').value) || 0;
  const row  = document.getElementById('changeRow');
  if (recv >= total) { document.getElementById('changeAmt').textContent = fmt(recv - total); row.style.display = 'flex'; }
  else row.style.display = 'none';
}
function confirmPayment() {
  const { total } = totals();
  if (APP.method === 'efectivo') {
    const recv = parseFloat(document.getElementById('cashInput').value) || 0;
    if (recv < total) { toast('⚠️ Monto insuficiente'); return; }
  }
  // Save sale
  const recv   = APP.method === 'efectivo' ? parseFloat(document.getElementById('cashInput').value) || total : total;
  const { sub, iva } = totals();
  const sale   = {
    id: crypto.randomUUID(),
    order: APP.order,
    date: todayStr(),
    timestamp: Date.now(),
    time: new Date().toLocaleTimeString('es-CO', { hour:'2-digit', minute:'2-digit' }),
    items: APP.cart.map(i => ({ id: i.id, name: i.name, emoji: i.emoji, qty: i.qty, unitPrice: fp(i), cost: i.cost || 0, subtotal: fp(i)*i.qty })),
    subtotal: sub, iva, total, method: APP.method,
    received: recv, change: recv - total,
  };
  const sales = DB.getSales();
  sales.push(sale);
  DB.saveSales(sales);
  SB.saveSale(sale);
  // Decrement stock
  APP.cart.forEach(item => {
    const p = APP.products.find(x => x.id === item.id);
    if (p) { p.stock = Math.max(0, p.stock - item.qty); SB.syncProduct(p); }
  });
  DB.saveProducts(APP.products);
  closePayment();
  buildReceipt(sale);
  document.getElementById('receiptOverlay').classList.add('open');
}

/* ═══ RECEIPT ═══ */
function buildReceipt(sale) {
  const ml = { efectivo:'Efectivo', tarjeta:'Tarjeta', transferencia:'Nequi/Daviplata' }[sale.method];
  document.getElementById('receiptBody').innerHTML = `
    <div class="receipt-row" style="color:var(--muted)"><span>Orden: #${sale.order}</span><span>${sale.date} ${sale.time}</span></div>
    <div class="receipt-row" style="color:var(--muted);margin-bottom:8px"><span>Cajero: María Aparicio</span></div>
    <hr class="receipt-hr">
    ${sale.items.map(i => `<div class="receipt-row"><span>${i.emoji} ${i.name} x${i.qty}</span><span>${fmt(i.subtotal)}</span></div>`).join('')}
    <hr class="receipt-hr">
    <div class="receipt-row"><span>Subtotal</span><span>${fmt(sale.subtotal)}</span></div>
    <div class="receipt-row"><span>IVA (19%)</span><span>${fmt(sale.iva)}</span></div>
    <hr class="receipt-hr">
    <div class="receipt-total-row"><span>TOTAL</span><span>${fmt(sale.total)}</span></div>
    <hr class="receipt-hr">
    <div class="receipt-row"><span>Pago: ${ml}</span></div>
    ${sale.method === 'efectivo' ? `<div class="receipt-row"><span>Recibido</span><span>${fmt(sale.received)}</span></div><div class="receipt-row" style="font-weight:700"><span>Cambio</span><span>${fmt(sale.change)}</span></div>` : ''}`;
}

function newSale() {
  document.getElementById('receiptOverlay').classList.remove('open');
  if (APP.mode === 'restaurante' && APP.mesa) {
    delete REST_COMANDAS[APP.mesa];
    saveRestComandas();
    APP.mesa  = null;
    APP.cart  = [];
    APP.order = genOrder();
    goTo('salon');
    toast('✓ Mesa liberada');
    return;
  }
  if (APP.mesa) {
    delete MESA_ORDERS[APP.mesa];
    saveMesaOrders();
    APP.mesa  = null;
    APP.cart  = [];
    APP.order = genOrder();
    updateMesaBadge();
    goTo('mesas');
    toast('✓ Mesa liberada');
    return;
  }
  APP.cart  = [];
  APP.order = genOrder();
  renderProducts();
  renderCart();
  document.getElementById('cartFloat').classList.remove('pinned');
  toast('🛍️ Nueva venta iniciada');
}

/* ═══════════════════════════════════════════
   INVENTORY
═══════════════════════════════════════════ */
function renderInventory() {
  const ivaEl = document.getElementById('ivaInput');
  if (ivaEl) ivaEl.value = IVA_RATE;
  // Cat filter pills
  const all = [{ id: 'all', label: 'Todos' }, ...CATS];
  document.getElementById('invCatFilters').innerHTML = all.map(c => `
    <button class="filter-pill ${c.id === APP.invCat ? 'active' : ''}"
      onclick="setInvCat('${c.id}')">${c.label}</button>`).join('');

  let list = APP.products;
  if (APP.invCat !== 'all') list = list.filter(p => p.cat === APP.invCat);
  if (APP.invSearch) {
    const q = APP.invSearch.toLowerCase();
    list = list.filter(p => p.name.toLowerCase().includes(q));
  }

  document.getElementById('invTableBody').innerHTML = list.length ? list.map(p => {
    const sc = p.stock === 0 ? 'empty' : p.stock <= 5 ? 'low' : 'ok';
    const sl = p.stock === 0 ? '🔴 Sin stock' : p.stock <= 5 ? `⚠️ ${p.stock} uds` : `${p.stock} uds`;
    const catLabel = CATS.find(c => c.id === p.cat)?.label || p.cat;
    return `
      <tr>
        <td>
          <div class="prod-cell">
            <div class="prod-cell-emoji">${p.emoji}</div>
            <div><div class="prod-cell-name">${p.name}</div></div>
          </div>
        </td>
        <td><span class="cat-tag">${catLabel}</span></td>
        <td>${p.cost ? `<span style="color:var(--muted)">${fmt(p.cost)}</span>` : '<span style="color:var(--muted)">—</span>'}</td>
        <td><strong>${fmt(p.price)}</strong>${p.discount ? `<br><small style="color:var(--red)">Con dcto: ${fmt(fp(p))}</small>` : ''}</td>
        <td><span class="stock-badge ${sc}">${sl}</span></td>
        <td>
          <div class="action-btns">
            <button class="icon-btn edit" onclick="openEditProduct('${p.id}')" title="Editar">
              <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
            </button>
            <button class="icon-btn del" onclick="confirmDeleteProduct('${p.id}')" title="Eliminar">
              <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 01-2 2H8a2 2 0 01-2-2L5 6"/></svg>
            </button>
          </div>
        </td>
      </tr>`;
  }).join('') : `<tr><td colspan="6" style="text-align:center;padding:40px;color:var(--muted)">No hay productos en esta categoría</td></tr>`;
}

function setInvCat(id) { APP.invCat = id; renderInventory(); }

/* ── AUTO EMOJI ── */
let emojiManual = false;

const EMOJI_MAP = [
  [/camiseta|camisa|polo|blusa|top\b/,            '👕'],
  [/pantalon|pantalón|jean|jeans/,                 '👖'],
  [/vestido/,                                      '👗'],
  [/chaqueta|abrigo|saco|blazer|sueter|suéter/,    '🧥'],
  [/sudadera|hoodie/,                              '🩱'],
  [/falda/,                                        '👚'],
  [/ropa interior|boxer|calzon|calzón/,            '🩲'],
  [/medias|calcetines/,                            '🧦'],
  [/corbata/,                                      '👔'],
  [/pijama/,                                       '😴'],
  [/zapatillas|tenis\b|deportivo/,                 '👟'],
  [/botas|bota\b/,                                 '🥾'],
  [/sandalias|sandalia|chanclas|chancletas/,        '🩴'],
  [/zapatos|zapato|mocasines|loafer/,              '👞'],
  [/tacones|talon|taconas/,                        '👠'],
  [/bolso|cartera|mochila|bolsa|maleta/,           '👜'],
  [/cinturon|cinturón|correa\b/,                   '🪢'],
  [/reloj/,                                        '⌚'],
  [/gafas|lentes|anteojos|sol\b/,                  '🕶️'],
  [/bufanda|pañuelo/,                              '🧣'],
  [/sombrero|gorra|gorro|cachucha/,                '🧢'],
  [/guantes/,                                      '🧤'],
  [/collar|cadena|dije/,                           '📿'],
  [/aretes|pendientes|arillo/,                     '💍'],
  [/pulsera|brazalete/,                            '💎'],
  [/audifonos|audífonos|auriculares|headphone/,    '🎧'],
  [/cable|usb|cargador/,                           '🔌'],
  [/celular|telefono|teléfono|movil|móvil/,        '📱'],
  [/computador|laptop|portatil|portátil/,          '💻'],
  [/teclado/,                                      '⌨️'],
  [/raton|ratón|mouse/,                            '🖱️'],
  [/pantalla|monitor|television|televisor|tv\b/,   '🖥️'],
  [/parlante|altavoz|bocina|speaker/,              '🔊'],
  [/camara|cámara/,                                '📷'],
  [/bateria|batería|pila/,                         '🔋'],
  [/nevera|refrigerador|heladera/,                 '🧊'],
  [/lavadora|secadora/,                            '🫧'],
  [/microondas/,                                   '📦'],
  [/licuadora|batidora/,                           '🥤'],
  [/olla|sarten|sartén|wok|cazuela/,               '🥘'],
  [/cama|colchon|colchón|almohada/,                '🛏️'],
  [/sofa|sofá|silla|poltrona/,                     '🪑'],
  [/mesa|escritorio/,                              '🪵'],
  [/lampara|lámpara|foco|bombillo/,                '💡'],
  [/espejo/,                                       '🪞'],
  [/toalla/,                                       '🛁'],
  [/sabana|sábana/,                                '🛏️'],
  [/cortina/,                                      '🪟'],
  [/planta|flores|maceta|jarron/,                  '🪴'],
  [/escoba|trapero|limpieza|detergente/,           '🧹'],
  [/vaso|copa|taza|mug/,                           '☕'],
  [/plato|vajilla/,                                '🍽️'],
  [/leche/,                                        '🥛'],
  [/pan\b|panaderia|pandebono/,                    '🍞'],
  [/arroz/,                                        '🍚'],
  [/pollo/,                                        '🍗'],
  [/carne|res\b|cerdo/,                            '🥩'],
  [/pescado|atun|atún/,                            '🐟'],
  [/huevo/,                                        '🥚'],
  [/aceite/,                                       '🫙'],
  [/cafe|café\b/,                                  '☕'],
  [/agua\b/,                                       '💧'],
  [/jugo|bebida|gaseosa|refresco/,                 '🧃'],
  [/cerveza/,                                      '🍺'],
  [/vino/,                                         '🍷'],
  [/snack|papas\b|chips/,                          '🥔'],
  [/chocolate|dulce|caramelo|gomita/,              '🍫'],
  [/torta|pastel|cake|ponque/,                     '🎂'],
  [/helado/,                                       '🍦'],
  [/shampoo|champu|champú|cabello|pelo\b/,         '🧴'],
  [/perfume|colonia|fragancia/,                    '🌸'],
  [/crema|locion|loción|hidratante/,               '🧴'],
  [/maquillaje|labial|sombra\b|rubor/,             '💄'],
  [/jabon|jabón|gel\b/,                            '🧼'],
  [/cepillo|dental|dientes/,                       '🪥'],
  [/pelota|balon|balón/,                           '⚽'],
  [/bicicleta|bici\b/,                             '🚲'],
  [/pesas|mancuerna|gym|gimnasio/,                 '🏋️'],
  [/tenis\b.*raqueta|raqueta/,                     '🎾'],
  [/yoga|mat\b/,                                   '🧘'],
  [/juguete|muñeca|peluche/,                       '🧸'],
  [/bebe|bebé|pañal/,                              '👶'],
  [/cuaderno|libreta|agenda/,                      '📓'],
  [/lapiz|lápiz|esfero|boligrafo|bolígrafo/,       '✏️'],
  [/tijeras/,                                      '✂️'],
  [/libro|revista/,                                '📚'],
  [/regalo|obsequio/,                              '🎁'],
  [/flores|ramo\b/,                                '💐'],
  [/perro|gato|mascota|croquetas/,                 '🐾'],
  [/martillo|tornillo|herramienta/,                '🔨'],
  [/pintura|pincel/,                               '🎨'],
];

function suggestEmoji(name) {
  if (emojiManual) return;
  const n = name.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
  for (const [regex, emoji] of EMOJI_MAP) {
    if (regex.test(n)) {
      document.getElementById('pEmoji').value = emoji;
      return;
    }
  }
  document.getElementById('pEmoji').value = '';
}

function openProductModal(prefill) {
  const isEdit = !!prefill;
  emojiManual  = isEdit; // en edición no sobreescribir emoji existente
  document.getElementById('productModalTitle').textContent = isEdit ? 'Editar Producto' : 'Nuevo Producto';
  document.getElementById('productId').value    = isEdit ? prefill.id : '';
  document.getElementById('pEmoji').value       = isEdit ? prefill.emoji : '';
  document.getElementById('pName').value        = isEdit ? prefill.name : '';
  document.getElementById('pCost').value        = isEdit ? (prefill.cost || '') : '';
  document.getElementById('pPrice').value       = isEdit ? prefill.price : '';
  document.getElementById('pDiscount').value    = isEdit ? (prefill.discount || '') : '';
  document.getElementById('pStock').value       = isEdit ? prefill.stock : '';
  // Populate category select
  document.getElementById('pCat').innerHTML = CATS.map(c =>
    `<option value="${c.id}" ${isEdit && prefill.cat === c.id ? 'selected' : ''}>${c.label}</option>`).join('');
  if (isEdit) document.getElementById('pCat').value = prefill.cat;
  document.getElementById('productOverlay').classList.add('open');
}

function openEditProduct(id) {
  const p = APP.products.find(x => x.id === id);
  if (p) openProductModal(p);
}

function closeProductModal() { document.getElementById('productOverlay').classList.remove('open'); }

function saveProduct() {
  const id       = document.getElementById('productId').value || null;
  const emoji    = document.getElementById('pEmoji').value.trim()    || '📦';
  const name     = document.getElementById('pName').value.trim();
  const cat      = document.getElementById('pCat').value;
  const cost     = parseInt(document.getElementById('pCost').value) || 0;
  const price    = parseInt(document.getElementById('pPrice').value) || 0;
  const discount = parseInt(document.getElementById('pDiscount').value) || 0;
  const stock    = parseInt(document.getElementById('pStock').value) || 0;

  if (!name)  { toast('⚠️ El nombre es obligatorio'); return; }
  if (!price) { toast('⚠️ El precio es obligatorio'); return; }
  if (!cat)   { toast('⚠️ Selecciona una categoría'); return; }

  if (id) {
    // Edit
    const i = APP.products.findIndex(p => p.id === id);
    if (i !== -1) {
      APP.products[i] = { ...APP.products[i], emoji, name, cat, cost, price, discount: discount || undefined, stock };
      SB.syncProduct(APP.products[i]);
    }
    toast('✓ Producto actualizado');
  } else {
    // Create
    const newProd = { id: crypto.randomUUID(), emoji, name, cat, cost, price, discount: discount || undefined, stock };
    APP.products.push(newProd);
    SB.syncProduct(newProd);
    toast('✓ Producto creado');
  }
  DB.saveProducts(APP.products);
  closeProductModal();
  renderInventory();
}

function confirmDeleteProduct(id) {
  const p = APP.products.find(x => x.id === id);
  openConfirm('🗑️', '¿Eliminar producto?', `"${p.name}" se eliminará del inventario.`, 'Esta acción no se puede deshacer.', () => {
    APP.products = APP.products.filter(x => x.id !== id);
    APP.cart     = APP.cart.filter(x => x.id !== id);
    DB.saveProducts(APP.products);
    SB.deleteProduct(id);
    renderInventory();
    toast(`🗑️ ${p.name} eliminado`);
  }, 'btn-danger');
}

/* ═══════════════════════════════════════════
   CIERRE DE CAJA
═══════════════════════════════════════════ */
function renderCierre() {
  const today  = todayStr();
  const sales  = DB.getSales().filter(s => s.date === today);
  const cierres = DB.getCierres();
  const closed = cierres.find(c => c.date === today);

  document.getElementById('cierreDate').textContent =
    new Date().toLocaleDateString('es-CO', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })
      .replace(/^\w/, c => c.toUpperCase());

  const total   = sales.reduce((a, s) => a + s.total, 0);
  const ivaSum  = sales.reduce((a, s) => a + s.iva, 0);
  const byM     = { efectivo: 0, tarjeta: 0, transferencia: 0 };
  sales.forEach(s => { byM[s.method] = (byM[s.method] || 0) + s.total; });

  // Banner
  document.getElementById('cierreBanner').innerHTML = closed
    ? `<div class="cierre-closed-banner"><div class="icon">✅</div><div class="text"><strong>Caja cerrada</strong><span>Cierre registrado hoy a las ${new Date(closed.closedAt).toLocaleTimeString('es-CO', { hour:'2-digit', minute:'2-digit' })}</span></div></div>`
    : '';

  // Stats
  document.getElementById('cierreStats').innerHTML = `
    <div class="stat-card blue"><div class="stat-card-label">Ventas</div><div class="stat-card-value">${sales.length}</div><div class="stat-card-sub">transacciones hoy</div></div>
    <div class="stat-card green"><div class="stat-card-label">Ingresos totales</div><div class="stat-card-value">${fmt(total)}</div><div class="stat-card-sub">sin IVA: ${fmt(total - ivaSum)}</div></div>
    <div class="stat-card orange"><div class="stat-card-label">IVA cobrado</div><div class="stat-card-value">${fmt(ivaSum)}</div><div class="stat-card-sub">19% sobre ventas</div></div>
    <div class="stat-card navy"><div class="stat-card-label">Efectivo</div><div class="stat-card-value">${fmt(byM.efectivo)}</div><div class="stat-card-sub">Tarjeta: ${fmt(byM.tarjeta)} · Nequi: ${fmt(byM.transferencia)}</div></div>`;

  // Actions
  document.getElementById('cierreActions').innerHTML = closed
    ? `<button class="btn-outline" onclick="printCierre()">🖨️ Imprimir cierre</button>`
    : `<button class="btn-success" onclick="cerrarCaja()">Cerrar Caja</button>
       <button class="btn-outline" onclick="printCierre()">🖨️ Vista previa</button>`;

  // Sales list
  if (!sales.length) {
    document.getElementById('cierreSalesList').innerHTML = `<p style="text-align:center;padding:30px;color:var(--muted)">No hay ventas registradas hoy</p>`;
    return;
  }
  document.getElementById('cierreSalesList').innerHTML = `
    <table class="sales-table">
      <thead><tr><th>Orden</th><th>Hora</th><th>Productos</th><th>Método</th><th>Total</th></tr></thead>
      <tbody>
        ${sales.slice().reverse().map(s => `
          <tr>
            <td><strong>#${s.order}</strong></td>
            <td>${s.time}</td>
            <td>${s.items.map(i => `${i.emoji} x${i.qty}`).join(' · ')}</td>
            <td><span class="method-badge ${s.method}">${{efectivo:'💵 Efectivo', tarjeta:'💳 Tarjeta', transferencia:'📲 Nequi'}[s.method]}</span></td>
            <td><strong>${fmt(s.total)}</strong></td>
          </tr>`).join('')}
      </tbody>
    </table>`;
}

function cerrarCaja() {
  openConfirm('🔐', '¿Cerrar Caja?', 'Se registrará el cierre de caja del día de hoy.', 'Podrás seguir vendiendo después del cierre.', () => {
    const today  = todayStr();
    const sales  = DB.getSales().filter(s => s.date === today);
    const byM    = { efectivo: 0, tarjeta: 0, transferencia: 0 };
    sales.forEach(s => { byM[s.method] = (byM[s.method] || 0) + s.total; });
    const cierres = DB.getCierres().filter(c => c.date !== today);
    cierres.push({ date: today, closedAt: Date.now(), salesCount: sales.length, totalRevenue: sales.reduce((a,s) => a+s.total, 0), totalIva: sales.reduce((a,s) => a+s.iva, 0), byMethod: byM });
    DB.saveCierres(cierres);
    renderCierre();
    toast('✅ Caja cerrada exitosamente');
  }, 'btn-success');
}

function printCierre() { window.print(); }

/* ═══════════════════════════════════════════
   REPORTS
═══════════════════════════════════════════ */
function setReportRange(range) {
  APP.reportRange = range;
  document.querySelectorAll('.rf-btn').forEach(b => b.classList.toggle('active', b.dataset.range === range));
  renderReports();
}

function renderReports() {
  const allSales = DB.getSales();
  const now   = new Date();
  const today = todayStr();

  let sales = allSales;
  if (APP.reportRange === 'today') {
    sales = allSales.filter(s => s.date === today);
  } else if (APP.reportRange === 'week') {
    const weekAgo = new Date(now - 7*24*60*60*1000).toISOString().split('T')[0];
    sales = allSales.filter(s => s.date >= weekAgo);
  } else if (APP.reportRange === 'month') {
    const monthAgo = new Date(now - 30*24*60*60*1000).toISOString().split('T')[0];
    sales = allSales.filter(s => s.date >= monthAgo);
  }

  const totalRev   = sales.reduce((a, s) => a + s.total, 0);
  const totalIva   = sales.reduce((a, s) => a + s.iva, 0);
  const totalCost  = sales.reduce((a, s) => a + s.items.reduce((b, i) => b + (i.cost || 0) * i.qty, 0), 0);
  const totalProfit = totalRev - totalCost;
  const avgSale    = sales.length ? totalRev / sales.length : 0;
  const totalUnits = sales.reduce((a, s) => a + s.items.reduce((b, i) => b + i.qty, 0), 0);

  // KPI cards
  document.getElementById('reportKPIs').innerHTML = `
    <div class="stat-card blue"><div class="stat-card-label">Ingresos totales</div><div class="stat-card-value">${fmt(totalRev)}</div><div class="stat-card-sub">IVA incluido: ${fmt(totalIva)}</div></div>
    <div class="stat-card green"><div class="stat-card-label">Ganancia neta</div><div class="stat-card-value">${fmt(totalProfit)}</div><div class="stat-card-sub">Ingresos − costos</div></div>
    <div class="stat-card orange"><div class="stat-card-label">Ticket promedio</div><div class="stat-card-value">${fmt(avgSale)}</div><div class="stat-card-sub">por venta</div></div>
    <div class="stat-card navy"><div class="stat-card-label">Ventas</div><div class="stat-card-value">${sales.length}</div><div class="stat-card-sub">${totalUnits} unidades vendidas</div></div>`;

  // Top products by revenue
  const prodRevMap = {};
  sales.forEach(s => s.items.forEach(i => {
    prodRevMap[i.id] = (prodRevMap[i.id] || { name: i.name, emoji: i.emoji, rev: 0, qty: 0 });
    prodRevMap[i.id].rev += i.subtotal;
    prodRevMap[i.id].qty += i.qty;
  }));
  const topProds = Object.values(prodRevMap).sort((a,b) => b.rev - a.rev).slice(0, 8);
  const maxProd  = topProds[0]?.rev || 1;
  document.getElementById('chartTopProducts').innerHTML = topProds.length
    ? topProds.map(p => `
        <div class="bar-row">
          <span class="bar-lbl">${p.emoji} ${p.name}</span>
          <div class="bar-track"><div class="bar-fill" style="width:${(p.rev/maxProd*100).toFixed(1)}%"></div></div>
          <span class="bar-val">${fmt(p.rev)}</span>
        </div>`).join('')
    : '<p style="color:var(--muted);font-size:13px">Sin datos</p>';

  // By payment method
  const byM = { efectivo: 0, tarjeta: 0, transferencia: 0 };
  sales.forEach(s => { byM[s.method] = (byM[s.method] || 0) + s.total; });
  const maxM = Math.max(...Object.values(byM), 1);
  const mLabels = { efectivo: '💵 Efectivo', tarjeta: '💳 Tarjeta', transferencia: '📲 Nequi/Daviplata' };
  const mColors = { efectivo: 'green', tarjeta: '', transferencia: 'gold' };
  document.getElementById('chartMethods').innerHTML = Object.entries(byM).map(([m, v]) => `
    <div class="bar-row">
      <span class="bar-lbl">${mLabels[m]}</span>
      <div class="bar-track"><div class="bar-fill ${mColors[m]}" style="width:${(v/maxM*100).toFixed(1)}%"></div></div>
      <span class="bar-val">${fmt(v)}</span>
    </div>`).join('');

  // Revenue by day (last 7)
  const days = [];
  for (let i = 6; i >= 0; i--) {
    const d = new Date(now - i*24*60*60*1000);
    const ds = d.toISOString().split('T')[0];
    const label = d.toLocaleDateString('es-CO', { weekday: 'short', day: 'numeric' });
    const rev   = allSales.filter(s => s.date === ds).reduce((a,s) => a+s.total, 0);
    days.push({ label, rev });
  }
  const maxDay = Math.max(...days.map(d => d.rev), 1);
  document.getElementById('chartDays').innerHTML = days.map(d => `
    <div class="bar-row">
      <span class="bar-lbl">${d.label}</span>
      <div class="bar-track"><div class="bar-fill green" style="width:${(d.rev/maxDay*100).toFixed(1)}%"></div></div>
      <span class="bar-val">${fmt(d.rev)}</span>
    </div>`).join('');
}

/* ═══════════════════════════════════════════
   THEME
═══════════════════════════════════════════ */
function toggleTheme() {
  const dark = document.body.classList.toggle('dark');
  ls.setItem(K+'theme', dark ? 'dark' : 'light');
  const btn = document.getElementById('themeBtn');
  btn.textContent = dark ? '☀️' : '🌙';
  btn.title = dark ? 'Modo claro' : 'Modo oscuro';
}
function loadTheme() {
  if (ls.getItem(K+'theme') === 'dark') {
    document.body.classList.add('dark');
    document.getElementById('themeBtn').textContent = '☀️';
    document.getElementById('themeBtn').title = 'Modo claro';
  }
}

/* ═══════════════════════════════════════════
   CATEGORIES MANAGEMENT
═══════════════════════════════════════════ */
function openCatsModal() {
  renderCatsList();
  document.getElementById('newCatIcon').value = '';
  document.getElementById('newCatName').value = '';
  document.getElementById('catsOverlay').classList.add('open');
}
function closeCatsModal() { document.getElementById('catsOverlay').classList.remove('open'); }

function renderCatsList() {
  const wrap = document.getElementById('catsChips');
  if (!CATS.length) {
    wrap.innerHTML = '<span class="cats-empty">Sin categorías</span>';
    return;
  }
  wrap.innerHTML = CATS.map(c => {
    const count = APP.products.filter(p => p.cat === c.id).length;
    const canDel = count === 0;
    return `
      <div class="cat-chip">
        <span>${c.icon} ${c.label}</span>
        ${count > 0 ? `<span style="font-size:10px;color:var(--muted)">(${count})</span>` : ''}
        <button class="cat-chip-del" onclick="deleteCat('${c.id}')"
          title="${canDel ? 'Eliminar' : `${count} productos asignados`}"
          ${!canDel ? 'style="opacity:0.35;cursor:not-allowed"' : ''}>×</button>
      </div>`;
  }).join('');
}

function addCat() {
  const icon  = document.getElementById('newCatIcon').value.trim() || '🏷️';
  const label = document.getElementById('newCatName').value.trim();
  if (!label) { toast('⚠️ Escribe el nombre de la categoría'); return; }
  const id = label.normalize('NFD').replace(/[\u0300-\u036f]/g, '')
    .toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '') || ('cat-' + Date.now());
  if (CATS.find(c => c.id === id)) { toast('⚠️ Ya existe esa categoría'); return; }
  const newCat = { id, label, icon };
  CATS.push(newCat);
  DB.saveCats(CATS);
  SB.syncCat(newCat);
  document.getElementById('newCatName').value = '';
  document.getElementById('newCatIcon').value = '';
  renderCatsList();
  renderCats();
  toast(`✓ "${label}" agregada`);
}

function deleteCat(id) {
  const count = APP.products.filter(p => p.cat === id).length;
  if (count > 0) { toast(`⚠️ Primero mueve los ${count} productos de esta categoría`); return; }
  CATS = CATS.filter(c => c.id !== id);
  DB.saveCats(CATS);
  SB.deleteCat(id);
  if (APP.cat === id)    APP.cat = 'all';
  if (APP.invCat === id) APP.invCat = 'all';
  renderCatsList();
  renderCats();
  renderInventory();
  toast('✓ Categoría eliminada');
}

/* ═══════════════════════════════════════════
   CONFIRM MODAL
═══════════════════════════════════════════ */
function openConfirm(icon, title, text, sub, callback, btnClass) {
  document.getElementById('confirmIcon').textContent   = icon;
  document.getElementById('confirmTitle').textContent  = title;
  document.getElementById('confirmText').textContent   = text;
  document.getElementById('confirmSub').textContent    = sub || '';
  APP.confirmCallback = callback;
  const btn = document.getElementById('confirmBtn');
  btn.className = btnClass || 'btn-danger';
  btn.textContent = 'Confirmar';
  document.getElementById('confirmOverlay').classList.add('open');
}
function closeConfirm() { document.getElementById('confirmOverlay').classList.remove('open'); APP.confirmCallback = null; }
function doConfirm()    { if (APP.confirmCallback) APP.confirmCallback(); closeConfirm(); }

/* ═══ CLOSE OVERLAYS ON BACKDROP ═══ */
['payOverlay','receiptOverlay','productOverlay','confirmOverlay','catsOverlay'].forEach(id => {
  document.getElementById(id).addEventListener('click', e => {
    if (e.target.id === id) document.getElementById(id).classList.remove('open');
  });
});

/* ═══ TOAST ═══ */
let toastT;
function toast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg; el.classList.add('show');
  clearTimeout(toastT);
  toastT = setTimeout(() => el.classList.remove('show'), 2400);
}

/* ═══ CLOCK ═══ */
function tick() {
  const n = new Date();
  document.getElementById('clock').textContent =
    n.toLocaleTimeString('es-CO', { hour:'2-digit', minute:'2-digit' });
  document.getElementById('dateDisplay').textContent =
    n.toLocaleDateString('es-CO', { day:'numeric', month:'short' });
}

/* ═══ SEARCH ═══ */
document.getElementById('searchInput').addEventListener('input', e => {
  APP.search = e.target.value; renderProducts();
});
document.getElementById('invSearchInput').addEventListener('input', e => {
  APP.invSearch = e.target.value; renderInventory();
});

/* ═══════════════════════════════════════════
   AUTH
═══════════════════════════════════════════ */
let authMode = 'login';
let _isNewRegistration = false;

function switchAuthTab(mode) {
  authMode = mode;
  document.getElementById('tabLogin').classList.toggle('active', mode === 'login');
  document.getElementById('tabRegister').classList.toggle('active', mode === 'register');
  document.getElementById('authSubmitBtn').textContent = mode === 'login' ? 'Entrar' : 'Crear cuenta';
  document.getElementById('authSubText').innerHTML = mode === 'login'
    ? '¿No tienes cuenta? <a href="#" onclick="switchAuthTab(\'register\'); return false;" style="color:var(--gold);font-weight:700">Regístrate gratis</a>'
    : '¿Ya tienes cuenta? <a href="#" onclick="switchAuthTab(\'login\'); return false;" style="color:var(--gold);font-weight:700">Inicia sesión</a>';
  hideAuthError();
}

function showAuthError(msg) {
  const el = document.getElementById('authError');
  el.textContent = msg; el.classList.add('show');
}
function hideAuthError() { document.getElementById('authError').classList.remove('show'); }
function setAuthLoading(on) {
  const btn = document.getElementById('authSubmitBtn');
  btn.disabled = on;
  btn.textContent = on ? 'Cargando...' : (authMode === 'login' ? 'Entrar' : 'Crear cuenta');
}

async function submitAuth() {
  hideAuthError();
  const username = document.getElementById('authEmail').value.trim().toLowerCase().replace(/\s+/g, '');
  const email    = username + '@flowpos.app';
  const password = document.getElementById('authPassword').value;
  if (!username || !password) { showAuthError('Completa todos los campos'); return; }
  setAuthLoading(true);
  if (authMode === 'login') {
    const { data, error } = await _sb.auth.signInWithPassword({ email, password });
    setAuthLoading(false);
    if (error) { showAuthError('Correo o contraseña incorrectos'); return; }
    await onAuthSuccess(data.user);
  } else {
    if (password.length < 6) { setAuthLoading(false); showAuthError('La contraseña debe tener mínimo 6 caracteres'); return; }
    const { data, error } = await _sb.auth.signUp({ email, password });
    setAuthLoading(false);
    if (error) { showAuthError(error.message); return; }
    if (data.user && data.session) {
      _isNewRegistration = true;
      await onAuthSuccess(data.user);
    } else {
      showAuthError('Revisa tu correo para confirmar tu cuenta antes de ingresar');
    }
  }
}

async function onAuthSuccess(user) {
  currentUser = user;
  document.getElementById('authOverlay').style.display = 'none';
  const name = user.email.split('@')[0];
  document.getElementById('cashierName').textContent = name;
  document.getElementById('cashierInitial').textContent = name.charAt(0).toUpperCase();
  await loadDataFromSupabase();
  loadTheme();
  applyBizName();
  if (_isNewRegistration) {
    _isNewRegistration = false;
    showOnboarding();
    return;
  }
  const savedMode = ls.getItem(K + 'mode');
  if (savedMode) {
    APP.mode = savedMode;
    applyMode(savedMode);
    showRoleOverlay();
  } else {
    showModeOverlay();
  }
}

/* ── ROLE SELECTION ── */
function showRoleOverlay() {
  currentRole = null;
  document.getElementById('rolePinSection').classList.remove('show');
  document.getElementById('rolePinInput').value = '';
  document.getElementById('roleError').textContent = '';
  document.querySelectorAll('.role-btn').forEach(b => b.classList.remove('selected'));
  document.getElementById('roleOverlay').style.display = 'flex';
}

function selectRole(role) {
  document.querySelectorAll('.role-btn').forEach(b => b.classList.remove('selected'));
  document.getElementById('roleBtn' + role.charAt(0).toUpperCase() + role.slice(1)).classList.add('selected');
  if (role === 'cajero') {
    currentRole = 'cajero';
    document.getElementById('roleOverlay').style.display = 'none';
    applyRoleRestrictions();
    goTo(APP.mode === 'restaurante' ? 'salon' : 'pos');
  } else {
    document.getElementById('rolePinSection').classList.add('show');
    setTimeout(() => document.getElementById('rolePinInput').focus(), 120);
  }
}

function confirmRole() {
  const pin      = document.getElementById('rolePinInput').value;
  const savedPin = localStorage.getItem(PIN_KEY) || '1213';
  if (pin === savedPin) {
    currentRole = 'admin';
    document.getElementById('roleOverlay').style.display = 'none';
    document.getElementById('rolePinInput').value = '';
    applyRoleRestrictions();
    goTo(APP.mode === 'restaurante' ? 'salon' : 'pos');
  } else {
    document.getElementById('roleError').textContent = 'PIN incorrecto';
    document.getElementById('rolePinInput').value = '';
    document.getElementById('rolePinInput').focus();
    setTimeout(() => document.getElementById('roleError').textContent = '', 2000);
  }
}

function applyRoleRestrictions() {
  const isAdmin = currentRole === 'admin';
  // Badge
  const badge = document.getElementById('roleBadge');
  badge.className = 'role-badge ' + currentRole;
  badge.textContent = isAdmin ? 'Admin' : 'Cajero';
  badge.style.display = 'inline-flex';
  document.getElementById('changeRoleBtn').style.display = 'inline-flex';
  // Nav tabs
  ['inventory','cierre','reports'].forEach(view => {
    document.querySelectorAll(`[data-view="${view}"]`).forEach(el => {
      el.style.display = isAdmin ? '' : 'none';
    });
  });
  // Gestionar categorías button
  const catBtn = document.querySelector('.btn-cat-manage');
  if (catBtn) catBtn.style.display = isAdmin ? '' : 'none';
  // Redirect if on restricted view
  if (!isAdmin && ['inventory','cierre','reports'].includes(APP.view)) goTo('pos');
}

function changeAdminPin() {
  const current = prompt('PIN actual:');
  if (current === null) return;
  const saved = localStorage.getItem(PIN_KEY) || '1213';
  if (current !== saved) { toast('❌ PIN actual incorrecto'); return; }
  const newPin = prompt('Nuevo PIN (mínimo 4 dígitos):');
  if (!newPin || newPin.length < 4) { toast('PIN inválido'); return; }
  localStorage.setItem(PIN_KEY, newPin);
  toast('✓ PIN actualizado');
}

async function loadDataFromSupabase() {
  try {
    const uid = currentUser.id;
    const [{ data: cats }, { data: prods }, { data: ventas }] = await Promise.all([
      _sb.from('categorias').select('*').eq('user_id', uid).order('created_at'),
      _sb.from('productos').select('*').eq('user_id', uid).order('created_at'),
      _sb.from('ventas').select('*').eq('user_id', uid).order('created_at'),
    ]);
    CATS = (cats && cats.length)
      ? cats.map(c => ({ id: c.id, label: c.nombre, icon: c.icon || '🏷️' }))
      : JSON.parse(JSON.stringify(DEFAULT_CATS));
    DB.saveCats(CATS);
    APP.products = (prods && prods.length)
      ? prods.map(p => ({ id: p.id, name: p.nombre, price: p.precio, cost: p.costo || 0, emoji: p.emoji || '📦', cat: p.categoria, stock: p.stock || 0, discount: p.descuento || 0 }))
      : [];
    DB.saveProducts(APP.products);
    if (ventas && ventas.length) {
      DB.saveSales(ventas.map(v => ({
        id: v.id, order: v.orden || genOrder(),
        date: v.created_at.split('T')[0],
        timestamp: new Date(v.created_at).getTime(),
        time: new Date(v.created_at).toLocaleTimeString('es-CO', { hour:'2-digit', minute:'2-digit' }),
        items: v.items, subtotal: v.subtotal, iva: v.iva, total: v.total,
        method: v.metodo, received: v.total, change: 0,
      })));
    }
  } catch (e) {
    console.error('Error cargando datos:', e);
    CATS = DB.getCats();
    APP.products = DB.getProducts();
    toast('⚠️ Sin conexión, usando datos locales');
  }
}

async function signOut() {
  await _sb.auth.signOut();
  currentUser = null;
  location.reload();
}

/* ═══ INIT ═══ */
tick();
setInterval(tick, 1000);
(async () => {
  const { data: { session } } = await _sb.auth.getSession();
  if (session && session.user) {
    await onAuthSuccess(session.user);
  } else {
    document.getElementById('authOverlay').style.display = 'flex';
  }
})();
</script>
</body>
</html>
